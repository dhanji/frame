<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frame Email Client</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f0f2f5;
            color: #1c1e21;
        }

        /* Login Screen Styles */
        .login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .login-container {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 400px;
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-header h1 {
            color: #1877f2;
            font-size: 32px;
            margin-bottom: 8px;
        }

        .login-header p {
            color: #65676b;
            font-size: 16px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #1c1e21;
        }

        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #dadde1;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #1877f2;
        }

        .login-btn {
            width: 100%;
            padding: 12px;
            background: #1877f2;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .login-btn:hover {
            background: #166fe5;
        }

        .login-btn:disabled {
            background: #dadde1;
            cursor: not-allowed;
        }

        .demo-notice {
            background: #fff3cd;
            color: #856404;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #ffc107;
            font-size: 14px;
        }

        .error-message, .success-message {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid;
            display: none;
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            border-color: #c62828;
        }

        .success-message {
            background: #e8f5e8;
            color: #2e7d32;
            border-color: #2e7d32;
        }

        /* Main App Styles */
        .main-app {
            display: none;
        }

        .main-app.active {
            display: block;
        }

        .header {
            background: white;
            border-bottom: 1px solid #dadde1;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: #1877f2;
        }

        .search-bar {
            flex: 1;
            max-width: 400px;
            margin: 0 20px;
        }

        .search-bar input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #dadde1;
            border-radius: 20px;
            background: #f0f2f5;
            outline: none;
        }

        .compose-btn {
            background: #1877f2;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }

        .compose-btn:hover {
            background: #166fe5;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .logout-btn {
            background: #e4e6ea;
            color: #1c1e21;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }

        .container {
            display: flex;
            max-width: 1200px;
            margin: 20px auto;
            gap: 20px;
            padding: 0 20px;
        }

        .sidebar {
            width: 240px;
            background: white;
            border-radius: 8px;
            padding: 12px;
            height: fit-content;
            position: sticky;
            top: 80px;
        }

        .folder-item {
            padding: 10px 12px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .folder-item:hover {
            background: #f0f2f5;
        }

        .folder-item.active {
            background: #e7f3ff;
            color: #1877f2;
            font-weight: 500;
        }

        .unread-count {
            background: #1877f2;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
        }

        .main-content {
            flex: 1;
        }

        .conversation {
            background: white;
            border-radius: 8px;
            margin-bottom: 4px;
            padding: 12px 16px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: box-shadow 0.2s;
        }

        .conversation:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .conversation-line {
            display: flex;
            gap: 12px;
            justify-content: space-between;
            align-items: flex-start;
        }

        .timestamp {
            color: #65676b;
            font-size: 13px;
            white-space: nowrap;
        }

        .conversation-info {
            flex: 1;
            min-width: 0;
        }

        .subject-line {
            font-size: 14px;
            font-weight: 600;
            color: #050505;
            margin-bottom: 4px;
        }

        .content-snippet {
            color: #65676b;
            font-size: 13px;
            line-height: 1.4;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .conversation-actions-hover {
            display: none;
            gap: 8px;
            margin-left: 12px;
        }

        .conversation:hover .conversation-actions-hover {
            display: flex;
        }

        .icon-btn {
            background: #f0f2f5;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: background 0.2s;
        }

        .icon-btn:hover {
            background: #e4e6eb;
        }

        /* Slideover Panel */
        .slideover-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            display: none;
        }

        .slideover-overlay.active {
            display: block;
        }

        .slideover-panel {
            position: fixed;
            top: 0;
            right: -600px;
            width: 600px;
            height: 100%;
            background: white;
            box-shadow: -2px 0 8px rgba(0,0,0,0.15);
            transition: right 0.3s ease;
            z-index: 1001;
            display: flex;
            flex-direction: column;
        }

        .slideover-overlay.active .slideover-panel {
            right: 0;
        }

        .slideover-header {
            padding: 20px;
            border-bottom: 1px solid #e4e6eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .slideover-header h2 {
            font-size: 18px;
            color: #1c1e21;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #65676b;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            background: #f0f2f5;
        }

        .slideover-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .chat-message {
            margin-bottom: 20px;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .message-sender {
            font-weight: 600;
            color: #050505;
        }

        .message-time {
            color: #65676b;
            font-size: 13px;
        }

        .message-body {
            background: #f0f2f5;
            padding: 12px 16px;
            border-radius: 12px;
            line-height: 1.5;
            color: #1c1e21;
        }

        .slideover-footer {
            padding: 20px;
            border-top: 1px solid #e4e6eb;
        }

        .reply-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .reply-box {
            display: flex;
            gap: 8px;
        }

        .reply-box textarea {
            flex: 1;
            padding: 12px;
            border: 1px solid #dadde1;
            border-radius: 20px;
            resize: none;
            font-family: inherit;
            font-size: 14px;
            min-height: 44px;
            max-height: 120px;
        }

        .reply-box textarea:focus {
            outline: none;
            border-color: #1877f2;
        }

        .send-btn {
            background: #1877f2;
            color: white;
            border: none;
            padding: 0 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 500;
        }

        .send-btn:hover {
            background: #166fe5;
        }

        .unread {
            border-left: 3px solid #1877f2;
        }

        .loading, .empty-state {
            text-align: center;
            padding: 40px;
            color: #65676b;
        }

        .empty-state h3 {
            margin-bottom: 8px;
            color: #1c1e21;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10000;
            animation: slideIn 0.3s ease;
        }

        .notification.success {
            background: #28a745;
            color: white;
        }

        .notification.error {
            background: #dc3545;
            color: white;
        }

        .notification.info {
            background: #007bff;
            color: white;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .compose-modal {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .compose-modal h2 {
            margin-bottom: 20px;
            color: #1c1e21;
        }

        .compose-modal .form-group {
            margin-bottom: 15px;
        }

        .compose-modal textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #dadde1;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            min-height: 150px;
        }

        .compose-modal textarea:focus {
            outline: none;
            border-color: #1877f2;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .btn-secondary {
            padding: 10px 20px;
            border: 1px solid #dadde1;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }

        .btn-secondary:hover {
            background: #f0f2f5;
        }

        .btn-primary {
            padding: 10px 20px;
            background: #1877f2;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }

        .btn-primary:hover {
            background: #166fe5;
        }

        .btn-primary:disabled {
            background: #dadde1;
            cursor: not-allowed;
        }

        /* Attachment Gallery Styles */
        .gallery-container {
            display: none;
        }

        .gallery-container.active {
            display: block;
        }

        .gallery-header {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .gallery-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #1c1e21;
        }

        .gallery-controls {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
        }

        .view-mode-switcher {
            display: flex;
            gap: 4px;
            background: #f0f2f5;
            padding: 4px;
            border-radius: 8px;
        }

        .view-mode-btn {
            padding: 8px 16px;
            border: none;
            background: transparent;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            color: #65676b;
            transition: all 0.2s;
        }

        .view-mode-btn.active {
            background: white;
            color: #1877f2;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .view-mode-btn:hover:not(.active) {
            color: #1c1e21;
        }

        .gallery-search {
            flex: 1;
            min-width: 200px;
        }

        .gallery-search input {
            width: 100%;
            padding: 10px 16px;
            border: 1px solid #dadde1;
            border-radius: 8px;
            font-size: 14px;
        }

        .gallery-search input:focus {
            outline: none;
            border-color: #1877f2;
        }

        .filter-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .filter-select {
            padding: 8px 12px;
            border: 1px solid #dadde1;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 14px;
        }

        .filter-select:focus {
            outline: none;
            border-color: #1877f2;
        }

        /* Grid View */
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
        }

        .attachment-card {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .attachment-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }

        .attachment-thumbnail {
            width: 100%;
            height: 150px;
            background: #f0f2f5;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            position: relative;
            overflow: hidden;
        }

        .attachment-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .attachment-info {
            padding: 12px;
        }

        .attachment-filename {
            font-weight: 500;
            font-size: 14px;
            color: #1c1e21;
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .attachment-meta {
            font-size: 12px;
            color: #65676b;
            display: flex;
            justify-content: space-between;
        }

        /* Sender View */
        .sender-list {
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        .sender-group {
            border-bottom: 1px solid #e4e6eb;
        }

        .sender-group:last-child {
            border-bottom: none;
        }

        .sender-header {
            padding: 16px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            transition: background 0.2s;
        }

        .sender-header:hover {
            background: #f0f2f5;
        }

        .sender-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .sender-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #1877f2;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .sender-details h3 {
            font-size: 15px;
            font-weight: 600;
            color: #1c1e21;
            margin-bottom: 2px;
        }

        .sender-details p {
            font-size: 13px;
            color: #65676b;
        }

        .sender-count {
            background: #e7f3ff;
            color: #1877f2;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
        }

        .sender-attachments {
            padding: 16px;
            background: #f8f9fa;
            display: none;
        }

        .sender-group.expanded .sender-attachments {
            display: block;
        }

        .sender-group.expanded .sender-header::after {
            content: '▼';
        }

        .sender-header::after {
            content: '▶';
            color: #65676b;
            font-size: 12px;
        }

        .attachment-list-item {
            padding: 12px;
            background: white;
            border-radius: 6px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .attachment-list-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .attachment-icon {
            width: 48px;
            height: 48px;
            border-radius: 6px;
            background: #f0f2f5;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            flex-shrink: 0;
        }

        .attachment-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 6px;
        }

        .attachment-details {
            flex: 1;
            min-width: 0;
        }

        .attachment-details h4 {
            font-size: 14px;
            font-weight: 500;
            color: #1c1e21;
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .attachment-details p {
            font-size: 12px;
            color: #65676b;
        }

        /* Preview Modal */
        .preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .preview-modal.active {
            display: flex;
        }

        .preview-content {
            max-width: 90%;
            max-height: 90%;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .preview-header {
            padding: 16px 20px;
            border-bottom: 1px solid #e4e6eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .preview-header h3 {
            font-size: 16px;
            font-weight: 600;
            color: #1c1e21;
        }

        .preview-actions {
            display: flex;
            gap: 8px;
        }

        .preview-body {
            flex: 1;
            overflow: auto;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: #f8f9fa;
        }

        .preview-body img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .preview-metadata {
            padding: 16px 20px;
            border-top: 1px solid #e4e6eb;
            background: white;
        }

        .metadata-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 14px;
        }

        .metadata-label {
            color: #65676b;
            font-weight: 500;
        }

        .metadata-value {
            color: #1c1e21;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            margin-top: 20px;
        }

        .pagination button {
            padding: 8px 16px;
            border: 1px solid #dadde1;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }

        .pagination button:hover:not(:disabled) {
            background: #f0f2f5;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination span {
            color: #65676b;
            font-size: 14px;
        }

        /* Filter Buttons */
        .filter-btn {
            padding: 8px 16px;
            border: 1px solid #dadde1;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .filter-btn:hover {
            background: #f0f2f5;
        }

        .filter-btn.active {
            background: #1877f2;
            color: white;
            border-color: #1877f2;
        }

        /* Notifications */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-width: 400px;
        }

        .notification {
            background: white;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: start;
            gap: 12px;
            animation: slideIn 0.3s ease-out;
            border-left: 4px solid;
        }

        .notification.success {
            border-color: #4caf50;
        }

        .notification.error {
            border-color: #f44336;
        }

        .notification.info {
            border-color: #2196f3;
        }

        .notification.warning {
            border-color: #ff9800;
        }

        .notification-content {
            flex: 1;
            font-size: 14px;
        }

        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- Notification Container -->
    <div class="notification-container" id="notificationContainer"></div>

    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-container">
            <div class="login-header">
                <h1>📧 Frame</h1>
                <p>Modern Email Client</p>
            </div>
            
            <div class="demo-notice">
                <strong>Demo Mode:</strong> You can use any username/password to login and explore the features.
            </div>
            
            <div id="loginError" class="error-message"></div>
            <div id="loginSuccess" class="success-message"></div>
            
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Username or Email</label>
                    <input type="text" id="username" name="username" required>
                </div>
                
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password" required>
                </div>
                
                <button type="submit" class="login-btn" id="loginBtn">Sign In</button>
            </form>
        </div>
    </div>

    <!-- Main App -->
    <div class="main-app" id="mainApp">
        <div class="header">
            <div class="logo">📧 Frame</div>
            <div class="search-bar">
                <input type="text" placeholder="Search emails..." id="searchInput">
            </div>
            <div class="header-actions">
                <button class="compose-btn" id="gooseBtn" style="background: #10a37f;">🤖 Goose</button>
                <button class="compose-btn" id="composeBtn">Compose</button>
                <button class="logout-btn" id="logoutBtn">Logout</button>
            </div>
        </div>

        <div class="container">
            <div class="sidebar" id="sidebar">
                <div class="loading">Loading folders...</div>
                <!-- Attachments tab will be added here -->
            </div>

            <div class="main-content" id="conversationList">
                <div class="loading">Loading conversations...</div>
            </div>
        </div>
    </div>


    <!-- Slideover Panel -->
    <div class="slideover-overlay" id="slideoverOverlay">
        <div class="slideover-panel">
            <div class="slideover-header">
                <h2 id="slideoverSubject">Conversation</h2>
                <button class="close-btn" onclick="closeSlideover()">×</button>
            </div>
            <div class="slideover-content" id="slideoverContent">
                <!-- Messages will be loaded here -->
            </div>
            <div class="slideover-footer">
                <div class="reply-actions">
                    <button class="btn-secondary" onclick="replyTo()">Reply</button>
                    <button class="btn-secondary" onclick="replyAll()">Reply All</button>
                    <button class="btn-secondary" onclick="forward()">Forward</button>
                </div>
                <div class="reply-box">
                    <textarea id="quickReplyText" placeholder="Write a reply..."></textarea>
                    <button class="send-btn" onclick="sendQuickReply()">Send</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Attachment Gallery -->
    <div class="container gallery-container" id="galleryContainer">
        <div class="main-content">
            <div class="gallery-header">
                <h1 class="gallery-title">📎 Attachments</h1>
                <div class="gallery-controls">
                    <div class="view-mode-switcher">
                        <button class="view-mode-btn active" data-mode="recents" onclick="switchGalleryView('recents')">Recents</button>
                        <button class="view-mode-btn" data-mode="sender" onclick="switchGalleryView('sender')">By Sender</button>
                        <button class="view-mode-btn" data-mode="list" onclick="switchGalleryView('list')">List</button>
                    </div>
                    <div class="gallery-search">
                        <input type="text" id="gallerySearchInput" placeholder="Search attachments..." oninput="searchAttachments()">
                    </div>
                    <div class="filter-group">
                        <select class="filter-select" id="filterDate" onchange="applyFilters()">
                            <option value="">All Time</option>
                            <option value="today">Today</option>
                            <option value="week">Last 7 Days</option>
                            <option value="month">Last 30 Days</option>
                        </select>
                        <select class="filter-select" id="filterType" onchange="applyFilters()">
                            <option value="">All Types</option>
                            <option value="image">Images</option>
                            <option value="pdf">PDFs</option>
                            <option value="document">Documents</option>
                            <option value="spreadsheet">Spreadsheets</option>
                            <option value="archive">Archives</option>
                        </select>
                        <select class="filter-select" id="filterSize" onchange="applyFilters()">
                            <option value="">All Sizes</option>
                            <option value="small">Small (&lt;1MB)</option>
                            <option value="medium">Medium (1-10MB)</option>
                            <option value="large">Large (&gt;10MB)</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Recents View -->
            <div id="recentsView" class="gallery-grid">
                <div class="loading">Loading attachments...</div>
            </div>

            <!-- Sender View -->
            <div id="senderView" class="sender-list" style="display: none;">
                <div class="loading">Loading attachments...</div>
            </div>

            <!-- List View -->
            <div id="listView" style="display: none;">
                <div class="loading">Loading attachments...</div>
            </div>

            <!-- Pagination -->
            <div class="pagination" id="galleryPagination" style="display: none;">
                <button onclick="previousPage()">Previous</button>
                <span id="pageInfo">Page 1</span>
                <button onclick="nextPage()">Next</button>
            </div>
        </div>
    </div>

    <!-- Preview Modal -->
    <div class="preview-modal" id="previewModal">
        <div class="preview-content" style="width: 800px; max-height: 90vh;">
            <!-- Preview content will be dynamically loaded -->
        </div>
    </div>

    <script>
        // Global state
        let authToken = null;
        let currentFolder = 'inbox';
        let conversations = [];
        let folders = [];
        let currentConversation = null;

        // Gallery state
        let currentView = 'recents';
        let attachments = [];
        let filteredAttachments = [];
        let currentPage = 1;
        let pageSize = 20;

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
        });

        function initializeApp() {
            authToken = localStorage.getItem('auth_token');
            if (authToken) {
                showMainApp();
                loadFolders();
                loadConversations();
            } else {
                showLoginScreen();
            }
            
            setupEventListeners();
        }

        function showLoginScreen() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainApp').classList.remove('active');
        }

        function showMainApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').classList.add('active');
        }

        function setupEventListeners() {
            document.getElementById('loginForm')?.addEventListener('submit', handleLogin);
            document.getElementById('composeBtn')?.addEventListener('click', openComposeModal);
            document.getElementById('gooseBtn')?.addEventListener('click', openGooseChat);
            document.getElementById('logoutBtn')?.addEventListener('click', handleLogout);
            document.getElementById('searchInput')?.addEventListener('input', debounce(handleSearch, 500));
        }

        async function handleLogin(e) {
            e.preventDefault();
            
            const loginBtn = document.getElementById('loginBtn');
            const errorDiv = document.getElementById('loginError');
            const successDiv = document.getElementById('loginSuccess');
            
            loginBtn.disabled = true;
            loginBtn.textContent = 'Signing in...';
            errorDiv.style.display = 'none';
            successDiv.style.display = 'none';
            
            const formData = new FormData(e.target);
            const username = formData.get('username');
            const password = formData.get('password');
            
            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    authToken = data.token || 'demo-token';
                    localStorage.setItem('auth_token', authToken);
                    localStorage.setItem('user', JSON.stringify(data.user || { username, email: username }));
                    
                    successDiv.textContent = 'Login successful!';
                    successDiv.style.display = 'block';
                    
                    setTimeout(() => {
                        showMainApp();
                        loadFolders();
                        loadConversations();
                    }, 1000);
                } else {
                    throw new Error('Login failed');
                }
            } catch (error) {
                // Demo mode fallback
                console.log('Using demo mode');
                authToken = 'demo-token';
                localStorage.setItem('auth_token', authToken);
                localStorage.setItem('user', JSON.stringify({ username, email: username }));
                
                successDiv.textContent = 'Demo login successful!';
                successDiv.style.display = 'block';
                
                setTimeout(() => {
                    showMainApp();
                    loadFolders();
                    loadConversations();
                }, 1000);
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'Sign In';
            }
        }

        function handleLogout() {
            localStorage.removeItem('auth_token');
            localStorage.removeItem('user');
            authToken = null;
            showLoginScreen();
        }

        async function loadFolders() {
            try {
                const response = await fetch('/api/folders', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    folders = await response.json();
                } else {
                    folders = getMockFolders();
                }
            } catch (error) {
                folders = getMockFolders();
            }
            
            renderFolders();
        }

        function renderFolders() {
            const sidebar = document.getElementById('sidebar');
            sidebar.innerHTML = '';
            
            
            folders.forEach(folder => {
                const folderItem = document.createElement('div');
                folderItem.className = 'folder-item' + (folder.id === currentFolder ? ' active' : '');
                folderItem.innerHTML = `
                    <span>${folder.name}</span>
                    ${folder.unread_count > 0 ? `<span class="unread-count">${folder.unread_count}</span>` : ''}
                `;
                folderItem.addEventListener('click', () => selectFolder(folder.id));
                sidebar.appendChild(folderItem);
            });

            // Add Attachments tab
            const attachmentsTab = document.createElement('div');
            attachmentsTab.className = 'folder-item';
            attachmentsTab.innerHTML = `
                <span>📎 Attachments</span>
            `;
            attachmentsTab.addEventListener('click', () => showAttachmentGallery());
            sidebar.appendChild(attachmentsTab);

            // Add separator
            const separator = document.createElement('div');
            separator.style.borderTop = '1px solid #e4e6eb';
            separator.style.margin = '8px 0';
            sidebar.appendChild(separator);

            // Add Chat/Goose tab
            const chatTab = document.createElement('div');
            chatTab.className = 'folder-item';
            chatTab.innerHTML = `<span>🤖 Goose Chat</span>`;
            chatTab.addEventListener('click', () => showChatView());
            sidebar.appendChild(chatTab);

            // Add Automations tab
            const automationsTab = document.createElement('div');
            automationsTab.className = 'folder-item';
            automationsTab.innerHTML = `<span>⚙️ Automations</span>`;
            automationsTab.addEventListener('click', () => showAutomationsView());
            sidebar.appendChild(automationsTab);

            // Add Reminders tab
            const remindersTab = document.createElement('div');
            remindersTab.className = 'folder-item';
            remindersTab.innerHTML = `<span>✓ Reminders</span>`;
            remindersTab.addEventListener('click', () => showRemindersView());
            sidebar.appendChild(remindersTab);

            // Add Calendar tab
            const calendarTab = document.createElement('div');
            calendarTab.className = 'folder-item';
            calendarTab.innerHTML = `<span>📅 Calendar</span>`;
            calendarTab.addEventListener('click', () => showCalendarView());
            sidebar.appendChild(calendarTab);

            // Add Money tab
            const moneyTab = document.createElement('div');
            moneyTab.className = 'folder-item';
            moneyTab.innerHTML = `<span>💰 Money</span>`;
            moneyTab.addEventListener('click', () => showMoneyView());
            sidebar.appendChild(moneyTab);

            // Add Settings tab
            const settingsTab = document.createElement('div');
            settingsTab.className = 'folder-item';
            settingsTab.innerHTML = `<span>⚙️ Settings</span>`;
            settingsTab.addEventListener('click', () => showSettingsView());
            sidebar.appendChild(settingsTab);
        }

        function selectFolder(folderId) {
            currentFolder = folderId;
            
            // Hide gallery and show conversation list
            hideAttachmentGallery();
            
            // Update active state
            document.querySelectorAll('.folder-item').forEach(f => f.classList.remove('active'));
            event.target.closest('.folder-item').classList.add('active');
            loadConversations();
        }

        async function loadConversations() {
            const container = document.getElementById('conversationList');
            container.innerHTML = '<div class="loading">Loading conversations...</div>';
            
            try {
                const response = await fetch(`/api/conversations?folder=${currentFolder}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    conversations = await response.json();
                } else {
                    conversations = getMockConversations();
                }
            } catch (error) {
                conversations = getMockConversations();
            }
            
            renderConversations();
        }

        function renderConversations() {
            const container = document.getElementById('conversationList');
            
            if (conversations.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>No conversations found</h3></div>';
                return;
            }
            
            container.innerHTML = '';
            conversations.forEach(conv => {
                const convEl = createConversationElement(conv);
                container.appendChild(convEl);
            });
        }

        function createConversationElement(conv) {
            const div = document.createElement('div');
            div.className = `conversation ${conv.unread_count > 0 ? 'unread' : ''}`;
            
            // Add special styling for chat and automation conversations
            if (conv.conversation_type === 'chat') {
                div.style.borderLeft = '4px solid #10a37f';
            } else if (conv.conversation_type === 'automation') {
                div.style.borderLeft = '4px solid #ff9800';
            }
            
            div.innerHTML = `
                <div class="conversation-line">
                    <div class="conversation-info">
                        ${conv.icon ? `<span style="font-size: 20px; margin-right: 8px;">${conv.icon}</span>` : ''}
                        <div class="subject-line">${escapeHtml(conv.subject)}</div>
                        <div class="content-snippet">${escapeHtml(conv.preview)}</div>
                    </div>
                    <div class="conversation-actions-hover">
                        <button class="icon-btn" onclick="event.stopPropagation(); replyAllDirect('${conv.id}')" title="Reply All">↩️</button>
                        <button class="icon-btn" onclick="event.stopPropagation(); toggleStar('${conv.id}')" title="Star">⭐</button>
                        <button class="icon-btn" onclick="event.stopPropagation(); moveConversation('${conv.id}')" title="Move">📁</button>
                        <button class="icon-btn" onclick="event.stopPropagation(); deleteConv('${conv.id}')" title="Delete">🗑️</button>
                    </div>
                    <div class="timestamp">${formatDate(conv.last_message_date)}</div>
                </div>
            `;
            
            // Add context menu
            div.addEventListener('contextmenu', (e) => showContextMenu(e, conv));
            div.addEventListener('click', () => {
                if (conv.conversation_type === 'chat' || conv.conversation_type === 'automation') {
                    showChatView(conv.id);
                } else {
                    openSlideover(conv);
                }
            });
            
            return div;
        }

        function showContextMenu(e, conv) {
            e.preventDefault();
            
            // Remove any existing context menu
            const existing = document.querySelector('.context-menu');
            if (existing) existing.remove();
            
            const menu = document.createElement('div');
            menu.className = 'context-menu';
            menu.style.cssText = `
                position: fixed;
                left: ${e.clientX}px;
                top: ${e.clientY}px;
                background: white;
                border: 1px solid #dadde1;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                min-width: 200px;
            `;
            
            const menuItems = [
                { label: '🤖 Ask Goose about this', action: () => askGooseAboutEmail(conv) },
                { label: '↩️ Reply', action: () => replyAllDirect(conv.id) },
                { label: '⭐ Star', action: () => toggleStar(conv.id) },
                { label: '📁 Move', action: () => moveConversation(conv.id) },
                { label: '🗑️ Delete', action: () => deleteConv(conv.id) },
            ];
            
            menuItems.forEach(item => {
                const menuItem = document.createElement('div');
                menuItem.textContent = item.label;
                menuItem.style.cssText = 'padding: 12px 16px; cursor: pointer; transition: background 0.2s;';
                menuItem.onmouseover = () => menuItem.style.background = '#f0f2f5';
                menuItem.onmouseout = () => menuItem.style.background = 'white';
                menuItem.onclick = () => {
                    item.action();
                    menu.remove();
                };
                menu.appendChild(menuItem);
            });
            
            document.body.appendChild(menu);
            
            // Close menu on click outside
            setTimeout(() => {
                document.addEventListener('click', () => menu.remove(), { once: true });
            }, 0);
        }

        async function askGooseAboutEmail(conv) {
            // Create a new chat with context about the email
            const response = await fetch('/api/chat/conversations', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${authToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ title: `Chat about: ${conv.subject}` })
            });
            const data = await response.json();
            if (data.id) {
                // Send initial message with email context
                await fetch(`/api/chat/conversations/${data.id}/messages`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        content: `I need help with this email:\n\nSubject: ${conv.subject}\n\nCan you help me understand it and suggest a response?`
                    })
                });
                showChatView(data.id);
            }
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const diffHours = Math.floor((now - date) / (1000 * 60 * 60));
            
            if (diffHours < 1) return 'Just now';
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffHours < 48) return 'Yesterday';
            return date.toLocaleDateString();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Notification System
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notificationContainer');
            if (!container) return;
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            const icons = {
                success: '✓',
                error: '✗',
                info: 'ℹ',
                warning: '⚠'
            };
            
            notification.innerHTML = `
                <div style="font-size: 20px;">${icons[type] || icons.info}</div>
                <div class="notification-content">${escapeHtml(message)}</div>
                <button onclick="this.parentElement.remove()" style="background: none; border: none; cursor: pointer; font-size: 18px; color: #65676b;">×</button>
            `;
            
            container.appendChild(notification);
            
            // Auto-dismiss after 3 seconds
            setTimeout(() => {
                notification.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 300);
            }, 3000);
        }

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        function handleSearch(e) {
            const query = e.target.value.toLowerCase();
            if (!query) {
                renderConversations();
                return;
            }
            
            const filtered = conversations.filter(conv => 
                conv.subject.toLowerCase().includes(query) ||
                conv.preview.toLowerCase().includes(query) ||
                conv.participants.some(p => p.toLowerCase().includes(query))
            );
            
            const container = document.getElementById('conversationList');
            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>No results found</h3></div>';
                return;
            }
            
            container.innerHTML = '';
            filtered.forEach(conv => {
                const convEl = createConversationElement(conv);
                container.appendChild(convEl);
            });
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.remove(), 3000);
        }

        // Action functions - NOW FULLY IMPLEMENTED
        async function openGooseChat() {
            // Create a new chat conversation and navigate to it
            const response = await fetch('/api/chat/conversations', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${authToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ title: 'New Chat' })
            });
            const data = await response.json();
            if (data.id) {
                showChatView(data.id);
            }
        }

        function openComposeModal(options = {}) {
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            
            const modal = document.createElement('div');
            modal.className = 'compose-modal';
            modal.innerHTML = `
                <h2>Compose Email</h2>
                <form id="composeForm">
                    <div class="form-group">
                        <label>To:</label>
                        <input type="text" name="to" value="${options.to || ''}" required>
                    </div>
                    <div class="form-group">
                        <label>Subject:</label>
                        <input type="text" name="subject" value="${options.subject || ''}" required>
                    </div>
                    <div class="form-group">
                        <label>Message:</label>
                        <textarea name="body" required>${options.body || ''}</textarea>
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn-secondary" onclick="closeComposeModal()">Cancel</button>
                        <button type="submit" class="btn-primary">Send</button>
                    </div>
                </form>
            `;
            
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
            
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) closeComposeModal();
            });
            
            document.getElementById('composeForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                
                try {
                    await fetch('/api/emails/send', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            to: formData.get('to').split(',').map(e => e.trim()),
                            subject: formData.get('subject'),
                            body_text: formData.get('body')
                        })
                    });
                    
                    showNotification('Email sent successfully!', 'success');
                    closeComposeModal();
                    loadConversations();
                } catch (error) {
                    console.log('Send email (demo mode):', formData.get('to'));
                    showNotification('Email sent (demo mode)!', 'success');
                    closeComposeModal();
                }
            });
        }

        function closeComposeModal() {
            document.querySelector('.modal-overlay')?.remove();
        }

        // Slideover functions
        function openSlideover(conv) {
            currentConversation = conv;
            const overlay = document.getElementById('slideoverOverlay');
            const subject = document.getElementById('slideoverSubject');
            const content = document.getElementById('slideoverContent');
            
            subject.textContent = conv.subject;
            
            // Load conversation messages
            loadConversationMessages(conv.id);
            
            overlay.classList.add('active');
        }

        function closeSlideover() {
            const overlay = document.getElementById('slideoverOverlay');
            overlay.classList.remove('active');
            currentConversation = null;
        }

        async function loadConversationMessages(convId) {
            const content = document.getElementById('slideoverContent');
            content.innerHTML = '<div class="loading">Loading messages...</div>';
            
            try {
                const response = await fetch(`/api/conversations/${convId}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const messages = await response.json();
                    renderChatMessages(messages);
                } else {
                    renderChatMessages(getMockMessages(convId));
                }
            } catch (error) {
                renderChatMessages(getMockMessages(convId));
            }
        }

        function renderChatMessages(messages) {
            const content = document.getElementById('slideoverContent');
            
            if (!messages || messages.length === 0) {
                content.innerHTML = '<div class="empty-state"><h3>No messages found</h3></div>';
                return;
            }
            
            content.innerHTML = '';
            messages.forEach(msg => {
                const msgEl = document.createElement('div');
                msgEl.className = 'chat-message';
                msgEl.innerHTML = `
                    <div class="message-header">
                        <div class="message-sender">${escapeHtml(msg.from || msg.sender)}</div>
                        <div class="message-time">${formatDate(msg.date || msg.timestamp)}</div>
                    </div>
                    <div class="message-body">${escapeHtml(msg.body || msg.text)}</div>
                `;
                content.appendChild(msgEl);
            });
        }

        async function sendQuickReply() {
            const textarea = document.getElementById('quickReplyText');
            const text = textarea.value.trim();
            
            if (!text || !currentConversation) return;
            
            try {
                await fetch('/api/emails/send', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        to: currentConversation.participants,
                        subject: 'Re: ' + currentConversation.subject,
                        body_text: text
                    })
                });
                
                textarea.value = '';
                showNotification('Reply sent!', 'success');
                loadConversationMessages(currentConversation.id);
            } catch (error) {
                console.log('Quick reply (demo mode):', text);
                textarea.value = '';
                showNotification('Reply sent (demo mode)!', 'success');
                
                // Add message to chat in demo mode
                const content = document.getElementById('slideoverContent');
                const msgEl = document.createElement('div');
                msgEl.className = 'chat-message';
                msgEl.innerHTML = `
                    <div class="message-header">
                        <div class="message-sender">You</div>
                        <div class="message-time">Just now</div>
                    </div>
                    <div class="message-body">${escapeHtml(text)}</div>
                `;
                content.appendChild(msgEl);
            }
        }

        function replyTo() {
            if (!currentConversation) return;
            closeSlideover();
            openComposeModal({
                to: currentConversation.participants[0],
                subject: 'Re: ' + currentConversation.subject
            });
        }

        function replyAll() {
            if (!currentConversation) return;
            closeSlideover();
            openComposeModal({
                to: currentConversation.participants.join(', '),
                subject: 'Re: ' + currentConversation.subject
            });
        }

        function forward() {
            if (!currentConversation) return;
            closeSlideover();
            openComposeModal({
                subject: 'Fwd: ' + currentConversation.subject,
                body: `\n\n---------- Forwarded message ---------\nSubject: ${currentConversation.subject}\n\n${currentConversation.preview}`
            });
        }

        // Hover action functions
        function replyAllDirect(convId) {
            const conv = conversations.find(c => c.id === convId);
            if (!conv) return;
            
            openComposeModal({
                to: conv.participants.join(', '),
                subject: 'Re: ' + conv.subject
            });
        }

        function toggleStar(convId) {
            console.log('Toggle star:', convId);
            showNotification('Star toggled!', 'success');
            // In real implementation, update the conversation's starred status
        }

        function moveConversation(convId) {
            const folders = ['inbox', 'sent', 'drafts', 'starred', 'trash'];
            const folderName = prompt('Move to folder:\n' + folders.join('\n'));
            
            if (folderName && folders.includes(folderName.toLowerCase())) {
                console.log('Move conversation', convId, 'to', folderName);
                showNotification(`Moved to ${folderName}`, 'success');
                // In real implementation, call API to move conversation
            }
        }

        async function deleteConv(convId) {
            if (!confirm('Move this conversation to trash?')) return;
            
            try {
                await fetch(`/api/emails/${convId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                showNotification('Conversation moved to trash', 'success');
                loadConversations();
            } catch (error) {
                console.log('Delete conversation (demo mode):', convId);
                showNotification('Conversation moved to trash (demo mode)', 'success');
                conversations = conversations.filter(c => c.id !== convId);
                renderConversations();
            }
        }

        // Close slideover when clicking overlay
        document.getElementById('slideoverOverlay')?.addEventListener('click', (e) => {
            if (e.target.id === 'slideoverOverlay') {
                closeSlideover();
            }
        });

        // Mock data
        function getMockFolders() {
            return [
                { id: 'inbox', name: 'Inbox', unread_count: 2 },
                { id: 'sent', name: 'Sent', unread_count: 0 },
                { id: 'drafts', name: 'Drafts', unread_count: 0 },
                { id: 'starred', name: 'Starred', unread_count: 0 },
                { id: 'trash', name: 'Trash', unread_count: 0 }
            ];
        }

        function getMockConversations() {
            return [
                {
                    id: '1',
                    subject: 'Welcome to Frame Email Client',
                    participants: ['Frame Support'],
                    last_message_date: new Date().toISOString(),
                    unread_count: 1,
                    message_count: 1,
                    preview: 'Thank you for trying Frame Email Client! This is a demo conversation to show how the interface works. Click Reply to compose a response, or use Reply All to include all participants.'
                },
                {
                    id: '2',
                    subject: 'Getting Started Guide',
                    participants: ['Frame Team'],
                    last_message_date: new Date(Date.now() - 3600000).toISOString(),
                    unread_count: 0,
                    message_count: 1,
                    preview: 'Here are some tips to get you started: 1. Use keyboard shortcuts for faster navigation 2. Try the search feature 3. Organize emails with folders 4. Use quick reply for fast responses'
                },
                {
                    id: '3',
                    subject: 'Project Update - Q4 2024',
                    participants: ['John Doe', 'Jane Smith'],
                    last_message_date: new Date(Date.now() - 7200000).toISOString(),
                    unread_count: 0,
                    message_count: 3,
                    preview: 'The Q4 project is progressing well. We have completed 75% of the planned features and are on track for the December release.'
                }
            ];
        }

        function getMockMessages(convId) {
            const conv = conversations.find(c => c.id === convId);
            if (!conv) return [];
            
            // Generate mock messages based on conversation
            if (convId === '1') {
                return [
                    {
                        from: 'Frame Support',
                        date: new Date().toISOString(),
                        body: 'Thank you for trying Frame Email Client! This is a demo conversation to show how the interface works. Click Reply to compose a response, or use Reply All to include all participants.'
                    }
                ];
            } else if (convId === '2') {
                return [
                    {
                        from: 'Frame Team',
                        date: new Date(Date.now() - 3600000).toISOString(),
                        body: 'Here are some tips to get you started:\n\n1. Use keyboard shortcuts for faster navigation\n2. Try the search feature\n3. Organize emails with folders\n4. Use quick reply for fast responses'
                    }
                ];
            } else if (convId === '3') {
                return [
                    {
                        from: 'John Doe',
                        date: new Date(Date.now() - 7200000).toISOString(),
                        body: 'The Q4 project is progressing well. We have completed 75% of the planned features and are on track for the December release.'
                    },
                    {
                        from: 'Jane Smith',
                        date: new Date(Date.now() - 3600000).toISOString(),
                        body: 'Great update! I\'ve reviewed the latest milestone and everything looks good. Should we schedule a meeting to discuss the remaining 25%?'
                    },
                    {
                        from: 'John Doe',
                        date: new Date(Date.now() - 1800000).toISOString(),
                        body: 'Yes, let\'s meet tomorrow at 2 PM. I\'ll send out a calendar invite.'
                    }
                ];
            }
            
            return [{ from: conv.participants[0], date: conv.last_message_date, body: conv.preview }];
        }

        // ============================================
        // ATTACHMENT GALLERY FUNCTIONS
        // ============================================

        function showAttachmentGallery() {
            // Hide conversation list
            document.getElementById('conversationList').style.display = 'none';
            
            // Show gallery
            const gallery = document.getElementById('galleryContainer');
            gallery.classList.add('active');
            gallery.style.display = 'block';
            
            // Update sidebar active state
            document.querySelectorAll('.folder-item').forEach(f => f.classList.remove('active'));
            event.target.closest('.folder-item').classList.add('active');
            
            // Load attachments
            loadGalleryRecents();
        }

        function hideAttachmentGallery() {
            // Hide gallery
            document.getElementById('galleryContainer').classList.remove('active');
            document.getElementById('galleryContainer').style.display = 'none';
            
            // Show conversation list
            document.getElementById('conversationList').style.display = 'block';
        }

        // ===== CHAT VIEW =====
        function showChatView() {
            hideAllViews();
            let chatView = document.getElementById('chatView');
            if (!chatView) {
                chatView = createChatView();
                document.querySelector('.main-content').appendChild(chatView);
            }
            chatView.style.display = 'block';
            updateSidebarActive(event);
            loadChatConversations();
        }

        function createChatView() {
            const view = document.createElement('div');
            view.id = 'chatView';
            view.style.display = 'none';
            view.innerHTML = `
                <div style="padding: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h1 style="font-size: 24px; font-weight: 600;">🤖 Goose Chat</h1>
                        <button class="compose-btn" onclick="startNewChat()">+ New Chat</button>
                    </div>
                    <div id="chatConversationsList" style="display: grid; gap: 12px;">
                        <div class="loading">Loading chat conversations...</div>
                    </div>
                </div>
            `;
            return view;
        }

        async function loadChatConversations() {
            const container = document.getElementById('chatConversationsList');
            if (!container) return;
            
            try {
                const response = await fetch('/api/chat/conversations', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const conversations = await response.json();
                    renderChatConversations(conversations);
                } else {
                    container.innerHTML = '<div class="empty-state"><h3>No chat conversations yet</h3><p>Start a new chat to get help with your emails</p></div>';
                }
            } catch (error) {
                container.innerHTML = '<div class="empty-state"><h3>No chat conversations yet</h3><p>Start a new chat to get help with your emails</p></div>';
            }
        }

        function renderChatConversations(conversations) {
            const container = document.getElementById('chatConversationsList');
            if (conversations.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>No chat conversations yet</h3><p>Start a new chat to get help with your emails</p></div>';
                return;
            }
            
            container.innerHTML = conversations.map(conv => `
                <div class="conversation" onclick="openChatConversation('${conv.id}')" style="cursor: pointer;">
                    <div class="conversation-line">
                        <div class="conversation-info">
                            <div class="subject-line">🤖 ${escapeHtml(conv.title)}</div>
                            <div class="content-snippet">${escapeHtml(conv.last_message || 'No messages yet')}</div>
                        </div>
                        <div class="timestamp">${formatDate(conv.updated_at)}</div>
                    </div>
                </div>
            `).join('');
        }

        async function startNewChat() {
            try {
                const response = await fetch('/api/chat/conversations', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ title: 'New Chat' })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    openChatConversation(data.id);
                }
            } catch (error) {
                showNotification('Failed to create chat', 'error');
            }
        }

        function openChatConversation(conversationId) {
            hideAllViews();
            let chatInterface = document.getElementById('chatInterface');
            if (!chatInterface) {
                chatInterface = createChatInterface();
                document.querySelector('.main-content').appendChild(chatInterface);
            }
            chatInterface.style.display = 'block';
            chatInterface.dataset.conversationId = conversationId;
            loadChatMessages(conversationId);
        }

        function createChatInterface() {
            const view = document.createElement('div');
            view.id = 'chatInterface';
            view.style.display = 'none';
            view.innerHTML = `
                <div style="display: flex; flex-direction: column; height: calc(100vh - 60px); background: white; border-radius: 8px; margin: 20px;">
                    <div style="padding: 16px; border-bottom: 1px solid #e4e6eb; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <button onclick="showChatView()" style="background: none; border: none; cursor: pointer; font-size: 20px;">←</button>
                            <span style="font-weight: 600; margin-left: 12px;">🤖 Goose Chat</span>
                        </div>
                        <button onclick="deleteChatConversation()" class="icon-btn" title="Delete Conversation">🗑️</button>
                    </div>
                    <div id="chatMessagesContainer" style="flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 16px;">
                        <div class="loading">Loading messages...</div>
                    </div>
                    <div style="padding: 16px; border-top: 1px solid #e4e6eb;">
                        <div style="display: flex; gap: 8px;">
                            <textarea id="chatMessageInput" placeholder="Type your message... (Shift+Enter for new line)" 
                                style="flex: 1; padding: 12px; border: 1px solid #dadde1; border-radius: 8px; resize: none; font-family: inherit; font-size: 14px;" 
                                rows="3"
                                onkeydown="handleChatInputKeydown(event)"></textarea>
                            <button onclick="sendChatMessage()" class="compose-btn" style="align-self: flex-end; height: fit-content;">Send</button>
                        </div>
                    </div>
                </div>
            `;
            return view;
        }

        async function loadChatMessages(conversationId) {
            const container = document.getElementById('chatMessagesContainer');
            if (!container) return;
            
            try {
                const response = await fetch(`/api/chat/conversations/${conversationId}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const messages = await response.json();
                    renderChatMessages(messages);
                } else {
                    container.innerHTML = '<div class="empty-state"><h3>Failed to load messages</h3></div>';
                }
            } catch (error) {
                container.innerHTML = '<div class="empty-state"><h3>Failed to load messages</h3></div>';
            }
        }

        function renderChatMessages(messages) {
            const container = document.getElementById('chatMessagesContainer');
            if (messages.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No messages yet. Start the conversation!</p></div>';
                return;
            }
            
            container.innerHTML = messages.map(msg => {
                const isUser = msg.role === 'user';
                const timestamp = new Date(msg.created_at).toLocaleTimeString();
                return `
                    <div style="display: flex; ${isUser ? 'justify-content: flex-end' : 'justify-content: flex-start'};">
                        <div style="max-width: 70%; padding: 12px 16px; border-radius: 12px; ${isUser ? 'background: #1877f2; color: white;' : 'background: #f0f2f5; color: #1c1e21;'}">
                            <div style="white-space: pre-wrap; word-wrap: break-word;">${escapeHtml(msg.content)}</div>
                            <div style="font-size: 11px; margin-top: 4px; opacity: 0.7;">${timestamp}</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
        }

        function handleChatInputKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendChatMessage();
            }
        }

        async function sendChatMessage() {
            const input = document.getElementById('chatMessageInput');
            const chatInterface = document.getElementById('chatInterface');
            const conversationId = chatInterface?.dataset.conversationId;
            
            if (!input || !conversationId) return;
            
            const content = input.value.trim();
            if (!content) return;
            
            // Clear input and disable
            input.value = '';
            input.disabled = true;
            
            // Add user message to UI immediately
            const container = document.getElementById('chatMessagesContainer');
            const userMsgHtml = `
                <div style="display: flex; justify-content: flex-end;">
                    <div style="max-width: 70%; padding: 12px 16px; border-radius: 12px; background: #1877f2; color: white;">
                        <div style="white-space: pre-wrap; word-wrap: break-word;">${escapeHtml(content)}</div>
                        <div style="font-size: 11px; margin-top: 4px; opacity: 0.7;">${new Date().toLocaleTimeString()}</div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', userMsgHtml);
            
            // Add loading indicator
            const loadingHtml = `
                <div id="chatLoading" style="display: flex; justify-content: flex-start;">
                    <div style="max-width: 70%; padding: 12px 16px; border-radius: 12px; background: #f0f2f5; color: #1c1e21;">
                        <div>🤖 Thinking...</div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', loadingHtml);
            container.scrollTop = container.scrollHeight;
            
            try {
                const response = await fetch(`/api/chat/conversations/${conversationId}/messages`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ content })
                });
                
                // Remove loading indicator
                document.getElementById('chatLoading')?.remove();
                
                if (response.ok) {
                    // Reload all messages to get the assistant response
                    await loadChatMessages(conversationId);
                } else {
                    showNotification('Failed to send message', 'error');
                }
            } catch (error) {
                document.getElementById('chatLoading')?.remove();
                showNotification('Failed to send message', 'error');
            } finally {
                input.disabled = false;
                input.focus();
            }
        }

        async function deleteChatConversation() {
            const chatInterface = document.getElementById('chatInterface');
            const conversationId = chatInterface?.dataset.conversationId;
            if (!conversationId || !confirm('Delete this conversation?')) return;
            
            try {
                await fetch(`/api/chat/conversations/${conversationId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                showNotification('Conversation deleted', 'success');
                showChatView();
            } catch (error) {
                showNotification('Failed to delete conversation', 'error');
            }
        }

        // ===== AUTOMATIONS VIEW =====
        function showAutomationsView() {
            hideAllViews();
            let automationsView = document.getElementById('automationsView');
            if (!automationsView) {
                automationsView = createAutomationsView();
                document.querySelector('.main-content').appendChild(automationsView);
            }
            automationsView.style.display = 'block';
            updateSidebarActive(event);
            loadAutomations();
        }

        function createAutomationsView() {
            const view = document.createElement('div');
            view.id = 'automationsView';
            view.style.display = 'none';
            view.innerHTML = `
                <div style="padding: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h1 style="font-size: 24px; font-weight: 600;">⚙️ Automations</h1>
                        <button class="compose-btn" onclick="createAutomation()">+ New Automation</button>
                    </div>
                    <div id="automationsList" style="display: grid; gap: 12px;">
                        <div class="loading">Loading automations...</div>
                    </div>
                </div>
            `;
            return view;
        }

        async function loadAutomations() {
            const container = document.getElementById('automationsList');
            if (!container) return;
            
            try {
                const response = await fetch('/api/automations', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const automations = await response.json();
                    renderAutomations(automations);
                } else {
                    container.innerHTML = '<div class="empty-state"><h3>No automations yet</h3><p>Create an automation to run AI tasks on a schedule</p></div>';
                }
            } catch (error) {
                container.innerHTML = '<div class="empty-state"><h3>No automations yet</h3><p>Create an automation to run AI tasks on a schedule</p></div>';
            }
        }

        function renderAutomations(automations) {
            const container = document.getElementById('automationsList');
            if (automations.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>No automations yet</h3><p>Create an automation to run AI tasks on a schedule</p></div>';
                return;
            }
            
            container.innerHTML = automations.map(auto => `
                <div class="conversation" style="padding: 16px; background: white; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; margin-bottom: 4px;">${escapeHtml(auto.name)}</div>
                            <div style="color: #65676b; font-size: 14px; margin-bottom: 8px;">${escapeHtml(auto.description || '')}</div>
                            <div style="font-size: 13px; color: #8a8d91;">
                                <span>📅 ${escapeHtml(auto.schedule)}</span>
                                ${auto.last_run ? ` • Last run: ${formatDate(auto.last_run)}` : ''}
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" ${auto.enabled ? 'checked' : ''} 
                                    onchange="toggleAutomation('${auto.id}', this.checked)" 
                                    style="margin-right: 4px;">
                                <span style="font-size: 13px;">${auto.enabled ? 'Enabled' : 'Disabled'}</span>
                            </label>
                            <button class="icon-btn" onclick="runAutomation('${auto.id}')" title="Run Now">▶️</button>
                            <button class="icon-btn" onclick="editAutomation('${auto.id}')" title="Edit">✏️</button>
                            <button class="icon-btn" onclick="deleteAutomation('${auto.id}')" title="Delete">🗑️</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function createAutomation() {
            const modal = document.createElement('div');
            modal.id = 'automationModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 24px; max-width: 500px; width: 90%;">
                    <h2 style="margin: 0 0 20px 0; font-size: 20px;">Create Automation</h2>
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" id="automationName" placeholder="Daily email summary" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px;">
                    </div>
                    <div class="form-group">
                        <label>Description (optional)</label>
                        <input type="text" id="automationDescription" placeholder="Summarize unread emails" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px;">
                    </div>
                    <div class="form-group">
                        <label>Schedule (cron expression)</label>
                        <select id="automationSchedulePreset" onchange="updateScheduleInput(this.value)" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px; margin-bottom: 8px;">
                            <option value="">Custom</option>
                            <option value="0 9 * * *">Daily at 9 AM</option>
                            <option value="0 9 * * 1">Weekly on Monday at 9 AM</option>
                            <option value="0 9 1 * *">Monthly on 1st at 9 AM</option>
                            <option value="0 */6 * * *">Every 6 hours</option>
                        </select>
                        <input type="text" id="automationSchedule" placeholder="0 9 * * *" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px;">
                        <small style="color: #65676b;">Format: minute hour day month weekday</small>
                    </div>
                    <div class="form-group">
                        <label>AI Prompt</label>
                        <textarea id="automationPrompt" placeholder="Summarize all unread emails from the last 24 hours" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px; resize: vertical;" rows="4"></textarea>
                    </div>
                    <div style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 20px;">
                        <button onclick="closeAutomationModal()" style="padding: 8px 16px; border: 1px solid #dadde1; background: white; border-radius: 6px; cursor: pointer;">Cancel</button>
                        <button onclick="saveAutomation()" class="compose-btn">Create</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function updateScheduleInput(preset) {
            const input = document.getElementById('automationSchedule');
            if (preset && input) {
                input.value = preset;
            }
        }

        function closeAutomationModal() {
            const modal = document.getElementById('automationModal');
            if (modal) modal.remove();
        }

        async function saveAutomation() {
            const name = document.getElementById('automationName').value.trim();
            const description = document.getElementById('automationDescription').value.trim();
            const schedule = document.getElementById('automationSchedule').value.trim();
            const prompt = document.getElementById('automationPrompt').value.trim();

            if (!name) {
                showNotification('Please enter a name', 'error');
                return;
            }
            if (!schedule) {
                showNotification('Please enter a schedule', 'error');
                return;
            }
            if (!prompt) {
                showNotification('Please enter a prompt', 'error');
                return;
            }

            try {
                const response = await fetch('/api/automations', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name,
                        description: description || null,
                        schedule,
                        prompt,
                        enabled: true
                    })
                });

                if (response.ok) {
                    showNotification('Automation created', 'success');
                    closeAutomationModal();
                    loadAutomations();
                } else {
                    showNotification('Failed to create automation', 'error');
                }
            } catch (error) {
                showNotification('Failed to create automation', 'error');
            }
        }

        async function toggleAutomation(id, enabled) {
            try {
                await fetch(`/api/automations/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ enabled })
                });
                showNotification(`Automation ${enabled ? 'enabled' : 'disabled'}`, 'success');
            } catch (error) {
                showNotification('Failed to update automation', 'error');
            }
        }

        async function runAutomation(id) {
            try {
                await fetch(`/api/automations/${id}/trigger`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                showNotification('Automation triggered', 'success');
            } catch (error) {
                showNotification('Failed to run automation', 'error');
            }
        }

        function editAutomation(id) {
            showNotification('Automation editing coming soon!', 'info');
        }

        async function deleteAutomation(id) {
            if (!confirm('Delete this automation?')) return;
            try {
                await fetch(`/api/automations/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                showNotification('Automation deleted', 'success');
                loadAutomations();
            } catch (error) {
                showNotification('Failed to delete automation', 'error');
            }
        }

        // ===== REMINDERS VIEW =====
        function showRemindersView() {
            hideAllViews();
            let remindersView = document.getElementById('remindersView');
            if (!remindersView) {
                remindersView = createRemindersView();
                document.querySelector('.main-content').appendChild(remindersView);
            }
            remindersView.style.display = 'block';
            updateSidebarActive(event);
            loadReminders();
        }

        function createRemindersView() {
            const view = document.createElement('div');
            view.id = 'remindersView';
            view.style.display = 'none';
            view.innerHTML = `
                <div style="padding: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h1 style="font-size: 24px; font-weight: 600;">✓ Reminders</h1>
                        <button class="compose-btn" onclick="createReminder()">+ New Reminder</button>
                    </div>
                    <div style="margin-bottom: 16px; display: flex; gap: 8px;">
                        <button class="filter-btn active" data-filter="active" onclick="filterReminders('active')">Active</button>
                        <button class="filter-btn" data-filter="completed" onclick="filterReminders('completed')">Completed</button>
                        <button class="filter-btn" data-filter="all" onclick="filterReminders('all')">All</button>
                    </div>
                    <div id="remindersList" style="display: grid; gap: 12px;">
                        <div class="loading">Loading reminders...</div>
                    </div>
                </div>
            `;
            return view;
        }

        let currentReminderFilter = 'active';

        async function loadReminders() {
            const container = document.getElementById('remindersList');
            if (!container) return;
            
            try {
                const response = await fetch(`/api/reminders?filter=${currentReminderFilter}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const reminders = await response.json();
                    renderReminders(reminders);
                } else {
                    container.innerHTML = '<div class="empty-state"><h3>No reminders yet</h3><p>Create a reminder to track your tasks</p></div>';
                }
            } catch (error) {
                container.innerHTML = '<div class="empty-state"><h3>No reminders yet</h3><p>Create a reminder to track your tasks</p></div>';
            }
        }

        function renderReminders(reminders) {
            const container = document.getElementById('remindersList');
            if (reminders.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>No reminders found</h3></div>';
                return;
            }
            
            container.innerHTML = reminders.map(reminder => {
                const isOverdue = reminder.due_date && new Date(reminder.due_date) < new Date() && !reminder.completed;
                return `
                <div class="conversation" style="padding: 16px; background: white; border-radius: 8px; ${reminder.completed ? 'opacity: 0.6;' : ''}">
                    <div style="display: flex; gap: 12px; align-items: start;">
                        <input type="checkbox" ${reminder.completed ? 'checked' : ''} 
                            onchange="toggleReminder('${reminder.id}', this.checked)" 
                            style="margin-top: 4px; cursor: pointer;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; margin-bottom: 4px; ${reminder.completed ? 'text-decoration: line-through;' : ''}">
                                ${escapeHtml(reminder.title)}
                            </div>
                            ${reminder.notes ? `<div style="color: #65676b; font-size: 14px; margin-bottom: 8px;">${escapeHtml(reminder.notes)}</div>` : ''}
                            ${reminder.due_date ? `
                                <div style="font-size: 13px; color: ${isOverdue ? '#c62828' : '#8a8d91'};">
                                    📅 Due: ${formatDate(reminder.due_date)} ${isOverdue ? '(Overdue)' : ''}
                                </div>
                            ` : ''}
                        </div>
                        <div style="display: flex; gap: 4px;">
                            <button class="icon-btn" onclick="editReminder('${reminder.id}')" title="Edit">✏️</button>
                            <button class="icon-btn" onclick="deleteReminder('${reminder.id}')" title="Delete">🗑️</button>
                        </div>
                    </div>
                </div>
            `;
            }).join('');
        }

        function filterReminders(filter) {
            currentReminderFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });
            loadReminders();
        }

        function createReminder() {
            const modal = document.createElement('div');
            modal.id = 'reminderModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 24px; max-width: 500px; width: 90%;">
                    <h2 style="margin: 0 0 20px 0; font-size: 20px;">Create Reminder</h2>
                    <div class="form-group">
                        <label>Title</label>
                        <input type="text" id="reminderTitle" placeholder="Complete project report" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px;">
                    </div>
                    <div class="form-group">
                        <label>Notes (optional)</label>
                        <textarea id="reminderNotes" placeholder="Include Q4 metrics and team feedback" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px; resize: vertical;" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Due Date (optional)</label>
                        <input type="datetime-local" id="reminderDueDate" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px;">
                    </div>
                    <div style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 20px;">
                        <button onclick="closeReminderModal()" style="padding: 8px 16px; border: 1px solid #dadde1; background: white; border-radius: 6px; cursor: pointer;">Cancel</button>
                        <button onclick="saveReminder()" class="compose-btn">Create</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function closeReminderModal() {
            const modal = document.getElementById('reminderModal');
            if (modal) modal.remove();
        }

        async function saveReminder() {
            const title = document.getElementById('reminderTitle').value.trim();
            const notes = document.getElementById('reminderNotes').value.trim();
            const due_date = document.getElementById('reminderDueDate').value;

            if (!title) {
                showNotification('Please enter a title', 'error');
                return;
            }

            try {
                const response = await fetch('/api/reminders', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title,
                        notes: notes || null,
                        due_date: due_date ? new Date(due_date).toISOString() : null
                    })
                });

                if (response.ok) {
                    showNotification('Reminder created', 'success');
                    closeReminderModal();
                    loadReminders();
                } else {
                    showNotification('Failed to create reminder', 'error');
                }
            } catch (error) {
                showNotification('Failed to create reminder', 'error');
            }
        }

        async function toggleReminder(id, completed) {
            try {
                await fetch(`/api/reminders/${id}/complete`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ completed })
                });
                loadReminders();
            } catch (error) {
                showNotification('Failed to update reminder', 'error');
            }
        }

        function editReminder(id) {
            showNotification('Reminder editing coming soon!', 'info');
        }

        async function deleteReminder(id) {
            if (!confirm('Delete this reminder?')) return;
            try {
                await fetch(`/api/reminders/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                showNotification('Reminder deleted', 'success');
                loadReminders();
            } catch (error) {
                showNotification('Failed to delete reminder', 'error');
            }
        }

        // ===== SETTINGS VIEW =====
        function showSettingsView() {
            hideAllViews();
            let settingsView = document.getElementById('settingsView');
            if (!settingsView) {
                settingsView = createSettingsView();
                document.querySelector('.main-content').appendChild(settingsView);
            }
            settingsView.style.display = 'block';
            updateSidebarActive(event);
        }

        function createSettingsView() {
            const view = document.createElement('div');
            view.id = 'settingsView';
            view.style.display = 'none';
            view.innerHTML = `
                <div style="padding: 20px; max-width: 800px;">
                    <h1 style="font-size: 24px; font-weight: 600; margin-bottom: 24px;">⚙️ Settings</h1>
                    
                    <div style="background: white; border-radius: 8px; padding: 20px; margin-bottom: 16px;">
                        <h2 style="font-size: 18px; font-weight: 600; margin-bottom: 16px;">Email Settings</h2>
                        <div class="form-group">
                            <label>IMAP Host</label>
                            <input id="setting-imap-host" type="text" placeholder="imap.gmail.com" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px;">
                        </div>
                        <div class="form-group">
                            <label>SMTP Host</label>
                            <input id="setting-smtp-host" type="text" placeholder="smtp.gmail.com" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px;">
                        </div>
                    </div>
                    
                    <div style="background: white; border-radius: 8px; padding: 20px; margin-bottom: 16px;">
                        <h2 style="font-size: 18px; font-weight: 600; margin-bottom: 16px;">AI Agent Settings</h2>
                        <div class="form-group">
                            <label>LLM Provider</label>
                            <select id="setting-llm-provider" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px;">
                                <option>Anthropic</option>
                                <option>OpenAI</option>
                                <option>Databricks</option>
                                <option>Local GGUF</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>API Key</label>
                            <input id="setting-api-key" type="password" placeholder="Enter API key" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px;">
                        </div>
                        <div class="form-group">
                            <label>Model ID</label>
                            <input id="setting-model-id" type="text" placeholder="claude-3-5-sonnet-20241022" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px;">
                        </div>
                    </div>
                    
                    <div style="background: white; border-radius: 8px; padding: 20px; margin-bottom: 16px;">
                        <h2 style="font-size: 18px; font-weight: 600; margin-bottom: 16px;">Calendar Settings</h2>
                        <div class="form-group">
                            <label>CalDAV Server URL</label>
                            <input id="setting-caldav-url" type="text" placeholder="https://caldav.example.com" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px;">
                        </div>
                        <div class="form-group">
                            <label>Username</label>
                            <input id="setting-caldav-username" type="text" placeholder="username" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px;">
                        </div>
                        <div class="form-group">
                            <label>Password</label>
                            <input id="setting-caldav-password" type="password" placeholder="password" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px;">
                        </div>
                    </div>
                    
                    <div style="background: white; border-radius: 8px; padding: 20px;">
                        <h2 style="font-size: 18px; font-weight: 600; margin-bottom: 16px;">Personal Money Settings</h2>
                        <div class="form-group">
                            <label>Bank Account</label>
                            <input id="setting-bank-account" type="text" placeholder="Account credentials" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px;">
                        </div>
                        <div class="form-group">
                            <label>Cash App ID</label>
                            <input id="setting-cashapp-id" type="text" placeholder="$cashtag" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px;">
                        </div>
                    </div>
                    
                    <div id="settings-save-status" style="margin-top: 16px; padding: 12px; border-radius: 8px; display: none;"></div>
                </div>
            `;
            
            // Add auto-save listeners after view is created
            setTimeout(() => {
                const settingInputs = [
                    'setting-imap-host', 'setting-smtp-host', 'setting-llm-provider',
                    'setting-api-key', 'setting-model-id', 'setting-caldav-url',
                    'setting-caldav-username', 'setting-caldav-password',
                    'setting-bank-account', 'setting-cashapp-id'
                ];
                
                settingInputs.forEach(id => {
                    const input = document.getElementById(id);
                    if (input) {
                        input.addEventListener('change', () => saveSettings());
                    }
                });
                
                // Load current settings
                loadSettings();
            }, 100);
            
            return view;
        }
        
        async function loadSettings() {
            try {
                const response = await fetch('/api/settings', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const settings = await response.json();
                    // Populate form fields with loaded settings
                    // Note: Backend needs to return these fields
                }
            } catch (error) {
                console.error('Failed to load settings:', error);
            }
        }
        
        async function saveSettings() {
            const settings = {
                imap_host: document.getElementById('setting-imap-host')?.value,
                smtp_host: document.getElementById('setting-smtp-host')?.value,
                llm_provider: document.getElementById('setting-llm-provider')?.value,
                api_key: document.getElementById('setting-api-key')?.value,
                model_id: document.getElementById('setting-model-id')?.value,
                caldav_url: document.getElementById('setting-caldav-url')?.value,
                caldav_username: document.getElementById('setting-caldav-username')?.value,
                caldav_password: document.getElementById('setting-caldav-password')?.value,
                bank_account: document.getElementById('setting-bank-account')?.value,
                cashapp_id: document.getElementById('setting-cashapp-id')?.value
            };
            
            try {
                const response = await fetch('/api/settings', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settings)
                });
                
                const statusDiv = document.getElementById('settings-save-status');
                if (response.ok) {
                    statusDiv.style.display = 'block';
                    statusDiv.style.background = '#e8f5e8';
                    statusDiv.style.color = '#2e7d32';
                    statusDiv.textContent = '✓ Settings saved successfully';
                    setTimeout(() => { statusDiv.style.display = 'none'; }, 3000);
                } else {
                    statusDiv.style.display = 'block';
                    statusDiv.style.background = '#ffebee';
                    statusDiv.style.color = '#c62828';
                    statusDiv.textContent = '✗ Failed to save settings';
                }
            } catch (error) {
                console.error('Failed to save settings:', error);
            }
        }

        // ===== CALENDAR VIEW =====
        function showCalendarView() {
            hideAllViews();
            let calendarView = document.getElementById('calendarView');
            if (!calendarView) {
                calendarView = createCalendarView();
                document.querySelector('.main-content').appendChild(calendarView);
            }
            calendarView.style.display = 'block';
            updateSidebarActive(event);
            loadCalendarEvents();
        }

        function createCalendarView() {
            const view = document.createElement('div');
            view.id = 'calendarView';
            view.style.display = 'none';
            view.innerHTML = `
                <div style="padding: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h1 style="font-size: 24px; font-weight: 600;">📅 Calendar</h1>
                        <button class="compose-btn" onclick="createCalendarEvent()">+ New Event</button>
                    </div>
                    <div id="calendarEventsList" style="display: grid; gap: 12px;">
                        <div class="loading">Loading events...</div>
                    </div>
                </div>
            `;
            return view;
        }

        async function loadCalendarEvents() {
            const container = document.getElementById('calendarEventsList');
            if (!container) return;
            
            try {
                const response = await fetch('/api/calendar/events', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const events = await response.json();
                    renderCalendarEvents(events);
                } else {
                    container.innerHTML = '<div class="empty-state"><h3>No calendar events</h3><p>Create an event to get started</p></div>';
                }
            } catch (error) {
                container.innerHTML = '<div class="empty-state"><h3>No calendar events</h3><p>Create an event to get started</p></div>';
            }
        }

        function renderCalendarEvents(events) {
            const container = document.getElementById('calendarEventsList');
            if (events.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>No calendar events</h3></div>';
                return;
            }
            
            container.innerHTML = events.map(event => {
                const startDate = new Date(event.start_time);
                const endDate = new Date(event.end_time);
                return `
                <div class="conversation" style="padding: 16px; background: white; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; margin-bottom: 4px;">${escapeHtml(event.title)}</div>
                            ${event.description ? `<div style="color: #65676b; font-size: 14px; margin-bottom: 8px;">${escapeHtml(event.description)}</div>` : ''}
                            <div style="font-size: 13px; color: #8a8d91;">
                                <span>📅 ${startDate.toLocaleString()}</span>
                                ${event.location ? ` • 📍 ${escapeHtml(event.location)}` : ''}
                            </div>
                        </div>
                        <div style="display: flex; gap: 4px;">
                            <button class="icon-btn" onclick="editCalendarEvent('${event.id}')" title="Edit">✏️</button>
                            <button class="icon-btn" onclick="deleteCalendarEvent('${event.id}')" title="Delete">🗑️</button>
                        </div>
                    </div>
                </div>
            `;
            }).join('');
        }

        function createCalendarEvent() {
            const modal = document.createElement('div');
            modal.id = 'calendarModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 24px; max-width: 500px; width: 90%;">
                    <h2 style="margin: 0 0 20px 0; font-size: 20px;">Create Calendar Event</h2>
                    <div class="form-group">
                        <label>Title</label>
                        <input type="text" id="eventTitle" placeholder="Team Meeting" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px;">
                    </div>
                    <div class="form-group">
                        <label>Description (optional)</label>
                        <textarea id="eventDescription" placeholder="Discuss project updates" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px; resize: vertical;" rows="2"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Location (optional)</label>
                        <input type="text" id="eventLocation" placeholder="Conference Room A" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px;">
                    </div>
                    <div class="form-group">
                        <label>Start Time</label>
                        <input type="datetime-local" id="eventStartTime" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px;">
                    </div>
                    <div class="form-group">
                        <label>End Time</label>
                        <input type="datetime-local" id="eventEndTime" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px;">
                    </div>
                    <div style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 20px;">
                        <button onclick="closeCalendarModal()" style="padding: 8px 16px; border: 1px solid #dadde1; background: white; border-radius: 6px; cursor: pointer;">Cancel</button>
                        <button onclick="saveCalendarEvent()" class="compose-btn">Create</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Set default times (now and +1 hour)
            const now = new Date();
            const later = new Date(now.getTime() + 60 * 60 * 1000);
            document.getElementById('eventStartTime').value = now.toISOString().slice(0, 16);
            document.getElementById('eventEndTime').value = later.toISOString().slice(0, 16);
        }

        function closeCalendarModal() {
            const modal = document.getElementById('calendarModal');
            if (modal) modal.remove();
        }

        async function saveCalendarEvent() {
            const title = document.getElementById('eventTitle').value.trim();
            const description = document.getElementById('eventDescription').value.trim();
            const location = document.getElementById('eventLocation').value.trim();
            const start_time = document.getElementById('eventStartTime').value;
            const end_time = document.getElementById('eventEndTime').value;

            if (!title) {
                showNotification('Please enter a title', 'error');
                return;
            }
            if (!start_time || !end_time) {
                showNotification('Please enter start and end times', 'error');
                return;
            }

            try {
                const response = await fetch('/api/calendar/events', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title,
                        description: description || null,
                        location: location || null,
                        start_time: new Date(start_time).toISOString(),
                        end_time: new Date(end_time).toISOString(),
                        all_day: false
                    })
                });

                if (response.ok) {
                    showNotification('Event created', 'success');
                    closeCalendarModal();
                    loadCalendarEvents();
                } else {
                    showNotification('Failed to create event', 'error');
                }
            } catch (error) {
                showNotification('Failed to create event', 'error');
            }
        }

        function editCalendarEvent(id) {
            showNotification('Calendar event editing coming soon!', 'info');
        }

        async function deleteCalendarEvent(id) {
            if (!confirm('Delete this event?')) return;
            try {
                await fetch(`/api/calendar/events/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                showNotification('Event deleted', 'success');
                loadCalendarEvents();
            } catch (error) {
                showNotification('Failed to delete event', 'error');
            }
        }

        // ===== MONEY VIEW =====
        function showMoneyView() {
            hideAllViews();
            let moneyView = document.getElementById('moneyView');
            if (!moneyView) {
                moneyView = createMoneyView();
                document.querySelector('.main-content').appendChild(moneyView);
            }
            moneyView.style.display = 'block';
            updateSidebarActive(event);
            loadMoneyAccounts();
        }

        function createMoneyView() {
            const view = document.createElement('div');
            view.id = 'moneyView';
            view.style.display = 'none';
            view.innerHTML = `
                <div style="padding: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h1 style="font-size: 24px; font-weight: 600;">💰 Money</h1>
                        <button class="compose-btn" onclick="addMoneyAccount()">+ Add Account</button>
                    </div>
                    <div id="moneyTotalBalance" style="background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                        <div style="font-size: 14px; color: #65676b; margin-bottom: 4px;">Total Balance</div>
                        <div style="font-size: 32px; font-weight: 600;">$0.00</div>
                    </div>
                    <div id="moneyAccountsList" style="display: grid; gap: 12px;">
                        <div class="loading">Loading accounts...</div>
                    </div>
                </div>
            `;
            return view;
        }

        async function loadMoneyAccounts() {
            const container = document.getElementById('moneyAccountsList');
            const balanceContainer = document.getElementById('moneyTotalBalance');
            if (!container) return;
            
            try {
                const response = await fetch('/api/money/accounts', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    renderMoneyAccounts(data.accounts);
                    if (balanceContainer) {
                        balanceContainer.innerHTML = `
                            <div style="font-size: 14px; color: #65676b; margin-bottom: 4px;">Total Balance</div>
                            <div style="font-size: 32px; font-weight: 600;">$${data.total_balance.toFixed(2)}</div>
                        `;
                    }
                } else {
                    container.innerHTML = '<div class="empty-state"><h3>No accounts</h3><p>Add an account to track your finances</p></div>';
                }
            } catch (error) {
                container.innerHTML = '<div class="empty-state"><h3>No accounts</h3><p>Add an account to track your finances</p></div>';
            }
        }

        function renderMoneyAccounts(accounts) {
            const container = document.getElementById('moneyAccountsList');
            if (accounts.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>No accounts</h3></div>';
                return;
            }
            
            container.innerHTML = accounts.map(account => `
                <div class="conversation" style="padding: 16px; background: white; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 600; margin-bottom: 4px;">${escapeHtml(account.account_name)}</div>
                            <div style="font-size: 13px; color: #8a8d91;">${escapeHtml(account.account_type)}</div>
                        </div>
                        <div style="font-size: 20px; font-weight: 600;">$${account.balance.toFixed(2)}</div>
                    </div>
                </div>
            `).join('');
        }

        function addMoneyAccount() {
            showNotification('Account creation coming soon!', 'info');
        }

        // ===== HELPER FUNCTIONS =====
        function hideAllViews() {
            document.getElementById('conversationList').style.display = 'none';
            document.getElementById('galleryContainer').style.display = 'none';
            ['chatView', 'chatInterface', 'automationsView', 'remindersView', 'calendarView', 'moneyView', 'settingsView'].forEach(id => {
                const view = document.getElementById(id);
                if (view) view.style.display = 'none';
            });
        }

        function updateSidebarActive(event) {
            if (event && event.target) {
                document.querySelectorAll('.folder-item').forEach(f => f.classList.remove('active'));
                event.target.closest('.folder-item').classList.add('active');
            }
        }

        async function loadGalleryRecents() {
            const container = document.getElementById('recentsView');
            container.innerHTML = '<div class="loading">Loading attachments...</div>';
            
            try {
                const response = await fetch('/api/attachments/gallery/recents?limit=50', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    attachments = await response.json();
                } else {
                    attachments = getMockAttachments();
                }
            } catch (error) {
                console.log('Using mock attachments');
                attachments = getMockAttachments();
            }
            
            filteredAttachments = attachments;
            renderGalleryView();
        }

        async function loadGalleryBySender() {
            const container = document.getElementById('senderView');
            container.innerHTML = '<div class="loading">Loading attachments...</div>';
            
            try {
                const response = await fetch('/api/attachments/gallery/by-sender', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const senderData = await response.json();
                    renderSenderView(senderData);
                } else {
                    renderSenderView(getMockSenderData());
                }
            } catch (error) {
                console.log('Using mock sender data');
                renderSenderView(getMockSenderData());
            }
        }

        function switchGalleryView(mode) {
            currentView = mode;
            
            // Update button states
            document.querySelectorAll('.view-mode-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.mode === mode) {
                    btn.classList.add('active');
                }
            });
            
            // Hide all views
            document.getElementById('recentsView').style.display = 'none';
            document.getElementById('senderView').style.display = 'none';
            document.getElementById('listView').style.display = 'none';
            
            // Show selected view
            if (mode === 'recents') {
                document.getElementById('recentsView').style.display = 'grid';
                renderGalleryView();
            } else if (mode === 'sender') {
                document.getElementById('senderView').style.display = 'block';
                loadGalleryBySender();
            } else if (mode === 'list') {
                document.getElementById('listView').style.display = 'block';
                renderListView();
            }
        }

        function renderGalleryView() {
            const container = document.getElementById('recentsView');
            
            if (filteredAttachments.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>No attachments found</h3><p>Attachments from your emails will appear here</p></div>';
                return;
            }
            
            container.innerHTML = '';
            
            // Pagination
            const start = (currentPage - 1) * pageSize;
            const end = start + pageSize;
            const pageAttachments = filteredAttachments.slice(start, end);
            
            pageAttachments.forEach(attachment => {
                const card = createAttachmentCard(attachment);
                container.appendChild(card);
            });
            
            updatePagination();
        }

        function createAttachmentCard(attachment) {
            const card = document.createElement('div');
            card.className = 'attachment-card';
            
            const thumbnail = getThumbnailContent(attachment);
            
            card.innerHTML = `
                <div class="attachment-thumbnail">
                    ${thumbnail}
                </div>
                <div class="attachment-info">
                    <div class="attachment-filename" title="${escapeHtml(attachment.filename)}">
                        ${escapeHtml(attachment.filename)}
                    </div>
                    <div class="attachment-meta">
                        <span>${formatFileSize(attachment.size)}</span>
                        <span>${formatDate(attachment.received_at || attachment.created_at)}</span>
                    </div>
                </div>
            `;
            
            card.addEventListener('click', () => previewAttachment(attachment));
            
            return card;
        }

        function getThumbnailContent(attachment) {
            const contentType = attachment.content_type || '';
            
            if (contentType.startsWith('image/')) {
                // Check if thumbnail exists
                if (attachment.preview_generated) {
                    return `<img src="/api/attachments/${attachment.id}/thumbnail" alt="${escapeHtml(attachment.filename)}" onerror="this.parentElement.innerHTML='🖼️'">`;
                }
                return '🖼️';
            } else if (contentType === 'application/pdf') {
                return '📄';
            } else if (contentType.includes('word') || contentType.includes('document')) {
                return '📝';
            } else if (contentType.includes('sheet') || contentType.includes('excel')) {
                return '📊';
            } else if (contentType.includes('presentation') || contentType.includes('powerpoint')) {
                return '📽️';
            } else if (contentType.includes('zip') || contentType.includes('archive') || contentType.includes('compressed')) {
                return '📦';
            } else if (contentType.includes('video')) {
                return '🎥';
            } else if (contentType.includes('audio')) {
                return '🎵';
            } else {
                return '📎';
            }
        }

        function renderSenderView(senderData) {
            const container = document.getElementById('senderView');
            
            if (!senderData || senderData.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>No attachments found</h3></div>';
                return;
            }
            
            container.innerHTML = '';
            
            senderData.forEach(sender => {
                const group = document.createElement('div');
                group.className = 'sender-group';
                
                const initial = (sender.sender_name || sender.sender_email || '?')[0].toUpperCase();
                
                group.innerHTML = `
                    <div class="sender-header">
                        <div class="sender-info">
                            <div class="sender-avatar">${initial}</div>
                            <div class="sender-details">
                                <h3>${escapeHtml(sender.sender_name || sender.sender_email)}</h3>
                                <p>${escapeHtml(sender.sender_email)}</p>
                            </div>
                        </div>
                        <div class="sender-count">${sender.attachment_count} files</div>
                    </div>
                    <div class="sender-attachments" id="sender-${sender.sender_email.replace(/[^a-z0-9]/gi, '')}">
                        <div class="loading">Loading...</div>
                    </div>
                `;
                
                group.querySelector('.sender-header').addEventListener('click', () => {
                    toggleSenderGroup(group, sender.sender_email);
                });
                
                container.appendChild(group);
            });
        }

        async function toggleSenderGroup(groupElement, senderEmail) {
            const isExpanded = groupElement.classList.contains('expanded');
            
            if (isExpanded) {
                groupElement.classList.remove('expanded');
                return;
            }
            
            groupElement.classList.add('expanded');
            
            const attachmentsContainer = groupElement.querySelector('.sender-attachments');
            
            // Load attachments for this sender
            try {
                const response = await fetch(`/api/attachments/gallery?sender=${encodeURIComponent(senderEmail)}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                let senderAttachments;
                if (response.ok) {
                    const data = await response.json();
                    senderAttachments = data.attachments || data;
                } else {
                    senderAttachments = attachments.filter(a => a.sender_email === senderEmail);
                }
                
                renderSenderAttachments(attachmentsContainer, senderAttachments);
            } catch (error) {
                const senderAttachments = attachments.filter(a => a.sender_email === senderEmail);
                renderSenderAttachments(attachmentsContainer, senderAttachments);
            }
        }

        function renderSenderAttachments(container, attachments) {
            if (attachments.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No attachments</p></div>';
                return;
            }
            
            container.innerHTML = '';
            
            attachments.forEach(attachment => {
                const item = document.createElement('div');
                item.className = 'attachment-list-item';
                
                const icon = getThumbnailContent(attachment);
                const hasImage = attachment.content_type?.startsWith('image/') && attachment.preview_generated;
                
                item.innerHTML = `
                    <div class="attachment-icon">
                        ${hasImage ? `<img src="/api/attachments/${attachment.id}/thumbnail" alt="${escapeHtml(attachment.filename)}">` : icon}
                    </div>
                    <div class="attachment-details">
                        <h4>${escapeHtml(attachment.filename)}</h4>
                        <p>${formatFileSize(attachment.size)} • ${formatDate(attachment.received_at || attachment.created_at)}</p>
                    </div>
                `;
                
                item.addEventListener('click', () => previewAttachment(attachment));
                
                container.appendChild(item);
            });
        }

        function renderListView() {
            const container = document.getElementById('listView');
            
            if (filteredAttachments.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>No attachments found</h3></div>';
                return;
            }
            
            container.innerHTML = '';
            
            // Create table
            const table = document.createElement('div');
            table.style.background = 'white';
            table.style.borderRadius = '8px';
            table.style.overflow = 'hidden';
            
            const start = (currentPage - 1) * pageSize;
            const end = start + pageSize;
            const pageAttachments = filteredAttachments.slice(start, end);
            
            pageAttachments.forEach(attachment => {
                const row = document.createElement('div');
                row.className = 'attachment-list-item';
                row.style.margin = '0';
                row.style.borderRadius = '0';
                row.style.borderBottom = '1px solid #e4e6eb';
                
                const icon = getThumbnailContent(attachment);
                
                row.innerHTML = `
                    <div class="attachment-icon">
                        ${icon}
                    </div>
                    <div class="attachment-details" style="flex: 2;">
                        <h4>${escapeHtml(attachment.filename)}</h4>
                    </div>
                    <div style="flex: 1; font-size: 13px; color: #65676b;">
                        ${escapeHtml(attachment.sender_name || attachment.sender_email || 'Unknown')}
                    </div>
                    <div style="flex: 1; font-size: 13px; color: #65676b;">
                        ${formatDate(attachment.received_at || attachment.created_at)}
                    </div>
                    <div style="flex: 0.5; font-size: 13px; color: #65676b; text-align: right;">
                        ${formatFileSize(attachment.size)}
                    </div>
                `;
                
                row.addEventListener('click', () => previewAttachment(attachment));
                
                table.appendChild(row);
            });
            
            container.appendChild(table);
            updatePagination();
        }

        function searchAttachments() {
            const query = document.getElementById('gallerySearchInput').value.toLowerCase();
            
            if (!query) {
                filteredAttachments = attachments;
            } else {
                filteredAttachments = attachments.filter(att => 
                    att.filename.toLowerCase().includes(query) ||
                    (att.sender_name && att.sender_name.toLowerCase().includes(query)) ||
                    (att.sender_email && att.sender_email.toLowerCase().includes(query))
                );
            }
            
            currentPage = 1;
            applyFilters();
        }

        function applyFilters() {
            const dateFilter = document.getElementById('filterDate').value;
            const typeFilter = document.getElementById('filterType').value;
            const sizeFilter = document.getElementById('filterSize').value;
            
            let filtered = filteredAttachments;
            
            // Date filter
            if (dateFilter) {
                const now = new Date();
                filtered = filtered.filter(att => {
                    const attDate = new Date(att.received_at || att.created_at);
                    const diffDays = Math.floor((now - attDate) / (1000 * 60 * 60 * 24));
                    
                    if (dateFilter === 'today') return diffDays === 0;
                    if (dateFilter === 'week') return diffDays <= 7;
                    if (dateFilter === 'month') return diffDays <= 30;
                    return true;
                });
            }
            
            // Type filter
            if (typeFilter) {
                filtered = filtered.filter(att => {
                    const contentType = att.content_type || '';
                    
                    if (typeFilter === 'image') return contentType.startsWith('image/');
                    if (typeFilter === 'pdf') return contentType === 'application/pdf';
                    if (typeFilter === 'document') return contentType.includes('word') || contentType.includes('document');
                    if (typeFilter === 'spreadsheet') return contentType.includes('sheet') || contentType.includes('excel');
                    if (typeFilter === 'archive') return contentType.includes('zip') || contentType.includes('archive');
                    return true;
                });
            }
            
            // Size filter
            if (sizeFilter) {
                filtered = filtered.filter(att => {
                    const sizeMB = att.size / (1024 * 1024);
                    
                    if (sizeFilter === 'small') return sizeMB < 1;
                    if (sizeFilter === 'medium') return sizeMB >= 1 && sizeMB <= 10;
                    if (sizeFilter === 'large') return sizeMB > 10;
                    return true;
                });
            }
            
            filteredAttachments = filtered;
            currentPage = 1;
            
            if (currentView === 'recents') {
                renderGalleryView();
            } else if (currentView === 'list') {
                renderListView();
            }
        }

        function previewAttachment(attachment) {
            const modal = document.getElementById('previewModal');
            const content = modal.querySelector('.preview-content');
            
            const contentType = attachment.content_type || '';
            const isImage = contentType.startsWith('image/');
            const isPDF = contentType === 'application/pdf';
            
            let previewBody = '';
            if (isImage) {
                previewBody = `<img src="/api/attachments/${attachment.id}" alt="${escapeHtml(attachment.filename)}">`;
            } else if (isPDF) {
                previewBody = `<iframe src="/api/attachments/${attachment.id}" style="width: 100%; height: 500px; border: none;"></iframe>`;
            } else {
                previewBody = `<div style="text-align: center; padding: 40px;"><div style="font-size: 64px; margin-bottom: 16px;">${getThumbnailContent(attachment)}</div><p>Preview not available for this file type</p></div>`;
            }
            
            content.innerHTML = `
                <div class="preview-header">
                    <h3>${escapeHtml(attachment.filename)}</h3>
                    <div class="preview-actions">
                        <button class="btn-secondary" onclick="downloadAttachment('${attachment.id}', '${escapeHtml(attachment.filename)}')">Download</button>
                        <button class="btn-secondary" onclick="deleteAttachment('${attachment.id}')">Delete</button>
                        <button class="close-btn" onclick="closePreview()">×</button>
                    </div>
                </div>
                <div class="preview-body">
                    ${previewBody}
                </div>
                <div class="preview-metadata">
                    <div class="metadata-row">
                        <span class="metadata-label">From:</span>
                        <span class="metadata-value">${escapeHtml(attachment.sender_name || attachment.sender_email || 'Unknown')}</span>
                    </div>
                    <div class="metadata-row">
                        <span class="metadata-label">Date:</span>
                        <span class="metadata-value">${formatDate(attachment.received_at || attachment.created_at)}</span>
                    </div>
                    <div class="metadata-row">
                        <span class="metadata-label">Size:</span>
                        <span class="metadata-value">${formatFileSize(attachment.size)}</span>
                    </div>
                    <div class="metadata-row">
                        <span class="metadata-label">Type:</span>
                        <span class="metadata-value">${escapeHtml(attachment.content_type || 'Unknown')}</span>
                    </div>
                </div>
            `;
            
            modal.classList.add('active');
        }

        function closePreview() {
            document.getElementById('previewModal').classList.remove('active');
        }

        async function downloadAttachment(attachmentId, filename) {
            try {
                const response = await fetch(`/api/attachments/${attachmentId}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    showNotification('Download started', 'success');
                } else {
                    throw new Error('Download failed');
                }
            } catch (error) {
                showNotification('Download failed (demo mode)', 'info');
            }
        }

        async function deleteAttachment(attachmentId) {
            if (!confirm('Are you sure you want to delete this attachment?')) return;
            
            try {
                const response = await fetch(`/api/attachments/${attachmentId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    showNotification('Attachment deleted', 'success');
                    closePreview();
                    
                    // Remove from local state
                    attachments = attachments.filter(a => a.id !== attachmentId);
                    filteredAttachments = filteredAttachments.filter(a => a.id !== attachmentId);
                    
                    // Re-render current view
                    if (currentView === 'recents') {
                        renderGalleryView();
                    } else if (currentView === 'list') {
                        renderListView();
                    } else if (currentView === 'sender') {
                        loadGalleryBySender();
                    }
                } else {
                    throw new Error('Delete failed');
                }
            } catch (error) {
                showNotification('Delete failed (demo mode)', 'info');
                closePreview();
            }
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
            return (bytes / (1024 * 1024 * 1024)).toFixed(1) + ' GB';
        }

        function updatePagination() {
            const pagination = document.getElementById('galleryPagination');
            const totalPages = Math.ceil(filteredAttachments.length / pageSize);
            
            if (totalPages <= 1) {
                pagination.style.display = 'none';
                return;
            }
            
            pagination.style.display = 'flex';
            document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
            
            const prevBtn = pagination.querySelector('button:first-child');
            const nextBtn = pagination.querySelector('button:last-child');
            
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages;
        }

        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                if (currentView === 'recents') {
                    renderGalleryView();
                } else if (currentView === 'list') {
                    renderListView();
                }
            }
        }

        function nextPage() {
            const totalPages = Math.ceil(filteredAttachments.length / pageSize);
            if (currentPage < totalPages) {
                currentPage++;
                if (currentView === 'recents') {
                    renderGalleryView();
                } else if (currentView === 'list') {
                    renderListView();
                }
            }
        }

        // Close preview modal when clicking outside
        document.getElementById('previewModal')?.addEventListener('click', (e) => {
            if (e.target.id === 'previewModal') {
                closePreview();
            }
        });

        // Mock data for attachments
        function getMockAttachments() {
            return [
                {
                    id: 'att1',
                    filename: 'project-proposal.pdf',
                    content_type: 'application/pdf',
                    size: 2457600,
                    sender_email: 'john@example.com',
                    sender_name: 'John Doe',
                    received_at: new Date(Date.now() - 3600000).toISOString(),
                    preview_generated: false
                },
                {
                    id: 'att2',
                    filename: 'vacation-photo.jpg',
                    content_type: 'image/jpeg',
                    size: 1536000,
                    sender_email: 'jane@example.com',
                    sender_name: 'Jane Smith',
                    received_at: new Date(Date.now() - 7200000).toISOString(),
                    preview_generated: true
                },
                {
                    id: 'att3',
                    filename: 'quarterly-report.xlsx',
                    content_type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                    size: 524288,
                    sender_email: 'finance@example.com',
                    sender_name: 'Finance Team',
                    received_at: new Date(Date.now() - 86400000).toISOString(),
                    preview_generated: false
                },
                {
                    id: 'att4',
                    filename: 'meeting-notes.docx',
                    content_type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                    size: 102400,
                    sender_email: 'john@example.com',
                    sender_name: 'John Doe',
                    received_at: new Date(Date.now() - 172800000).toISOString(),
                    preview_generated: false
                },
                {
                    id: 'att5',
                    filename: 'presentation.pptx',
                    content_type: 'application/vnd.openxmlformats-officedocument.presentationml.presentation',
                    size: 5242880,
                    sender_email: 'jane@example.com',
                    sender_name: 'Jane Smith',
                    received_at: new Date(Date.now() - 259200000).toISOString(),
                    preview_generated: false
                }
            ];
        }

        function getMockSenderData() {
            return [
                {
                    sender_email: 'john@example.com',
                    sender_name: 'John Doe',
                    attachment_count: 2
                },
                {
                    sender_email: 'jane@example.com',
                    sender_name: 'Jane Smith',
                    attachment_count: 2
                },
                {
                    sender_email: 'finance@example.com',
                    sender_name: 'Finance Team',
                    attachment_count: 1
                }
            ];
        }
    </script>
</body>
</html>
