<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frame Email Client</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f0f2f5;
            color: #1c1e21;
        }

        /* Login Screen Styles */
        .login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .login-container {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 400px;
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-header h1 {
            color: #1877f2;
            font-size: 32px;
            margin-bottom: 8px;
        }

        .login-header p {
            color: #65676b;
            font-size: 16px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #1c1e21;
        }

        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #dadde1;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #1877f2;
        }

        .login-btn {
            width: 100%;
            padding: 12px;
            background: #1877f2;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .login-btn:hover {
            background: #166fe5;
        }

        .login-btn:disabled {
            background: #dadde1;
            cursor: not-allowed;
        }

        .settings-link {
            text-align: center;
            margin-top: 16px;
        }

        .demo-notice {
            background: #fff3cd;
            color: #856404;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #ffc107;
            font-size: 14px;
        }

        .error-message, .success-message {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid;
            display: none;
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            border-color: #c62828;
        }

        .success-message {
            background: #e8f5e8;
            color: #2e7d32;
            border-color: #2e7d32;
        }

        /* Main App Styles */
        .main-app {
            display: none;
        }

        .main-app.active {
            display: block;
        }

        .header {
            background: white;
            border-bottom: 1px solid #dadde1;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: #1877f2;
        }

        .search-bar {
            flex: 1;
            max-width: 400px;
            margin: 0 20px;
        }

        .search-bar input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #dadde1;
            border-radius: 20px;
            background: #f0f2f5;
            outline: none;
        }

        .compose-btn {
            background: #1877f2;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }

        .compose-btn:hover {
            background: #166fe5;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .logout-btn {
            background: #e4e6ea;
            color: #1c1e21;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }

        .container {
            display: flex;
            max-width: 1200px;
            margin: 20px auto;
            gap: 20px;
            padding: 0 20px;
        }

        .sidebar {
            width: 240px;
            background: white;
            border-radius: 8px;
            padding: 12px;
            height: fit-content;
            position: sticky;
            top: 80px;
        }

        .folder-item {
            padding: 10px 12px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .folder-item:hover {
            background: #f0f2f5;
        }

        .folder-item.active {
            background: #e7f3ff;
            color: #1877f2;
            font-weight: 500;
        }

        .unread-count {
            background: #1877f2;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
        }

        .main-content {
            flex: 1;
        }

        .conversation {
            background: white;
            border-radius: 8px;
            margin-bottom: 4px;
            padding: 12px 16px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: box-shadow 0.2s;
        }

        .conversation:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .conversation-line {
            display: flex;
            gap: 12px;
            justify-content: space-between;
            align-items: flex-start;
        }

        .timestamp {
            color: #65676b;
            font-size: 13px;
            white-space: nowrap;
        }

        .conversation-info {
            flex: 1;
            min-width: 0;
        }

        .subject-line {
            font-size: 14px;
            font-weight: 600;
            color: #050505;
            margin-bottom: 4px;
        }

        .content-snippet {
            color: #65676b;
            font-size: 13px;
            line-height: 1.4;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .conversation-actions-hover {
            display: none;
            gap: 8px;
            margin-left: 12px;
        }

        .conversation:hover .conversation-actions-hover {
            display: flex;
        }

        .icon-btn {
            background: #f0f2f5;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: background 0.2s;
        }

        .icon-btn:hover {
            background: #e4e6eb;
        }

        /* Slideover Panel */
        .slideover-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            display: none;
        }

        .slideover-overlay.active {
            display: block;
        }

        .slideover-panel {
            position: fixed;
            top: 0;
            right: -600px;
            width: 600px;
            height: 100%;
            background: white;
            box-shadow: -2px 0 8px rgba(0,0,0,0.15);
            transition: right 0.3s ease;
            z-index: 1001;
            display: flex;
            flex-direction: column;
        }

        .slideover-overlay.active .slideover-panel {
            right: 0;
        }

        .slideover-header {
            padding: 20px;
            border-bottom: 1px solid #e4e6eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .slideover-header h2 {
            font-size: 18px;
            color: #1c1e21;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #65676b;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            background: #f0f2f5;
        }

        .slideover-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .chat-message {
            margin-bottom: 20px;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .message-sender {
            font-weight: 600;
            color: #050505;
        }

        .message-time {
            color: #65676b;
            font-size: 13px;
        }

        .message-body {
            background: #f0f2f5;
            padding: 12px 16px;
            border-radius: 12px;
            line-height: 1.5;
            color: #1c1e21;
        }

        .slideover-footer {
            padding: 20px;
            border-top: 1px solid #e4e6eb;
        }

        .reply-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .reply-box {
            display: flex;
            gap: 8px;
        }

        .reply-box textarea {
            flex: 1;
            padding: 12px;
            border: 1px solid #dadde1;
            border-radius: 20px;
            resize: none;
            font-family: inherit;
            font-size: 14px;
            min-height: 44px;
            max-height: 120px;
        }

        .reply-box textarea:focus {
            outline: none;
            border-color: #1877f2;
        }

        .send-btn {
            background: #1877f2;
            color: white;
            border: none;
            padding: 0 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 500;
        }

        .send-btn:hover {
            background: #166fe5;
        }

        .unread {
            border-left: 3px solid #1877f2;
        }

        .loading, .empty-state {
            text-align: center;
            padding: 40px;
            color: #65676b;
        }

        .empty-state h3 {
            margin-bottom: 8px;
            color: #1c1e21;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10000;
            animation: slideIn 0.3s ease;
        }

        .notification.success {
            background: #28a745;
            color: white;
        }

        .notification.error {
            background: #dc3545;
            color: white;
        }

        .notification.info {
            background: #007bff;
            color: white;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .compose-modal {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .compose-modal h2 {
            margin-bottom: 20px;
            color: #1c1e21;
        }

        .compose-modal .form-group {
            margin-bottom: 15px;
        }

        .compose-modal textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #dadde1;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            min-height: 150px;
        }

        .compose-modal textarea:focus {
            outline: none;
            border-color: #1877f2;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .btn-secondary {
            padding: 10px 20px;
            border: 1px solid #dadde1;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }

        .btn-secondary:hover {
            background: #f0f2f5;
        }

        .btn-primary {
            padding: 10px 20px;
            background: #1877f2;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }

        .btn-primary:hover {
            background: #166fe5;
        }

        .btn-primary:disabled {
            background: #dadde1;
            cursor: not-allowed;
        }

        /* Attachment Gallery Styles */
        .gallery-container {
            display: none;
        }

        .gallery-container.active {
            display: block;
        }

        .gallery-header {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .gallery-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #1c1e21;
        }

        .gallery-controls {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
        }

        .view-mode-switcher {
            display: flex;
            gap: 4px;
            background: #f0f2f5;
            padding: 4px;
            border-radius: 8px;
        }

        .view-mode-btn {
            padding: 8px 16px;
            border: none;
            background: transparent;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            color: #65676b;
            transition: all 0.2s;
        }

        .view-mode-btn.active {
            background: white;
            color: #1877f2;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .view-mode-btn:hover:not(.active) {
            color: #1c1e21;
        }

        .gallery-search {
            flex: 1;
            min-width: 200px;
        }

        .gallery-search input {
            width: 100%;
            padding: 10px 16px;
            border: 1px solid #dadde1;
            border-radius: 8px;
            font-size: 14px;
        }

        .gallery-search input:focus {
            outline: none;
            border-color: #1877f2;
        }

        .filter-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .filter-select {
            padding: 8px 12px;
            border: 1px solid #dadde1;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 14px;
        }

        .filter-select:focus {
            outline: none;
            border-color: #1877f2;
        }

        /* Grid View */
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
        }

        .attachment-card {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .attachment-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }

        .attachment-thumbnail {
            width: 100%;
            height: 150px;
            background: #f0f2f5;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            position: relative;
            overflow: hidden;
        }

        .attachment-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .attachment-info {
            padding: 12px;
        }

        .attachment-filename {
            font-weight: 500;
            font-size: 14px;
            color: #1c1e21;
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .attachment-meta {
            font-size: 12px;
            color: #65676b;
            display: flex;
            justify-content: space-between;
        }

        /* Sender View */
        .sender-list {
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        .sender-group {
            border-bottom: 1px solid #e4e6eb;
        }

        .sender-group:last-child {
            border-bottom: none;
        }

        .sender-header {
            padding: 16px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            transition: background 0.2s;
        }

        .sender-header:hover {
            background: #f0f2f5;
        }

        .sender-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .sender-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #1877f2;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .sender-details h3 {
            font-size: 15px;
            font-weight: 600;
            color: #1c1e21;
            margin-bottom: 2px;
        }

        .sender-details p {
            font-size: 13px;
            color: #65676b;
        }

        .sender-count {
            background: #e7f3ff;
            color: #1877f2;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
        }

        .sender-attachments {
            padding: 16px;
            background: #f8f9fa;
            display: none;
        }

        .sender-group.expanded .sender-attachments {
            display: block;
        }

        .sender-group.expanded .sender-header::after {
            content: '▼';
        }

        .sender-header::after {
            content: '▶';
            color: #65676b;
            font-size: 12px;
        }

        .attachment-list-item {
            padding: 12px;
            background: white;
            border-radius: 6px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .attachment-list-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .attachment-icon {
            width: 48px;
            height: 48px;
            border-radius: 6px;
            background: #f0f2f5;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            flex-shrink: 0;
        }

        .attachment-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 6px;
        }

        .attachment-details {
            flex: 1;
            min-width: 0;
        }

        .attachment-details h4 {
            font-size: 14px;
            font-weight: 500;
            color: #1c1e21;
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .attachment-details p {
            font-size: 12px;
            color: #65676b;
        }

        /* Preview Modal */
        .preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .preview-modal.active {
            display: flex;
        }

        .preview-content {
            max-width: 90%;
            max-height: 90%;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .preview-header {
            padding: 16px 20px;
            border-bottom: 1px solid #e4e6eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .preview-header h3 {
            font-size: 16px;
            font-weight: 600;
            color: #1c1e21;
        }

        .preview-actions {
            display: flex;
            gap: 8px;
        }

        .preview-body {
            flex: 1;
            overflow: auto;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: #f8f9fa;
        }

        .preview-body img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .preview-metadata {
            padding: 16px 20px;
            border-top: 1px solid #e4e6eb;
            background: white;
        }

        .metadata-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 14px;
        }

        .metadata-label {
            color: #65676b;
            font-weight: 500;
        }

        .metadata-value {
            color: #1c1e21;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            margin-top: 20px;
        }

        .pagination button {
            padding: 8px 16px;
            border: 1px solid #dadde1;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }

        .pagination button:hover:not(:disabled) {
            background: #f0f2f5;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination span {
            color: #65676b;
            font-size: 14px;
        }

        /* Filter Buttons */
        .filter-btn {
            padding: 8px 16px;
            border: 1px solid #dadde1;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .filter-btn:hover {
            background: #f0f2f5;
        }

        .filter-btn.active {
            background: #1877f2;
            color: white;
            border-color: #1877f2;
        }

        /* Notifications */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-width: 400px;
        }

        .notification {
            background: white;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: start;
            gap: 12px;
            animation: slideIn 0.3s ease-out;
            border-left: 4px solid;
        }

        .notification.success {
            border-color: #4caf50;
        }

        .notification.error {
            border-color: #f44336;
        }

        .notification.info {
            border-color: #2196f3;
        }

        .notification.warning {
            border-color: #ff9800;
        }

        .notification-content {
            flex: 1;
            font-size: 14px;
        }

        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Settings Modal Styles */
        .settings-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .settings-modal-overlay.active {
            display: flex;
        }

        .settings-modal {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .settings-modal h2 {
            margin: 0 0 8px 0;
            font-size: 24px;
            color: #1c1e21;
        }

        .settings-modal .subtitle {
            color: #65676b;
            margin-bottom: 24px;
            font-size: 14px;
        }

        .settings-section {
            margin-bottom: 24px;
            padding-bottom: 24px;
            border-bottom: 1px solid #e4e6eb;
        }

        .settings-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .settings-section h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #1c1e21;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .form-group-small {
            margin-bottom: 12px;
        }

        .form-group-small label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            font-size: 14px;
            color: #1c1e21;
        }

        .form-group-small input,
        .form-group-small select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #dadde1;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .form-group-small input:focus,
        .form-group-small select:focus {
            outline: none;
            border-color: #1877f2;
        }

        .help-text {
            font-size: 12px;
            color: #65676b;
            margin-top: 4px;
        }

        .modal-footer {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid #e4e6eb;
        }

        .btn-link {
            background: none;
            border: none;
            color: #1877f2;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
            padding: 0;
        }

        .btn-link:hover {
            text-decoration: underline;
        }

        .settings-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
            padding: 12px;
            background: #f0f2f5;
            border-radius: 8px;
            cursor: pointer;
        }

        .settings-toggle input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .settings-toggle label {
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            margin: 0;
        }

        .collapsible-section {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Notification Container -->
    <div class="notification-container" id="notificationContainer"></div>

    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-container">
            <div class="login-header">
                <h1>📧 Frame</h1>
                <p>Modern Email Client</p>
            </div>
            
            <div class="demo-notice">
                <strong>Demo Mode:</strong> You can use any username/password to login and explore the features.
            </div>
            
            <div id="loginError" class="error-message"></div>
            <div id="loginSuccess" class="success-message"></div>
            
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Username or Email</label>
                    <input type="text" id="username" name="username" required>
                </div>
                
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password" required>
                </div>
                
                <button type="submit" class="login-btn" id="loginBtn">Sign In</button>
            </form>
            
            <div style="text-align: center; margin: 20px 0; color: #65676b; font-size: 14px;">
                <span>or</span>
            </div>
            
            <button type="button" class="login-btn" id="googleSignInBtn" style="background: white; color: #1c1e21; border: 2px solid #dadde1; display: flex; align-items: center; justify-content: center; gap: 12px;">
                <svg width="18" height="18" viewBox="0 0 18 18"><path fill="#4285F4" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z"/><path fill="#34A853" d="M9 18c2.43 0 4.467-.806 5.956-2.184l-2.908-2.258c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332C2.438 15.983 5.482 18 9 18z"/><path fill="#FBBC05" d="M3.964 10.707c-.18-.54-.282-1.117-.282-1.707 0-.593.102-1.17.282-1.709V4.958H.957C.347 6.173 0 7.548 0 9c0 1.452.348 2.827.957 4.042l3.007-2.335z"/><path fill="#EA4335" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0 5.482 0 2.438 2.017.957 4.958L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z"/></svg>
                Sign in with Google
            </button>
            
            <div class="settings-link">
                <button class="btn-link" onclick="openAccountSettingsModal()">⚙️ Create Account with Settings</button>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div class="main-app" id="mainApp">
        <div class="header">
            <div class="logo">📧 Frame</div>
            <div class="search-bar">
                <input type="text" placeholder="Search emails..." id="searchInput">
            </div>
            <div class="header-actions">
                <button class="compose-btn" id="gooseBtn" style="background: #10a37f;">🤖 Goose</button>
                <button class="compose-btn" id="composeBtn">Compose</button>
                <button class="compose-btn" id="debugBtn" style="background: #ff6b6b;">🔧 Debug</button>
                <button class="logout-btn" id="logoutBtn">Logout</button>
            </div>
        </div>

        <div class="container">
            <div class="sidebar" id="sidebar">
                <div class="loading">Loading folders...</div>
                <!-- Attachments tab will be added here -->
            </div>

            <div id="conversationList" style="flex: 1;">
                <div class="loading">Loading conversations...</div>
            </div>
            <div class="main-content" id="dynamicViewsContainer" style="flex: 1;"></div>
        </div>
    </div>


    <!-- Slideover Panel -->
    <div class="slideover-overlay" id="slideoverOverlay">
        <div class="slideover-panel">
            <div class="slideover-header">
                <h2 id="slideoverSubject">Conversation</h2>
                <button class="close-btn" onclick="closeSlideover()">×</button>
            </div>
            <div class="slideover-content" id="slideoverContent">
                <!-- Messages will be loaded here -->
            </div>
            <div class="slideover-footer">
                <div class="reply-actions">
                    <button class="btn-secondary" onclick="replyTo()">Reply</button>
                    <button class="btn-secondary" onclick="replyAll()">Reply All</button>
                    <button class="btn-secondary" onclick="forward()">Forward</button>
                </div>
                <div class="reply-box">
                    <textarea id="quickReplyText" placeholder="Write a reply..."></textarea>
                    <button class="send-btn" onclick="sendQuickReply()">Send</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Attachment Gallery -->
    <div class="container gallery-container" id="galleryContainer">
        <div class="main-content">
            <div class="gallery-header">
                <h1 class="gallery-title">📎 Attachments</h1>
                <div class="gallery-controls">
                    <div class="view-mode-switcher">
                        <button class="view-mode-btn active" data-mode="recents" onclick="switchGalleryView('recents')">Recents</button>
                        <button class="view-mode-btn" data-mode="sender" onclick="switchGalleryView('sender')">By Sender</button>
                        <button class="view-mode-btn" data-mode="list" onclick="switchGalleryView('list')">List</button>
                    </div>
                    <div class="gallery-search">
                        <input type="text" id="gallerySearchInput" placeholder="Search attachments..." oninput="searchAttachments()">
                    </div>
                    <div class="filter-group">
                        <select class="filter-select" id="filterDate" onchange="applyFilters()">
                            <option value="">All Time</option>
                            <option value="today">Today</option>
                            <option value="week">Last 7 Days</option>
                            <option value="month">Last 30 Days</option>
                        </select>
                        <select class="filter-select" id="filterType" onchange="applyFilters()">
                            <option value="">All Types</option>
                            <option value="image">Images</option>
                            <option value="pdf">PDFs</option>
                            <option value="document">Documents</option>
                            <option value="spreadsheet">Spreadsheets</option>
                            <option value="archive">Archives</option>
                        </select>
                        <select class="filter-select" id="filterSize" onchange="applyFilters()">
                            <option value="">All Sizes</option>
                            <option value="small">Small (&lt;1MB)</option>
                            <option value="medium">Medium (1-10MB)</option>
                            <option value="large">Large (&gt;10MB)</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Recents View -->
            <div id="recentsView" class="gallery-grid">
                <div class="loading">Loading attachments...</div>
            </div>

            <!-- Sender View -->
            <div id="senderView" class="sender-list" style="display: none;">
                <div class="loading">Loading attachments...</div>
            </div>

            <!-- List View -->
            <div id="listView" style="display: none;">
                <div class="loading">Loading attachments...</div>
            </div>

            <!-- Pagination -->
            <div class="pagination" id="galleryPagination" style="display: none;">
                <button onclick="previousPage()">Previous</button>
                <span id="pageInfo">Page 1</span>
                <button onclick="nextPage()">Next</button>
            </div>
        </div>
    </div>

    <!-- Preview Modal -->
    <div class="preview-modal" id="previewModal">
        <div class="preview-content" style="width: 800px; max-height: 90vh;">
            <!-- Preview content will be dynamically loaded -->
        </div>
    </div>

    <!-- Account Settings Modal -->
    <div class="settings-modal-overlay" id="accountSettingsModal">
        <div class="settings-modal">
            <h2>Create New Account</h2>
            <p class="subtitle">Configure your email and AI settings to create a new account</p>
            
            <form id="accountSettingsForm">
                <!-- Account Credentials -->
                <div class="settings-section">
                    <h3>Account Credentials</h3>
                    <div class="form-group-small">
                        <label>Email Address *</label>
                        <input type="email" id="new-email" name="email" required placeholder="your.email@example.com">
                    </div>
                    <div class="form-group-small">
                        <label>Password *</label>
                        <input type="password" id="new-password" name="password" required placeholder="Enter password">
                    </div>
                </div>

                <!-- Email Server Settings -->
                <div class="settings-section">
                    <h3>Email Server Settings</h3>
                    <div class="form-row">
                        <div class="form-group-small">
                            <label>IMAP Host *</label>
                            <input type="text" id="new-imap-host" name="imap_host" required placeholder="imap.gmail.com">
                        </div>
                        <div class="form-group-small">
                            <label>IMAP Port *</label>
                            <input type="number" id="new-imap-port" name="imap_port" required placeholder="993" value="993">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group-small">
                            <label>SMTP Host *</label>
                            <input type="text" id="new-smtp-host" name="smtp_host" required placeholder="smtp.gmail.com">
                        </div>
                        <div class="form-group-small">
                            <label>SMTP Port *</label>
                            <input type="number" id="new-smtp-port" name="smtp_port" required placeholder="587" value="587">
                        </div>
                    </div>
                    <p class="help-text">
                        For Gmail: IMAP: imap.gmail.com:993, SMTP: smtp.gmail.com:587<br>
                        For Outlook: IMAP: outlook.office365.com:993, SMTP: smtp.office365.com:587
                    </p>
                </div>

                <!-- AI/LLM Settings -->
                <div class="settings-section">
                    <h3>AI Agent Settings</h3>
                    <div class="settings-toggle">
                        <input type="checkbox" id="enable-ai" onchange="toggleAISettings(this.checked)">
                        <label for="enable-ai">Enable AI features (Goose Chat, Automations)</label>
                    </div>
                    
                    <div id="ai-settings-section" class="collapsible-section">
                        <div class="form-group-small">
                            <label>LLM Provider *</label>
                            <select id="new-llm-provider" name="llm_provider" onchange="updateModelPlaceholder()">
                                <option value="anthropic">Anthropic (Claude)</option>
                                <option value="openai">OpenAI (GPT)</option>
                                <option value="databricks">Databricks</option>
                                <option value="local">Local GGUF</option>
                            </select>
                        </div>
                        <div class="form-group-small">
                            <label>API Key *</label>
                            <input type="password" id="new-api-key" name="api_key" placeholder="sk-ant-...">
                            <p class="help-text">Your API key will be stored securely and encrypted</p>
                        </div>
                        <div class="form-group-small">
                            <label>Model ID *</label>
                            <input type="text" id="new-model-id" name="model_id" placeholder="claude-3-5-sonnet-20241022">
                            <p class="help-text" id="model-help-text">
                                Recommended: claude-3-5-sonnet-20241022 for best performance
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Optional: Calendar Settings -->
                <div class="settings-section">
                    <h3>Calendar Integration (Optional)</h3>
                    <div class="settings-toggle">
                        <input type="checkbox" id="enable-calendar" onchange="toggleCalendarSettings(this.checked)">
                        <label for="enable-calendar">Enable calendar sync</label>
                    </div>
                    
                    <div id="calendar-settings-section" class="collapsible-section">
                        <div class="form-group-small">
                            <label>CalDAV Server URL</label>
                            <input type="text" id="new-caldav-url" name="caldav_url" placeholder="https://caldav.example.com">
                        </div>
                        <div class="form-row">
                            <div class="form-group-small">
                                <label>Username</label>
                                <input type="text" id="new-caldav-username" name="caldav_username" placeholder="username">
                            </div>
                            <div class="form-group-small">
                                <label>Password</label>
                                <input type="password" id="new-caldav-password" name="caldav_password" placeholder="password">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeAccountSettingsModal()">Cancel</button>
                    <button type="submit" class="btn-primary" id="createAccountBtn">Create Account</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Debug Modal -->
    <div class="settings-modal-overlay" id="debugModal">
        <div class="settings-modal">
            <div class="settings-modal-header">
                <h2>🔧 Sync Debug Information</h2>
                <button class="close-btn" onclick="closeDebugModal()">×</button>
            </div>
            <div class="settings-modal-body" style="max-height: 70vh; overflow-y: auto;">
                <div id="debugContent">
                    <div style="text-align: center; padding: 40px;">
                        <div class="spinner"></div>
                        <p>Loading debug information...</p>
                    </div>
                </div>
            </div>
            <div class="settings-modal-footer">
                <button type="button" class="btn-primary" onclick="testImapConnection()">Test IMAP</button>
                <button type="button" class="btn-primary" onclick="triggerManualSync()">Manual Sync</button>
                <button type="button" class="btn-secondary" onclick="closeDebugModal()">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let authToken = null;
        let currentFolder = 'INBOX';
        let conversations = [];
        let folders = [];
        let currentConversation = null;

        // Gallery state
        let currentView = 'recents';
        let attachments = [];
        let filteredAttachments = [];
        let currentPage = 1;
        let pageSize = 20;

        // ===== ERROR HANDLING HELPERS (MUST BE DEFINED EARLY) =====
        
        // Check if user is authenticated with real account
        function isRealAccount() {
            return authToken && authToken !== 'demo-token';
        }

        // Show feature unavailable message
        function showFeatureUnavailable(featureName) {
            showNotification(`${featureName} requires a real email account. Please register or login with valid credentials.`, 'info');
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
        });

        function initializeApp() {
            authToken = localStorage.getItem('auth_token');
            if (authToken) {
                showMainApp();
                loadFolders();
                loadConversations();
            } else {
                // Try auto-login first
                checkAutoLogin().then(autoLoggedIn => {
                    if (!autoLoggedIn) {
                        showLoginScreen();
                    }
                }).catch(e => {
                    console.error('Auto-login check failed:', e);
                    showLoginScreen();
                });
            }
            
            setupEventListeners();
        }

        // ===== ACCOUNT SETTINGS MODAL =====
        function openAccountSettingsModal() {
            document.getElementById('accountSettingsModal').classList.add('active');
        }

        function closeAccountSettingsModal() {
            document.getElementById('accountSettingsModal').classList.remove('active');
        }

        function toggleAISettings(enabled) {
            const section = document.getElementById('ai-settings-section');
            if (enabled) {
                section.style.display = 'block';
                section.querySelectorAll('input, select').forEach(el => el.required = true);
            } else {
                section.style.display = 'none';
                section.querySelectorAll('input, select').forEach(el => el.required = false);
            }
        }

        function toggleCalendarSettings(enabled) {
            const section = document.getElementById('calendar-settings-section');
            section.style.display = enabled ? 'block' : 'none';
        }

        function updateModelPlaceholder() {
            const provider = document.getElementById('new-llm-provider').value;
            const modelInput = document.getElementById('new-model-id');
            const helpText = document.getElementById('model-help-text');
            
            const placeholders = {
                'anthropic': {
                    placeholder: 'claude-3-5-sonnet-20241022',
                    help: 'Recommended: claude-3-5-sonnet-20241022 for best performance'
                },
                'openai': {
                    placeholder: 'gpt-4-turbo-preview',
                    help: 'Recommended: gpt-4-turbo-preview or gpt-3.5-turbo'
                },
                'databricks': {
                    placeholder: 'databricks-meta-llama-3-1-70b-instruct',
                    help: 'Enter your Databricks model endpoint'
                },
                'local': {
                    placeholder: 'path/to/model.gguf',
                    help: 'Path to your local GGUF model file'
                }
            };
            
            const config = placeholders[provider] || placeholders['anthropic'];
            modelInput.placeholder = config.placeholder;
            helpText.textContent = config.help;
        }

        // Handle account creation form submission
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('accountSettingsForm');
            if (form) {
                form.addEventListener('submit', handleAccountCreation);
            }
        });

        async function handleAccountCreation(e) {
            e.preventDefault();
            
            const createBtn = document.getElementById('createAccountBtn');
            const originalText = createBtn.textContent;
            createBtn.disabled = true;
            createBtn.textContent = 'Creating Account...';
            
            const formData = new FormData(e.target);
            const aiEnabled = document.getElementById('enable-ai').checked;
            const calendarEnabled = document.getElementById('enable-calendar').checked;
            
            // Build account data
            const accountData = {
                email: formData.get('email'),
                password: formData.get('password'),
                imap_host: formData.get('imap_host'),
                imap_port: parseInt(formData.get('imap_port')),
                smtp_host: formData.get('smtp_host'),
                smtp_port: parseInt(formData.get('smtp_port'))
            };
            
            // Add AI settings if enabled
            if (aiEnabled) {
                accountData.llm_provider = formData.get('llm_provider');
                accountData.api_key = formData.get('api_key');
                accountData.model_id = formData.get('model_id');
            }
            
            // Add calendar settings if enabled
            if (calendarEnabled) {
                accountData.caldav_url = formData.get('caldav_url');
                accountData.caldav_username = formData.get('caldav_username');
                accountData.caldav_password = formData.get('caldav_password');
            }
            
            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(accountData)
                });
                
                if (response.ok) {
                    const data = await response.json();
                    authToken = data.token;
                    localStorage.setItem('auth_token', authToken);
                    localStorage.setItem('user', JSON.stringify(data.user || { email: accountData.email }));
                    
                    showNotification('Account created successfully!', 'success');
                    closeAccountSettingsModal();
                    
                    setTimeout(() => {
                        showMainApp();
                        loadFolders();
                        loadConversations();
                    }, 1000);
                } else {
                    const error = await response.json();
                    showNotification(error.message || 'Failed to create account', 'error');
                }
            } catch (error) {
                console.error('Account creation error:', error);
                showNotification('Failed to create account. Please check your settings and try again.', 'error');
            } finally {
                createBtn.disabled = false;
                createBtn.textContent = originalText;
            }
        }

        // Close modal when clicking outside
        document.getElementById('accountSettingsModal')?.addEventListener('click', (e) => {
            if (e.target.id === 'accountSettingsModal') {
                closeAccountSettingsModal();
            }
        });

        // Keyboard shortcut to close modal
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const modal = document.getElementById('accountSettingsModal');
                if (modal && modal.classList.contains('active')) {
                    closeAccountSettingsModal();
                }
            }
        });

        // ===== END ACCOUNT SETTINGS MODAL =====

        function showLoginScreen() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainApp').classList.remove('active');
            
            // Check for OAuth redirect parameters
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            const email = urlParams.get('email');
            const oauthSuccess = urlParams.get('oauth_success');
            const error = urlParams.get('error');
            const errorMessage = urlParams.get('message');
            
            // Handle OAuth errors
            if (error) {
                let displayMessage = 'Authentication failed';
                if (error === 'email_init_failed') {
                    displayMessage = 'Failed to initialize email services. Please try again.';
                    if (errorMessage) {
                        displayMessage += ': ' + decodeURIComponent(errorMessage);
                    }
                }
                showNotification(displayMessage, 'error');
                // Clean up URL
                window.history.replaceState({}, document.title, '/');
                return;
            }
            
            // Handle successful OAuth login
            if (token && email) {
                // Store token and redirect to main app
                authToken = token;
                localStorage.setItem('auth_token', authToken);
                localStorage.setItem('user', JSON.stringify({ email }));
                
                // Show success message
                if (oauthSuccess) {
                    showNotification('Successfully signed in with Google! Your emails are being synced...', 'success');
                }
                
                // Clean up URL
                window.history.replaceState({}, document.title, '/');
                
                showMainApp();
                loadFolders();
                
                // Load conversations (sync is happening in background on backend)
                loadConversations();
            }
        }

        // Google Sign In Handler
        document.addEventListener('DOMContentLoaded', () => {
            const googleSignInBtn = document.getElementById('googleSignInBtn');
            if (googleSignInBtn) {
                googleSignInBtn.addEventListener('click', handleGoogleSignIn);
            }
        });

        async function handleGoogleSignIn() {
            try {
                console.log('Fetching Google auth URL...');
                const response = await fetch('/auth/google');
                console.log('Response status:', response.status);
                const text = await response.text();
                console.log('Response text:', text);
                const data = JSON.parse(text);
                console.log('Parsed data:', data);
                window.location.href = data.auth_url;
            } catch (error) {
                console.error('Google sign in error:', error);
                showNotification('Failed to initiate Google sign in', 'error');
            }
        }
        
        // Auto-login if single user exists (desktop app mode)
        async function checkAutoLogin() {
            try {
                // Check if we already have a token
                const existingToken = localStorage.getItem('auth_token');
                if (existingToken) {
                    return true; // Already logged in
                }
                
                // Try to get single user auto-login
                const response = await fetch('/auth/auto-login');
                if (response.ok) {
                    const data = await response.json();
                    if (data.token && data.user) {
                        // Auto-login successful
                        authToken = data.token;
                        localStorage.setItem('auth_token', authToken);
                        localStorage.setItem('user', JSON.stringify(data.user));
                        
                        console.log('Auto-login successful for:', data.user.email);
                        
                        // Show main app
                        document.getElementById('loginScreen').style.display = 'none';
                        document.getElementById('mainApp').classList.add('active');
                        
                        // Load initial data
                        loadFolders();
                        loadConversations();
                        return true;
                    }
                }
            } catch (e) {
                console.log('Auto-login not available:', e);
            }
            return false;
        }

        // Manual sync trigger
        async function triggerManualSync() {
            showNotification('Starting email sync...', 'info');
            try {
                const response = await fetch('/api/debug/manual-sync', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (response.ok) {
                    showNotification('Email sync completed!', 'success');
                    loadConversations();
                } else {
                    showNotification('Sync failed. Please try again.', 'error');
                }
            } catch (error) {
                showNotification('Sync error: ' + error.message, 'error');
            }
        }

        function showMainApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').classList.add('active');
        }

        function setupEventListeners() {
            document.getElementById('loginForm')?.addEventListener('submit', handleLogin);
            document.getElementById('composeBtn')?.addEventListener('click', openComposeModal);
            document.getElementById('gooseBtn')?.addEventListener('click', openGooseChat);
            document.getElementById('logoutBtn')?.addEventListener('click', handleLogout);
            document.getElementById('debugBtn')?.addEventListener('click', openDebugModal);
            document.getElementById('searchInput')?.addEventListener('input', debounce(handleSearch, 500));
        }

        async function handleLogin(e) {
            e.preventDefault();
            
            const loginBtn = document.getElementById('loginBtn');
            const errorDiv = document.getElementById('loginError');
            const successDiv = document.getElementById('loginSuccess');
            
            loginBtn.disabled = true;
            loginBtn.textContent = 'Signing in...';
            errorDiv.style.display = 'none';
            successDiv.style.display = 'none';
            
            const formData = new FormData(e.target);
            const username = formData.get('username');
            const password = formData.get('password');
            
            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    authToken = data.token || 'demo-token';
                    localStorage.setItem('auth_token', authToken);
                    localStorage.setItem('user', JSON.stringify(data.user || { username, email: username }));
                    
                    successDiv.textContent = 'Login successful!';
                    successDiv.style.display = 'block';
                    
                    setTimeout(() => {
                        showMainApp();
                        loadFolders();
                        loadConversations();
                    }, 1000);
                } else {
                    throw new Error('Login failed');
                }
            } catch (error) {
                // Demo mode fallback
                console.log('Using demo mode');
                authToken = 'demo-token';
                localStorage.setItem('auth_token', authToken);
                localStorage.setItem('user', JSON.stringify({ username, email: username }));
                
                successDiv.textContent = 'Demo login successful!';
                successDiv.style.display = 'block';
                
                setTimeout(() => {
                    showMainApp();
                    loadFolders();
                    loadConversations();
                }, 1000);
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'Sign In';
            }
        }

        function handleLogout() {
            localStorage.removeItem('auth_token');
            localStorage.removeItem('user');
            authToken = null;
            showLoginScreen();
        }

        async function loadFolders() {
            try {
                const response = await fetch('/api/folders', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    folders = await response.json();
                } else {
                    folders = getMockFolders();
                }
            } catch (error) {
                folders = getMockFolders();
            }
            
            renderFolders();
        }

        function renderFolders() {
            const sidebar = document.getElementById('sidebar');
            sidebar.innerHTML = '';
            
            
            folders.forEach(folder => {
                const folderItem = document.createElement('div');
                folderItem.className = 'folder-item' + (folder.id === currentFolder ? ' active' : '');
                folderItem.innerHTML = `
                    <span>${folder.name}</span>
                    ${folder.unread_count > 0 ? `<span class="unread-count">${folder.unread_count}</span>` : ''}
                `;
                folderItem.addEventListener('click', () => selectFolder(folder.name));
                sidebar.appendChild(folderItem);
            });

            // Add Attachments tab
            const attachmentsTab = document.createElement('div');
            attachmentsTab.className = 'folder-item';
            attachmentsTab.innerHTML = `
                <span>📎 Attachments</span>
            `;
            attachmentsTab.addEventListener('click', (e) => showAttachmentGallery(e));
            sidebar.appendChild(attachmentsTab);

            // Add separator
            const separator = document.createElement('div');
            separator.style.borderTop = '1px solid #e4e6eb';
            separator.style.margin = '8px 0';
            sidebar.appendChild(separator);

            // Add Chat/Goose tab
            const chatTab = document.createElement('div');
            chatTab.className = 'folder-item';
            chatTab.innerHTML = `<span>🤖 Goose Chat</span>`;
            chatTab.addEventListener('click', (e) => showChatView(e));
            sidebar.appendChild(chatTab);

            // Add Automations tab
            const automationsTab = document.createElement('div');
            automationsTab.className = 'folder-item';
            automationsTab.innerHTML = `<span>⚙️ Automations</span>`;
            automationsTab.addEventListener('click', (e) => showAutomationsView(e));
            sidebar.appendChild(automationsTab);

            // Add Reminders tab
            const remindersTab = document.createElement('div');
            remindersTab.className = 'folder-item';
            remindersTab.innerHTML = `<span>✓ Reminders</span>`;
            remindersTab.addEventListener('click', (e) => showRemindersView(e));
            sidebar.appendChild(remindersTab);

            // Add Calendar tab
            const calendarTab = document.createElement('div');
            calendarTab.className = 'folder-item';
            calendarTab.innerHTML = `<span>📅 Calendar</span>`;
            calendarTab.addEventListener('click', (e) => showCalendarView(e));
            sidebar.appendChild(calendarTab);

            // Add Money tab
            const moneyTab = document.createElement('div');
            moneyTab.className = 'folder-item';
            moneyTab.innerHTML = `<span>💰 Money</span>`;
            moneyTab.addEventListener('click', (e) => showMoneyView(e));
            sidebar.appendChild(moneyTab);

            // Add Settings tab
            const settingsTab = document.createElement('div');
            settingsTab.className = 'folder-item';
            settingsTab.innerHTML = `<span>⚙️ Settings</span>`;
            settingsTab.addEventListener('click', (e) => showSettingsView(e));
            sidebar.appendChild(settingsTab);
        }

        function selectFolder(folderId) {
            currentFolder = folderId;
            
            // Hide all special views
            hideAttachmentGallery();
            hideAllViews();
            
            // Show conversation list for email folders
            document.getElementById('conversationList').style.display = 'block';
            
            // Update active state
            document.querySelectorAll('.folder-item').forEach(f => f.classList.remove('active'));
            event.target.closest('.folder-item').classList.add('active');
            loadConversations();
        }

        async function loadConversations() {
            const container = document.getElementById('conversationList');
            container.innerHTML = '<div class="loading">Loading conversations...</div>';
            
            try {
                const response = await fetch(`/api/conversations?folder=${currentFolder}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    conversations = await response.json();
                    
                    // If no conversations found and user just logged in, show helpful message
                    if (conversations.length === 0) {
                        container.innerHTML = `
                            <div style="padding: 20px; text-align: center; color: #65676b;">
                                <p>No emails found. Syncing your inbox...</p>
                                <button onclick="triggerManualSync()" style="margin-top: 10px; padding: 8px 16px; background: #1877f2; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                    Sync Now
                                </button>
                            </div>
                        `;
                        return;
                    }
                } else {
                    conversations = getMockConversations();
                }
            } catch (error) {
                conversations = getMockConversations();
            }
            
            renderConversations();
        }

        function renderConversations() {
            const container = document.getElementById('conversationList');
            
            if (conversations.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>No conversations found</h3></div>';
                return;
            }
            
            container.innerHTML = '';
            conversations.forEach(conv => {
                const convEl = createConversationElement(conv);
                container.appendChild(convEl);
            });
        }

        function createConversationElement(conv) {
            const div = document.createElement('div');
            div.className = `conversation ${conv.unread_count > 0 ? 'unread' : ''}`;
            
            // Add special styling for chat and automation conversations
            if (conv.conversation_type === 'chat') {
                div.style.borderLeft = '4px solid #10a37f';
            } else if (conv.conversation_type === 'automation') {
                div.style.borderLeft = '4px solid #ff9800';
            }
            
            div.innerHTML = `
                <div class="conversation-line">
                    <div class="conversation-info">
                        ${conv.icon ? `<span style="font-size: 20px; margin-right: 8px;">${conv.icon}</span>` : ''}
                        <div class="subject-line">${escapeHtml(conv.subject)}</div>
                        <div class="content-snippet">${escapeHtml(conv.preview)}</div>
                    </div>
                    <div class="conversation-actions-hover">
                        <button class="icon-btn" onclick="event.stopPropagation(); replyAllDirect('${conv.id}')" title="Reply All">↩️</button>
                        <button class="icon-btn" onclick="event.stopPropagation(); toggleStar('${conv.id}')" title="Star">⭐</button>
                        <button class="icon-btn" onclick="event.stopPropagation(); moveConversation('${conv.id}')" title="Move">📁</button>
                        <button class="icon-btn" onclick="event.stopPropagation(); deleteConv('${conv.id}')" title="Delete">🗑️</button>
                    </div>
                    <div class="timestamp">${formatDate(conv.last_message_date)}</div>
                </div>
            `;
            
            // Add context menu
            div.addEventListener('contextmenu', (e) => showContextMenu(e, conv));
            div.addEventListener('click', () => {
                if (conv.conversation_type === 'chat' || conv.conversation_type === 'automation') {
                    // Open the chat interface directly with the conversation ID
                    openChatConversationFromInbox(conv.id);
                } else {
                    openSlideover(conv);
                }
            });
            
            return div;
        }

        function openChatConversationFromInbox(conversationId) {
            // Hide inbox and show chat interface
            hideAllViews();
            document.getElementById('conversationList').style.display = 'none';
            
            // Update sidebar to show chat as active
            document.querySelectorAll('.folder-item').forEach(f => f.classList.remove('active'));
            
            // Open the chat interface
            openChatConversation(conversationId);
        }

        function showContextMenu(e, conv) {
            e.preventDefault();
            
            // Remove any existing context menu
            const existing = document.querySelector('.context-menu');
            if (existing) existing.remove();
            
            const menu = document.createElement('div');
            menu.className = 'context-menu';
            menu.style.cssText = `
                position: fixed;
                left: ${e.clientX}px;
                top: ${e.clientY}px;
                background: white;
                border: 1px solid #dadde1;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                min-width: 200px;
            `;
            
            const menuItems = [
                { label: '🤖 Ask Goose about this', action: () => askGooseAboutEmail(conv) },
                { label: '↩️ Reply', action: () => replyAllDirect(conv.id) },
                { label: '⭐ Star', action: () => toggleStar(conv.id) },
                { label: '📁 Move', action: () => moveConversation(conv.id) },
                { label: '🗑️ Delete', action: () => deleteConv(conv.id) },
            ];
            
            menuItems.forEach(item => {
                const menuItem = document.createElement('div');
                menuItem.textContent = item.label;
                menuItem.style.cssText = 'padding: 12px 16px; cursor: pointer; transition: background 0.2s;';
                menuItem.onmouseover = () => menuItem.style.background = '#f0f2f5';
                menuItem.onmouseout = () => menuItem.style.background = 'white';
                menuItem.onclick = () => {
                    item.action();
                    menu.remove();
                };
                menu.appendChild(menuItem);
            });
            
            document.body.appendChild(menu);
            
            // Close menu on click outside
            setTimeout(() => {
                document.addEventListener('click', () => menu.remove(), { once: true });
            }, 0);
        }

        async function askGooseAboutEmail(conv) {
            // Create a new chat with context about the email
            const response = await fetch('/api/chat/conversations', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${authToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ title: `Chat about: ${conv.subject}` })
            });
            const data = await response.json();
            if (data.id) {
                // Send initial message with email context
                await fetch(`/api/chat/conversations/${data.id}/messages`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        content: `I need help with this email:\n\nSubject: ${conv.subject}\n\nCan you help me understand it and suggest a response?`
                    })
                });
                showChatView(data.id);
            }
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const diffHours = Math.floor((now - date) / (1000 * 60 * 60));
            
            if (diffHours < 1) return 'Just now';
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffHours < 48) return 'Yesterday';
            return date.toLocaleDateString();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Notification System
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notificationContainer');
            if (!container) return;
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            const icons = {
                success: '✓',
                error: '✗',
                info: 'ℹ',
                warning: '⚠'
            };
            
            notification.innerHTML = `
                <div style="font-size: 20px;">${icons[type] || icons.info}</div>
                <div class="notification-content">${escapeHtml(message)}</div>
                <button onclick="this.parentElement.remove()" style="background: none; border: none; cursor: pointer; font-size: 18px; color: #65676b;">×</button>
            `;
            
            container.appendChild(notification);
            
            // Auto-dismiss after 3 seconds
            setTimeout(() => {
                notification.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 300);
            }, 3000);
        }

        // Handle API errors gracefully  
        function handleApiError(error, context, response = null) {
            console.error(`${context} error:`, error);
            if (response) {
                if (response.status === 401) {
                    showNotification('Please login to access this feature', 'error');
                } else if (response.status === 404) {
                    showNotification('This feature is not available yet', 'info');
                } else {
                    showNotification(`${context} is currently unavailable`, 'error');
                }
            } else {
                showNotification(`${context} is currently unavailable`, 'error');
            }
        }

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        async function handleSearch(e) {
            const query = e.target.value.toLowerCase();
            if (!query) {
                renderConversations();
                return;
            }
            
            // Try API search first
            try {
                const response = await fetch(`/api/search?q=${encodeURIComponent(query)}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const results = await response.json();
                    if (results.emails && results.emails.length > 0) {
                        // Convert search results to conversation format and display
                        displaySearchResults(results.emails);
                        return;
                    }
                }
            } catch (error) {
                console.log('API search failed, using local filter:', error);
            }
            
            // Fallback to local filtering
            const filtered = conversations.filter(conv => 
                conv.subject.toLowerCase().includes(query) ||
                conv.preview.toLowerCase().includes(query) ||
                conv.participants.some(p => p.toLowerCase().includes(query))
            );
            
            const container = document.getElementById('conversationList');
            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>No results found</h3></div>';
                return;
            }
            
            container.innerHTML = '';
            filtered.forEach(conv => {
                const convEl = createConversationElement(conv);
                container.appendChild(convEl);
            });
        }

        function displaySearchResults(emails) {
            const container = document.getElementById('conversationList');
            if (emails.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>No results found</h3></div>';
                return;
            }
            
            container.innerHTML = '';
            emails.forEach(email => {
                // Convert email to conversation format
                const conv = {
                    id: email.id,
                    subject: email.subject,
                    preview: email.body_text?.substring(0, 100) || '',
                    participants: [email.from_address],
                    date: email.date,
                    unread: !email.is_read
                };
                const convEl = createConversationElement(conv);
                container.appendChild(convEl);
            });
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.remove(), 3000);
        }

        // Action functions - NOW FULLY IMPLEMENTED
        async function openGooseChat() {
            try {
                const response = await fetch('/api/chat/conversations', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ title: 'New Chat' })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.id) {
                        showChatView(data.id);
                    }
                } else if (response.status === 401) {
                    showNotification('Please login to use Goose Chat', 'error');
                } else {
                    showNotification('Unable to start chat. Please try again later.', 'error');
                }
            } catch (error) {
                console.error('Goose Chat error:', error);
                showNotification('Chat service is currently unavailable', 'error');
            }
        }

        function openComposeModal(options = {}) {
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            
            const modal = document.createElement('div');
            modal.className = 'compose-modal';
            modal.innerHTML = `
                <h2>Compose Email</h2>
                <form id="composeForm">
                    <div class="form-group">
                        <label>To:</label>
                        <input type="text" name="to" value="${options.to || ''}" required>
                    </div>
                    <div class="form-group">
                        <label>Subject:</label>
                        <input type="text" name="subject" value="${options.subject || ''}" required>
                    </div>
                    <div class="form-group">
                        <label>Message:</label>
                        <textarea name="body" required>${options.body || ''}</textarea>
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn-secondary" onclick="closeComposeModal()">Cancel</button>
                        <button type="submit" class="btn-primary">Send</button>
                    </div>
                </form>
            `;
            
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
            
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) closeComposeModal();
            });
            
            document.getElementById('composeForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                
                try {
                    await fetch('/api/emails/send', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            to: formData.get('to').split(',').map(e => e.trim()),
                            subject: formData.get('subject'),
                            body_text: formData.get('body')
                        })
                    });
                    
                    showNotification('Email sent successfully!', 'success');
                    closeComposeModal();
                    loadConversations();
                } catch (error) {
                    console.log('Send email (demo mode):', formData.get('to'));
                    showNotification('Email sent (demo mode)!', 'success');
                    closeComposeModal();
                }
            });
        }

        function closeComposeModal() {
            document.querySelector('.modal-overlay')?.remove();
        }

        // Slideover functions
        function openSlideover(conv) {
            currentConversation = conv;
            const overlay = document.getElementById('slideoverOverlay');
            const subject = document.getElementById('slideoverSubject');
            const content = document.getElementById('slideoverContent');
            
            subject.textContent = conv.subject;
            
            // Load conversation messages
            loadConversationMessages(conv.id);
            
            overlay.classList.add('active');
        }

        function closeSlideover() {
            const overlay = document.getElementById('slideoverOverlay');
            overlay.classList.remove('active');
            currentConversation = null;
        }

        async function loadConversationMessages(convId) {
            const content = document.getElementById('slideoverContent');
            content.innerHTML = '<div class="loading">Loading messages...</div>';
            
            try {
                const response = await fetch(`/api/conversations/${convId}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Loaded data:', data);
                    
                    // Check if it's a conversation object with messages array
                    let messages;
                    if (data.messages && Array.isArray(data.messages)) {
                        messages = data.messages;
                    } else if (Array.isArray(data)) {
                        messages = data;
                    } else {
                        messages = [data];
                    }
                    console.log('Rendering messages:', messages);
                    
                    renderEmailMessages(messages);
                } else {
                    console.error('API failed with status:', response.status);
                    content.innerHTML = '<div class="empty-state"><h3>Unable to load messages</h3><p>Failed to load conversation.</p></div>';
                }
            } catch (error) {
                console.error('Error loading messages:', error);
                content.innerHTML = '<div class="empty-state"><h3>Unable to load messages</h3><p>Error: ' + error.message + '</p></div>';
            }
        }

        function renderEmailMessages(messages) {
            const content = document.getElementById('slideoverContent');
            
            
            if (!messages || messages.length === 0) {
                content.innerHTML = '<div class="empty-state"><h3>No messages found</h3></div>';
                return;
            }
            
            content.innerHTML = '';
            messages.forEach(msg => {
                // Determine if this is an email message or chat message
                const isEmail = msg.message_id || msg.from_address;
                
                if (isEmail) {
                    // Render email message
                    const msgEl = document.createElement('div');
                    msgEl.className = 'email-message';
                    msgEl.style.cssText = 'padding: 16px; border-bottom: 1px solid #e4e6eb; background: white;';
                    msgEl.innerHTML = `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <div style="font-weight: 600; color: #050505;">${escapeHtml(msg.from_address)}</div>
                            <div style="color: #65676b; font-size: 13px;">${formatDate(msg.date)}</div>
                        </div>
                        <div style="color: #050505; line-height: 1.5;">${msg.body_html || escapeHtml(msg.body_text || '')}</div>
                    `;
                    content.appendChild(msgEl);
                } else {
                    // Render chat message (original logic)
                    const msgEl = document.createElement('div');
                msgEl.className = 'chat-message';
                msgEl.innerHTML = `
                    <div class="message-header">
                        <div class="message-sender">${escapeHtml(msg.from || msg.sender)}</div>
                        <div class="message-time">${formatDate(msg.date || msg.timestamp)}</div>
                    </div>
                    <div class="message-body">${escapeHtml(msg.body || msg.text)}</div>
                `;
                content.appendChild(msgEl);
                }
            });
        }

        async function sendQuickReply() {
            const textarea = document.getElementById('quickReplyText');
            const text = textarea.value.trim();
            
            if (!text || !currentConversation) return;
            
            try {
                await fetch('/api/emails/send', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        to: currentConversation.participants,
                        subject: 'Re: ' + currentConversation.subject,
                        body_text: text
                    })
                });
                
                textarea.value = '';
                showNotification('Reply sent!', 'success');
                loadConversationMessages(currentConversation.id);
            } catch (error) {
                console.log('Quick reply (demo mode):', text);
                textarea.value = '';
                showNotification('Reply sent (demo mode)!', 'success');
                
                // Add message to chat in demo mode
                const content = document.getElementById('slideoverContent');
                const msgEl = document.createElement('div');
                msgEl.className = 'chat-message';
                msgEl.innerHTML = `
                    <div class="message-header">
                        <div class="message-sender">You</div>
                        <div class="message-time">Just now</div>
                    </div>
                    <div class="message-body">${escapeHtml(text)}</div>
                `;
                content.appendChild(msgEl);
            }
        }

        function replyTo() {
            if (!currentConversation) return;
            closeSlideover();
            openComposeModal({
                to: currentConversation.participants[0],
                subject: 'Re: ' + currentConversation.subject
            });
        }

        function replyAll() {
            if (!currentConversation) return;
            closeSlideover();
            openComposeModal({
                to: currentConversation.participants.join(', '),
                subject: 'Re: ' + currentConversation.subject
            });
        }

        function forward() {
            if (!currentConversation) return;
            closeSlideover();
            openComposeModal({
                subject: 'Fwd: ' + currentConversation.subject,
                body: `\n\n---------- Forwarded message ---------\nSubject: ${currentConversation.subject}\n\n${currentConversation.preview}`
            });
        }

        // Hover action functions
        function replyAllDirect(convId) {
            const conv = conversations.find(c => c.id === convId);
            if (!conv) return;
            
            openComposeModal({
                to: conv.participants.join(', '),
                subject: 'Re: ' + conv.subject
            });
        }

        function toggleStar(convId) {
            console.log('Toggle star:', convId);
            showNotification('Star toggled!', 'success');
            // In real implementation, update the conversation's starred status
        }

        function moveConversation(convId) {
            const folders = ['inbox', 'sent', 'drafts', 'starred', 'trash'];
            const folderName = prompt('Move to folder:\n' + folders.join('\n'));
            
            if (folderName && folders.includes(folderName.toLowerCase())) {
                console.log('Move conversation', convId, 'to', folderName);
                showNotification(`Moved to ${folderName}`, 'success');
                // In real implementation, call API to move conversation
            }
        }

        async function deleteConv(convId) {
            if (!confirm('Move this conversation to trash?')) return;
            
            try {
                await fetch(`/api/emails/${convId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                showNotification('Conversation moved to trash', 'success');
                loadConversations();
            } catch (error) {
                console.log('Delete conversation (demo mode):', convId);
                showNotification('Conversation moved to trash (demo mode)', 'success');
                conversations = conversations.filter(c => c.id !== convId);
                renderConversations();
            }
        }

        // Close slideover when clicking overlay
        document.getElementById('slideoverOverlay')?.addEventListener('click', (e) => {
            if (e.target.id === 'slideoverOverlay') {
                closeSlideover();
            }
        });

        // Mock data
        function getMockFolders() {
            return [
                { id: 'inbox', name: 'Inbox', unread_count: 2 },
                { id: 'sent', name: 'Sent', unread_count: 0 },
                { id: 'drafts', name: 'Drafts', unread_count: 0 },
                { id: 'starred', name: 'Starred', unread_count: 0 },
                { id: 'trash', name: 'Trash', unread_count: 0 }
            ];
        }

        function getMockConversations() {
            return [
                {
                    id: '1',
                    subject: 'Welcome to Frame Email Client',
                    participants: ['Frame Support'],
                    last_message_date: new Date().toISOString(),
                    unread_count: 1,
                    message_count: 1,
                    preview: 'Thank you for trying Frame Email Client! This is a demo conversation to show how the interface works. Click Reply to compose a response, or use Reply All to include all participants.'
                },
                {
                    id: '2',
                    subject: 'Getting Started Guide',
                    participants: ['Frame Team'],
                    last_message_date: new Date(Date.now() - 3600000).toISOString(),
                    unread_count: 0,
                    message_count: 1,
                    preview: 'Here are some tips to get you started: 1. Use keyboard shortcuts for faster navigation 2. Try the search feature 3. Organize emails with folders 4. Use quick reply for fast responses'
                },
                {
                    id: '3',
                    subject: 'Project Update - Q4 2024',
                    participants: ['John Doe', 'Jane Smith'],
                    last_message_date: new Date(Date.now() - 7200000).toISOString(),
                    unread_count: 0,
                    message_count: 3,
                    preview: 'The Q4 project is progressing well. We have completed 75% of the planned features and are on track for the December release.'
                }
            ];
        }

        function getMockMessages(convId) {
            const conv = conversations.find(c => c.id === convId);
            if (!conv) return [];
            
            // Generate mock messages based on conversation
            if (convId === '1') {
                return [
                    {
                        from: 'Frame Support',
                        date: new Date().toISOString(),
                        body: 'Thank you for trying Frame Email Client! This is a demo conversation to show how the interface works. Click Reply to compose a response, or use Reply All to include all participants.'
                    }
                ];
            } else if (convId === '2') {
                return [
                    {
                        from: 'Frame Team',
                        date: new Date(Date.now() - 3600000).toISOString(),
                        body: 'Here are some tips to get you started:\n\n1. Use keyboard shortcuts for faster navigation\n2. Try the search feature\n3. Organize emails with folders\n4. Use quick reply for fast responses'
                    }
                ];
            } else if (convId === '3') {
                return [
                    {
                        from: 'John Doe',
                        date: new Date(Date.now() - 7200000).toISOString(),
                        body: 'The Q4 project is progressing well. We have completed 75% of the planned features and are on track for the December release.'
                    },
                    {
                        from: 'Jane Smith',
                        date: new Date(Date.now() - 3600000).toISOString(),
                        body: 'Great update! I\'ve reviewed the latest milestone and everything looks good. Should we schedule a meeting to discuss the remaining 25%?'
                    },
                    {
                        from: 'John Doe',
                        date: new Date(Date.now() - 1800000).toISOString(),
                        body: 'Yes, let\'s meet tomorrow at 2 PM. I\'ll send out a calendar invite.'
                    }
                ];
            }
            
            return [{ from: conv.participants[0], date: conv.last_message_date, body: conv.preview }];
        }

        // ============================================
        // ATTACHMENT GALLERY FUNCTIONS
        // ============================================

        function showAttachmentGallery(event) {
            // Hide conversation list
            document.getElementById('conversationList').style.display = 'none';
            
            // Show gallery
            const gallery = document.getElementById('galleryContainer');
            gallery.classList.add('active');
            gallery.style.display = 'block';
            
            // Update sidebar active state
            document.querySelectorAll('.folder-item').forEach(f => f.classList.remove('active'));
            event.target.closest('.folder-item').classList.add('active');
            
            // Load attachments
            loadGalleryRecents();
        }

        function hideAttachmentGallery() {
            // Hide gallery
            document.getElementById('galleryContainer').classList.remove('active');
            document.getElementById('galleryContainer').style.display = 'none';
            
            // Show conversation list
            document.getElementById('conversationList').style.display = 'block';
        }

        // ===== CHAT VIEW =====
        function showChatView(eventOrId) {
            hideAllViews();
            let chatView = document.getElementById('chatView');
            if (!chatView) {
                chatView = createChatView();
                document.getElementById('dynamicViewsContainer').appendChild(chatView);
            }
            chatView.style.display = 'block';
            
            // Handle both event object and conversation ID
            if (typeof eventOrId === 'string') {
                // It's a conversation ID, open it directly
                openChatConversation(eventOrId);
            } else if (eventOrId) {
                updateSidebarActive(eventOrId);
            }
            loadChatConversations();
        }

        function createChatView() {
            const view = document.createElement('div');
            view.id = 'chatView';
            view.style.display = 'none';
            view.innerHTML = `
                <div style="padding: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h1 style="font-size: 24px; font-weight: 600;">🤖 Goose Chat</h1>
                        <button class="compose-btn" onclick="startNewChat()">+ New Chat</button>
                    </div>
                    <div id="chatConversationsList" style="display: grid; gap: 12px;">
                        <div class="loading">Loading chat conversations...</div>
                    </div>
                </div>
            `;
            return view;
        }

        async function loadChatConversations() {
            const container = document.getElementById('chatConversationsList');
            if (!container) return;
            
            try {
                const response = await fetch('/api/chat/conversations', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const conversations = await response.json();
                    renderChatConversations(conversations);
                } else {
                    container.innerHTML = '<div class="empty-state"><h3>No chat conversations yet</h3><p>Start a new chat to get help with your emails</p></div>';
                }
            } catch (error) {
                container.innerHTML = '<div class="empty-state"><h3>No chat conversations yet</h3><p>Start a new chat to get help with your emails</p></div>';
            }
        }

        function renderChatConversations(conversations) {
            const container = document.getElementById('chatConversationsList');
            if (conversations.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>No chat conversations yet</h3><p>Start a new chat to get help with your emails</p></div>';
                return;
            }
            
            container.innerHTML = conversations.map(conv => `
                <div class="conversation" onclick="openChatConversation('${conv.id}')" style="cursor: pointer;">
                    <div class="conversation-line">
                        <div class="conversation-info">
                            <div class="subject-line">🤖 ${escapeHtml(conv.title || 'New Chat')}</div>
                            <div class="content-snippet">${escapeHtml(conv.last_message || 'No messages yet')}</div>
                        </div>
                        <div class="timestamp">${formatDate(conv.updated_at)}</div>
                    </div>
                </div>
            `).join('');
        }

        async function startNewChat() {
            try {
                const response = await fetch('/api/chat/conversations', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ title: 'New Chat' })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    openChatConversation(data.id);
                }
            } catch (error) {
                showNotification('Failed to create chat', 'error');
            }
        }

        function openChatConversation(conversationId) {
            hideAllViews();
            let chatInterface = document.getElementById('chatInterface');
            if (!chatInterface) {
                chatInterface = createChatInterface();
                document.getElementById('dynamicViewsContainer').appendChild(chatInterface);
            }
            chatInterface.style.display = 'block';
            chatInterface.dataset.conversationId = conversationId;
            loadChatMessages(conversationId);
        }

        function createChatInterface() {
            const view = document.createElement('div');
            view.id = 'chatInterface';
            view.style.display = 'none';
            view.innerHTML = `
                <div style="display: flex; flex-direction: column; height: calc(100vh - 60px); background: white; border-radius: 8px; margin: 20px;">
                    <div style="padding: 16px; border-bottom: 1px solid #e4e6eb; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <button onclick="showChatView()" style="background: none; border: none; cursor: pointer; font-size: 20px;">←</button>
                            <span style="font-weight: 600; margin-left: 12px;">🤖 Goose Chat</span>
                        </div>
                        <button onclick="deleteChatConversation()" class="icon-btn" title="Delete Conversation">🗑️</button>
                    </div>
                    <div id="chatMessagesContainer" style="flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 16px;">
                        <div class="loading">Loading messages...</div>
                    </div>
                    <div style="padding: 16px; border-top: 1px solid #e4e6eb;">
                        <div style="display: flex; gap: 8px;">
                            <textarea id="chatMessageInput" placeholder="Type your message... (Shift+Enter for new line)" 
                                style="flex: 1; padding: 12px; border: 1px solid #dadde1; border-radius: 8px; resize: none; font-family: inherit; font-size: 14px;" 
                                rows="3"
                                onkeydown="handleChatInputKeydown(event)"></textarea>
                            <button onclick="sendChatMessage()" class="compose-btn" style="align-self: flex-end; height: fit-content;">Send</button>
                        </div>
                    </div>
                </div>
            `;
            return view;
        }

        async function loadChatMessages(conversationId) {
            const container = document.getElementById('chatMessagesContainer');
            if (!container) return;
            
            try {
                const response = await fetch(`/api/chat/conversations/${conversationId}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const messages = await response.json();
                    renderChatMessages(messages);
                } else {
                    container.innerHTML = '<div class="empty-state"><h3>Failed to load messages</h3></div>';
                }
            } catch (error) {
                container.innerHTML = '<div class="empty-state"><h3>Failed to load messages</h3></div>';
            }
        }

        function renderChatMessages(messages) {
            const container = document.getElementById('chatMessagesContainer');
            if (messages.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No messages yet. Start the conversation!</p></div>';
                return;
            }
            
            container.innerHTML = messages.map(msg => {
                const isUser = msg.role === 'user';
                const timestamp = new Date(msg.created_at).toLocaleTimeString();
                return `
                    <div style="display: flex; ${isUser ? 'justify-content: flex-end' : 'justify-content: flex-start'};">
                        <div style="max-width: 70%; padding: 12px 16px; border-radius: 12px; ${isUser ? 'background: #1877f2; color: white;' : 'background: #f0f2f5; color: #1c1e21;'}">
                            <div style="white-space: pre-wrap; word-wrap: break-word;">${escapeHtml(msg.content)}</div>
                            <div style="font-size: 11px; margin-top: 4px; opacity: 0.7;">${timestamp}</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
        }

        function handleChatInputKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendChatMessage();
            }
        }

        async function sendChatMessage() {
            const input = document.getElementById('chatMessageInput');
            const chatInterface = document.getElementById('chatInterface');
            const conversationId = chatInterface?.dataset.conversationId;
            
            if (!input || !conversationId) return;
            
            const content = input.value.trim();
            if (!content) return;
            
            // Clear input and disable
            input.value = '';
            input.disabled = true;
            
            // Add user message to UI immediately
            const container = document.getElementById('chatMessagesContainer');
            const userMsgHtml = `
                <div style="display: flex; justify-content: flex-end;">
                    <div style="max-width: 70%; padding: 12px 16px; border-radius: 12px; background: #1877f2; color: white;">
                        <div style="white-space: pre-wrap; word-wrap: break-word;">${escapeHtml(content)}</div>
                        <div style="font-size: 11px; margin-top: 4px; opacity: 0.7;">${new Date().toLocaleTimeString()}</div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', userMsgHtml);
            
            // Add loading indicator
            const loadingHtml = `
                <div id="chatLoading" style="display: flex; justify-content: flex-start;">
                    <div style="max-width: 70%; padding: 12px 16px; border-radius: 12px; background: #f0f2f5; color: #1c1e21;">
                        <div>🤖 Thinking...</div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', loadingHtml);
            container.scrollTop = container.scrollHeight;
            
            try {
                const response = await fetch(`/api/chat/conversations/${conversationId}/messages`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ content })
                });
                
                // Remove loading indicator
                document.getElementById('chatLoading')?.remove();
                
                if (response.ok) {
                    // Reload all messages to get the assistant response
                    await loadChatMessages(conversationId);
                } else {
                    showNotification('Failed to send message', 'error');
                }
            } catch (error) {
                document.getElementById('chatLoading')?.remove();
                showNotification('Failed to send message', 'error');
            } finally {
                input.disabled = false;
                input.focus();
            }
        }

        async function deleteChatConversation() {
            const chatInterface = document.getElementById('chatInterface');
            const conversationId = chatInterface?.dataset.conversationId;
            if (!conversationId || !confirm('Delete this conversation?')) return;
            
            try {
                await fetch(`/api/chat/conversations/${conversationId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                showNotification('Conversation deleted', 'success');
                showChatView();
            } catch (error) {
                showNotification('Failed to delete conversation', 'error');
            }
        }

        // ===== AUTOMATIONS VIEW =====
        function showAutomationsView(event) {
            hideAllViews();
            let automationsView = document.getElementById('automationsView');
            if (!automationsView) {
                automationsView = createAutomationsView();
                document.getElementById('dynamicViewsContainer').appendChild(automationsView);
            }
            automationsView.style.display = 'block';
            if (event) updateSidebarActive(event);
            loadAutomations();
        }

        function createAutomationsView() {
            const view = document.createElement('div');
            view.id = 'automationsView';
            view.style.display = 'none';
            view.innerHTML = `
                <div style="padding: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h1 style="font-size: 24px; font-weight: 600;">⚙️ Automations</h1>
                        <button class="compose-btn" onclick="createAutomation()">+ New Automation</button>
                    </div>
                    <div id="automationsList" style="display: grid; gap: 12px;">
                        <div class="loading">Loading automations...</div>
                    </div>
                </div>
            `;
            return view;
        }

        async function loadAutomations() {
            const container = document.getElementById('automationsList');
            if (!container) return;
            
            try {
                const response = await fetch('/api/automations', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const automations = await response.json();
                    renderAutomations(automations);
                } else {
                    container.innerHTML = '<div class="empty-state"><h3>No automations yet</h3><p>Create an automation to run AI tasks on a schedule</p></div>';
                }
            } catch (error) {
                container.innerHTML = '<div class="empty-state"><h3>No automations yet</h3><p>Create an automation to run AI tasks on a schedule</p></div>';
            }
        }

        function renderAutomations(automations) {
            const container = document.getElementById('automationsList');
            if (automations.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>No automations yet</h3><p>Create an automation to run AI tasks on a schedule</p></div>';
                return;
            }
            
            container.innerHTML = automations.map(auto => `
                <div class="conversation" style="padding: 16px; background: white; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; margin-bottom: 4px;">${escapeHtml(auto.name)}</div>
                            <div style="color: #65676b; font-size: 14px; margin-bottom: 8px;">${escapeHtml(auto.description || '')}</div>
                            <div style="font-size: 13px; color: #8a8d91;">
                                <span>📅 ${escapeHtml(auto.schedule)}</span>
                                ${auto.last_run ? ` • Last run: ${formatDate(auto.last_run)}` : ''}
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" ${auto.enabled ? 'checked' : ''} 
                                    onchange="toggleAutomation('${auto.id}', this.checked)" 
                                    style="margin-right: 4px;">
                                <span style="font-size: 13px;">${auto.enabled ? 'Enabled' : 'Disabled'}</span>
                            </label>
                            <button class="icon-btn" onclick="runAutomation('${auto.id}')" title="Run Now">▶️</button>
                            <button class="icon-btn" onclick="editAutomation('${auto.id}')" title="Edit">✏️</button>
                            <button class="icon-btn" onclick="deleteAutomation('${auto.id}')" title="Delete">🗑️</button>
                            <button class="icon-btn" onclick="viewAutomationTools()" title="View Available Tools">🔧</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function createAutomation() {
            const modal = document.createElement('div');
            modal.id = 'automationModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 24px; max-width: 500px; width: 90%;">
                    <h2 style="margin: 0 0 20px 0; font-size: 20px;">Create Automation</h2>
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" id="automationName" placeholder="Daily email summary" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px;">
                    </div>
                    <div class="form-group">
                        <label>Description (optional)</label>
                        <input type="text" id="automationDescription" placeholder="Summarize unread emails" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px;">
                    </div>
                    <div class="form-group">
                        <label>Schedule (cron expression)</label>
                        <select id="automationSchedulePreset" onchange="updateScheduleInput(this.value)" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px; margin-bottom: 8px;">
                            <option value="">Custom</option>
                            <option value="0 9 * * *">Daily at 9 AM</option>
                            <option value="0 9 * * 1">Weekly on Monday at 9 AM</option>
                            <option value="0 9 1 * *">Monthly on 1st at 9 AM</option>
                            <option value="0 */6 * * *">Every 6 hours</option>
                        </select>
                        <input type="text" id="automationSchedule" placeholder="0 9 * * *" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px;">
                        <small style="color: #65676b;">Format: minute hour day month weekday</small>
                    </div>
                    <div class="form-group">
                        <label>AI Prompt</label>
                        <textarea id="automationPrompt" placeholder="Summarize all unread emails from the last 24 hours" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px; resize: vertical;" rows="4"></textarea>
                    </div>
                    <div style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 20px;">
                        <button onclick="closeAutomationModal()" style="padding: 8px 16px; border: 1px solid #dadde1; background: white; border-radius: 6px; cursor: pointer;">Cancel</button>
                        <button onclick="saveAutomation()" class="compose-btn">Create</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function updateScheduleInput(preset) {
            const input = document.getElementById('automationSchedule');
            if (preset && input) {
                input.value = preset;
            }
        }

        function closeAutomationModal() {
            const modal = document.getElementById('automationModal');
            if (modal) modal.remove();
        }

        async function saveAutomation() {
            const name = document.getElementById('automationName').value.trim();
            const description = document.getElementById('automationDescription').value.trim();
            const schedule = document.getElementById('automationSchedule').value.trim();
            const prompt = document.getElementById('automationPrompt').value.trim();

            if (!name) {
                showNotification('Please enter a name', 'error');
                return;
            }
            if (!schedule) {
                showNotification('Please enter a schedule', 'error');
                return;
            }
            if (!prompt) {
                showNotification('Please enter a prompt', 'error');
                return;
            }

            try {
                const response = await fetch('/api/automations', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name,
                        description: description || null,
                        schedule,
                        prompt,
                        enabled: true
                    })
                });

                if (response.ok) {
                    showNotification('Automation created', 'success');
                    closeAutomationModal();
                    loadAutomations();
                } else {
                    showNotification('Failed to create automation', 'error');
                }
            } catch (error) {
                showNotification('Failed to create automation', 'error');
            }
        }

        async function runAutomation(automationId) {
            if (!confirm('Run this automation now?')) return;
            
            showNotification('Running automation...', 'info');
            
            try {
                const response = await fetch(`/api/automations/${automationId}/trigger`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showNotification('✅ Automation completed! Check Goose Chat for results.', 'success');
                    loadAutomations();
                } else {
                    showNotification('Failed to run automation', 'error');
                }
            } catch (error) {
                console.error('Failed to run automation:', error);
                showNotification('Failed to run automation', 'error');
            }
        }
        
        async function viewAutomationTools() {
            try {
                const response = await fetch('/api/agent/tools', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const tools = data.tools;
                    
                    const modal = document.createElement('div');
                    modal.id = 'toolsModal';
                    modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000; overflow-y: auto;';
                    modal.innerHTML = `
                        <div style="background: white; border-radius: 12px; padding: 24px; max-width: 800px; width: 90%; max-height: 80vh; overflow-y: auto;">
                            <h2 style="margin: 0 0 20px 0; font-size: 20px;">🔧 Available AI Tools (${tools.length})</h2>
                            <div style="display: grid; gap: 16px;">
                                ${tools.map(tool => `
                                    <div style="border: 1px solid #e4e6eb; border-radius: 8px; padding: 16px;">
                                        <div style="font-weight: 600; font-size: 16px; margin-bottom: 8px;">${tool.name}</div>
                                        <div style="color: #65676b; margin-bottom: 12px;">${tool.description}</div>
                                        ${tool.parameters.length > 0 ? `
                                            <div style="font-size: 14px;">
                                                <div style="font-weight: 600; margin-bottom: 4px;">Parameters:</div>
                                                <ul style="margin: 0; padding-left: 20px;">
                                                    ${tool.parameters.map(param => `
                                                        <li style="margin-bottom: 4px;">
                                                            <code style="background: #f0f2f5; padding: 2px 6px; border-radius: 3px;">${param.name}</code>
                                                            <span style="color: #8a8d91;">(${param.param_type}${param.required ? ', required' : ', optional'})</span>
                                                            - ${param.description}
                                                        </li>
                                                    `).join('')}
                                                </ul>
                                            </div>
                                        ` : ''}
                                    </div>
                                `).join('')}
                            </div>
                            <div style="margin-top: 20px; text-align: right;">
                                <button onclick="document.getElementById('toolsModal').remove()" class="compose-btn">Close</button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                }
            } catch (error) {
                console.error('Failed to load tools:', error);
                showNotification('Failed to load tools', 'error');
            }
        }

        async function toggleAutomation(id, enabled) {
            try {
                await fetch(`/api/automations/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ enabled })
                });
                showNotification(`Automation ${enabled ? 'enabled' : 'disabled'}`, 'success');
            } catch (error) {
                showNotification('Failed to update automation', 'error');
            }
        }

        async function runAutomation(id) {
            try {
                await fetch(`/api/automations/${id}/trigger`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                showNotification('Automation triggered', 'success');
            } catch (error) {
                showNotification('Failed to run automation', 'error');
            }
        }

        function editAutomation(id) {
            showNotification('Automation editing coming soon!', 'info');
        }

        async function deleteAutomation(id) {
            if (!confirm('Delete this automation?')) return;
            try {
                await fetch(`/api/automations/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                showNotification('Automation deleted', 'success');
                loadAutomations();
            } catch (error) {
                showNotification('Failed to delete automation', 'error');
            }
        }

        // ===== REMINDERS VIEW =====
        function showRemindersView(event) {
            hideAllViews();
            let remindersView = document.getElementById('remindersView');
            if (!remindersView) {
                remindersView = createRemindersView();
                document.getElementById('dynamicViewsContainer').appendChild(remindersView);
            }
            remindersView.style.display = 'block';
            if (event) updateSidebarActive(event);
            loadReminders();
        }

        function createRemindersView() {
            const view = document.createElement('div');
            view.id = 'remindersView';
            view.style.display = 'none';
            view.innerHTML = `
                <div style="padding: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h1 style="font-size: 24px; font-weight: 600;">✓ Reminders</h1>
                        <button class="compose-btn" onclick="createReminder()">+ New Reminder</button>
                    </div>
                    <div style="margin-bottom: 16px; display: flex; gap: 8px;">
                        <button class="filter-btn active" data-filter="active" onclick="filterReminders('active')">Active</button>
                        <button class="filter-btn" data-filter="completed" onclick="filterReminders('completed')">Completed</button>
                        <button class="filter-btn" data-filter="all" onclick="filterReminders('all')">All</button>
                    </div>
                    <div id="remindersList" style="display: grid; gap: 12px;">
                        <div class="loading">Loading reminders...</div>
                    </div>
                </div>
            `;
            return view;
        }

        let currentReminderFilter = 'active';

        async function loadReminders() {
            const container = document.getElementById('remindersList');
            if (!container) return;
            
            try {
                const response = await fetch(`/api/reminders?filter=${currentReminderFilter}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const reminders = await response.json();
                    renderReminders(reminders);
                } else {
                    container.innerHTML = '<div class="empty-state"><h3>No reminders yet</h3><p>Create a reminder to track your tasks</p></div>';
                }
            } catch (error) {
                container.innerHTML = '<div class="empty-state"><h3>No reminders yet</h3><p>Create a reminder to track your tasks</p></div>';
            }
        }

        function renderReminders(reminders) {
            const container = document.getElementById('remindersList');
            if (reminders.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>No reminders found</h3></div>';
                return;
            }
            
            container.innerHTML = reminders.map(reminder => {
                const isOverdue = reminder.due_date && new Date(reminder.due_date) < new Date() && !reminder.completed;
                return `
                <div class="conversation" style="padding: 16px; background: white; border-radius: 8px; ${reminder.completed ? 'opacity: 0.6;' : ''}">
                    <div style="display: flex; gap: 12px; align-items: start;">
                        <input type="checkbox" ${reminder.completed ? 'checked' : ''} 
                            onchange="toggleReminder('${reminder.id}', this.checked)" 
                            style="margin-top: 4px; cursor: pointer;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; margin-bottom: 4px; ${reminder.completed ? 'text-decoration: line-through;' : ''}">
                                ${escapeHtml(reminder.title)}
                            </div>
                            ${reminder.notes ? `<div style="color: #65676b; font-size: 14px; margin-bottom: 8px;">${escapeHtml(reminder.notes)}</div>` : ''}
                            ${reminder.due_date ? `
                                <div style="font-size: 13px; color: ${isOverdue ? '#c62828' : '#8a8d91'};">
                                    📅 Due: ${formatDate(reminder.due_date)} ${isOverdue ? '(Overdue)' : ''}
                                </div>
                            ` : ''}
                        </div>
                        <div style="display: flex; gap: 4px;">
                            <button class="icon-btn" onclick="editReminder('${reminder.id}')" title="Edit">✏️</button>
                            <button class="icon-btn" onclick="deleteReminder('${reminder.id}')" title="Delete">🗑️</button>
                        </div>
                    </div>
                </div>
            `;
            }).join('');
        }

        function filterReminders(filter) {
            currentReminderFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });
            loadReminders();
        }

        function createReminder() {
            const modal = document.createElement('div');
            modal.id = 'reminderModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 24px; max-width: 500px; width: 90%;">
                    <h2 style="margin: 0 0 20px 0; font-size: 20px;">Create Reminder</h2>
                    <div class="form-group">
                        <label>Title</label>
                        <input type="text" id="reminderTitle" placeholder="Complete project report" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px;">
                    </div>
                    <div class="form-group">
                        <label>Notes (optional)</label>
                        <textarea id="reminderNotes" placeholder="Include Q4 metrics and team feedback" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px; resize: vertical;" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Due Date (optional)</label>
                        <input type="datetime-local" id="reminderDueDate" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px;">
                    </div>
                    <div style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 20px;">
                        <button onclick="closeReminderModal()" style="padding: 8px 16px; border: 1px solid #dadde1; background: white; border-radius: 6px; cursor: pointer;">Cancel</button>
                        <button onclick="saveReminder()" class="compose-btn">Create</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function closeReminderModal() {
            const modal = document.getElementById('reminderModal');
            if (modal) modal.remove();
        }

        async function saveReminder() {
            const title = document.getElementById('reminderTitle').value.trim();
            const notes = document.getElementById('reminderNotes').value.trim();
            const due_date = document.getElementById('reminderDueDate').value;

            if (!title) {
                showNotification('Please enter a title', 'error');
                return;
            }

            try {
                const response = await fetch('/api/reminders', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title,
                        notes: notes || null,
                        due_date: due_date ? new Date(due_date).toISOString() : null
                    })
                });

                if (response.ok) {
                    showNotification('Reminder created', 'success');
                    closeReminderModal();
                    loadReminders();
                } else {
                    showNotification('Failed to create reminder', 'error');
                }
            } catch (error) {
                showNotification('Failed to create reminder', 'error');
            }
        }

        async function toggleReminder(id, completed) {
            try {
                await fetch(`/api/reminders/${id}/complete`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ completed })
                });
                loadReminders();
            } catch (error) {
                showNotification('Failed to update reminder', 'error');
            }
        }

        function editReminder(id) {
            showNotification('Reminder editing coming soon!', 'info');
        }

        async function deleteReminder(id) {
            if (!confirm('Delete this reminder?')) return;
            try {
                await fetch(`/api/reminders/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                showNotification('Reminder deleted', 'success');
                loadReminders();
            } catch (error) {
                showNotification('Failed to delete reminder', 'error');
            }
        }

        // ===== SETTINGS VIEW =====
        function showSettingsView(event) {
            hideAllViews();
            let settingsView = document.getElementById('settingsView');
            if (!settingsView) {
                settingsView = createSettingsView();
                document.getElementById('dynamicViewsContainer').appendChild(settingsView);
            }
            settingsView.style.display = 'block';
            if (event) updateSidebarActive(event);
        }

        function createSettingsView() {
            const view = document.createElement('div');
            view.id = 'settingsView';
            view.style.display = 'none';
            view.innerHTML = `
                <div style="padding: 20px; max-width: 800px;">
                    <h1 style="font-size: 24px; font-weight: 600; margin-bottom: 24px;">⚙️ Settings</h1>
                    
                    <div style="background: white; border-radius: 8px; padding: 20px; margin-bottom: 16px;">
                        <h2 style="font-size: 18px; font-weight: 600; margin-bottom: 16px;">Email Settings</h2>
                        <div class="form-group">
                            <label>IMAP Host</label>
                            <input id="setting-imap-host" type="text" placeholder="imap.gmail.com" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px;">
                        </div>
                        <div class="form-group">
                            <label>SMTP Host</label>
                            <input id="setting-smtp-host" type="text" placeholder="smtp.gmail.com" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px;">
                        </div>
                    </div>
                    
                    <div style="background: white; border-radius: 8px; padding: 20px; margin-bottom: 16px;">
                        <h2 style="font-size: 18px; font-weight: 600; margin-bottom: 16px;">AI Agent Settings</h2>
                        <div class="form-group">
                            <label>LLM Provider</label>
                            <select id="setting-llm-provider" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px;">
                                <option>Anthropic</option>
                                <option>OpenAI</option>
                                <option>Databricks</option>
                                <option>Local GGUF</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>API Key</label>
                            <input id="setting-api-key" type="password" placeholder="Enter API key" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px;">
                        </div>
                        <div class="form-group">
                            <label>Model ID</label>
                            <input id="setting-model-id" type="text" placeholder="claude-3-5-sonnet-20241022" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px;">
                        </div>
                    </div>
                    
                    <div style="background: white; border-radius: 8px; padding: 20px; margin-bottom: 16px;">
                        <h2 style="font-size: 18px; font-weight: 600; margin-bottom: 16px;">Calendar Settings</h2>
                        <div class="form-group">
                            <label>CalDAV Server URL</label>
                            <input id="setting-caldav-url" type="text" placeholder="https://caldav.example.com" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px;">
                        </div>
                        <div class="form-group">
                            <label>Username</label>
                            <input id="setting-caldav-username" type="text" placeholder="username" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px;">
                        </div>
                        <div class="form-group">
                            <label>Password</label>
                            <input id="setting-caldav-password" type="password" placeholder="password" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px;">
                        </div>
                    </div>
                    
                    <div style="background: white; border-radius: 8px; padding: 20px;">
                        <h2 style="font-size: 18px; font-weight: 600; margin-bottom: 16px;">Personal Money Settings</h2>
                        <div class="form-group">
                            <label>Bank Account</label>
                            <input id="setting-bank-account" type="text" placeholder="Account credentials" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px;">
                        </div>
                        <div class="form-group">
                            <label>Cash App ID</label>
                            <input id="setting-cashapp-id" type="text" placeholder="$cashtag" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px;">
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; text-align: right;">
                        <button class="compose-btn" onclick="saveSettings()" style="padding: 12px 32px;">💾 Save Settings</button>
                    </div>
                    
                    <div id="settings-save-status" style="margin-top: 16px; padding: 12px; border-radius: 8px; display: none;"></div>
                </div>
            `;
            
            // Add auto-save listeners after view is created
            setTimeout(() => {
                const settingInputs = [
                    'setting-imap-host', 'setting-smtp-host', 'setting-llm-provider',
                    'setting-api-key', 'setting-model-id', 'setting-caldav-url',
                    'setting-caldav-username', 'setting-caldav-password',
                    'setting-bank-account', 'setting-cashapp-id'
                ];
                
                settingInputs.forEach(id => {
                    const input = document.getElementById(id);
                    if (input) {
                        input.addEventListener('change', () => saveSettings());
                    }
                });
                
                // Load current settings
                loadSettings();
            }, 100);
            
            return view;
        }
        
        async function loadSettings() {
            try {
                // Load user settings from database
                const response = await fetch('/api/settings', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const settings = await response.json();
                    
                    // Populate AI settings
                    if (settings.ai_provider) {
                        const providerSelect = document.getElementById('setting-llm-provider');
                        if (providerSelect) {
                            providerSelect.value = settings.ai_provider.charAt(0).toUpperCase() + settings.ai_provider.slice(1);
                        }
                    }
                    if (settings.ai_api_key) {
                        const apiKeyInput = document.getElementById('setting-api-key');
                        if (apiKeyInput) apiKeyInput.value = settings.ai_api_key;
                    }
                    if (settings.ai_model) {
                        const modelInput = document.getElementById('setting-model-id');
                        if (modelInput) modelInput.value = settings.ai_model;
                    }
                    
                    console.log('Settings loaded:', settings);
                }
                
                // Load environment settings (API keys, etc.)
                const envResponse = await fetch('/api/settings/env', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (envResponse.ok) {
                    const envSettings = await envResponse.json();
                    if (envSettings.anthropic_api_key) {
                        const apiKeyInput = document.getElementById('setting-api-key');
                        if (apiKeyInput) apiKeyInput.value = envSettings.anthropic_api_key;
                    }
                    console.log('Environment settings loaded');
                }
            } catch (error) {
                console.error('Failed to load settings:', error);
            }
        }
        
        async function saveSettings() {
            const settings = {
                // User preferences
                // imap_host: document.getElementById('setting-imap-host')?.value,
                // smtp_host: document.getElementById('setting-smtp-host')?.value,
                ai_provider: document.getElementById('setting-llm-provider')?.value?.toLowerCase(),
                ai_api_key: document.getElementById('setting-api-key')?.value,
                ai_model: document.getElementById('setting-model-id')?.value,
                caldav_url: document.getElementById('setting-caldav-url')?.value,
                caldav_username: document.getElementById('setting-caldav-username')?.value,
                caldav_password: document.getElementById('setting-caldav-password')?.value,
                bank_account: document.getElementById('setting-bank-account')?.value,
                cashapp_id: document.getElementById('setting-cashapp-id')?.value
            };
            
            try {
                // Save user settings to database
                const response = await fetch('/api/settings', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settings)
                });
                
                // Save API key to .env file
                if (settings.ai_api_key) {
                    const envResponse = await fetch('/api/settings/env', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            anthropic_api_key: settings.ai_api_key
                        })
                    });
                    
                    if (envResponse.ok) {
                        const envResult = await envResponse.json();
                        console.log('Environment settings saved:', envResult.message);
                    }
                }
                
                const statusDiv = document.getElementById('settings-save-status');
                if (response.ok) {
                    statusDiv.style.display = 'block';
                    statusDiv.style.background = '#e8f5e8';
                    statusDiv.style.color = '#2e7d32';
                    statusDiv.textContent = '✓ Settings saved successfully';
                    setTimeout(() => { statusDiv.style.display = 'none'; }, 3000);
                } else {
                    statusDiv.style.display = 'block';
                    statusDiv.style.background = '#ffebee';
                    statusDiv.style.color = '#c62828';
                    statusDiv.textContent = '✗ Failed to save settings';
                }
            } catch (error) {
                console.error('Failed to save settings:', error);
            }
        }

        // ===== CALENDAR VIEW =====
        function showCalendarView(event) {
            hideAllViews();
            let calendarView = document.getElementById('calendarView');
            if (!calendarView) {
                calendarView = createCalendarView();
                document.getElementById('dynamicViewsContainer').appendChild(calendarView);
            }
            calendarView.style.display = 'block';
            if (event) updateSidebarActive(event);
            loadCalendarEvents();
        }

        function createCalendarView() {
            const view = document.createElement('div');
            view.id = 'calendarView';
            view.style.display = 'none';
            view.innerHTML = `
                <div style="padding: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h1 style="font-size: 24px; font-weight: 600;">📅 Calendar</h1>
                        <div style="display: flex; gap: 8px;">
                            <button class="compose-btn" onclick="toggleCalendarView()" id="calendarViewToggle">Week View</button>
                            <button class="compose-btn" onclick="createCalendarEvent()">+ New Event</button>
                        </div>
                    </div>
                    <div id="calendarWeekView" style="display: none;"></div>
                    <div id="calendarEventsList" style="display: block; gap: 12px;">
                        <div class="loading">Loading events...</div>
                    </div>
                </div>
            `;
            return view;
        }
        
        let calendarViewMode = 'list'; // 'list' or 'week'
        
        function toggleCalendarView() {
            const weekView = document.getElementById('calendarWeekView');
            const listView = document.getElementById('calendarEventsList');
            const toggleBtn = document.getElementById('calendarViewToggle');
            
            if (calendarViewMode === 'list') {
                calendarViewMode = 'week';
                weekView.style.display = 'block';
                listView.style.display = 'none';
                toggleBtn.textContent = 'List View';
                renderWeekCalendar();
            } else {
                calendarViewMode = 'list';
                weekView.style.display = 'none';
                listView.style.display = 'block';
                toggleBtn.textContent = 'Week View';
            }
        }
        
        async function renderWeekCalendar() {
            const container = document.getElementById('calendarWeekView');
            if (!container) return;
            
            // Get current week dates
            const today = new Date();
            const currentDay = today.getDay();
            const monday = new Date(today);
            monday.setDate(today.getDate() - (currentDay === 0 ? 6 : currentDay - 1));
            
            const weekDays = [];
            for (let i = 0; i < 7; i++) {
                const day = new Date(monday);
                day.setDate(monday.getDate() + i);
                weekDays.push(day);
            }
            
            // Fetch events for the week
            const dateFrom = weekDays[0].toISOString().split('T')[0];
            const dateTo = new Date(weekDays[6]);
            dateTo.setDate(dateTo.getDate() + 1);
            const dateToStr = dateTo.toISOString().split('T')[0];
            
            let events = [];
            try {
                const response = await fetch(`/api/calendar/events?date_from=${dateFrom}&date_to=${dateToStr}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (response.ok) {
                    events = await response.json();
                }
            } catch (error) {
                console.error('Failed to load events:', error);
            }
            
            // Render week calendar
            const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            
            let html = `
                <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-bottom: 16px;">
            `;
            
            // Header row with day names and dates
            weekDays.forEach((day, idx) => {
                const isToday = day.toDateString() === today.toDateString();
                html += `
                    <div style="background: ${isToday ? '#e7f3ff' : 'white'}; padding: 12px; border-radius: 8px; text-align: center; border: ${isToday ? '2px solid #1877f2' : '1px solid #e4e6eb'};">
                        <div style="font-weight: 600; font-size: 14px;">${dayNames[idx]}</div>
                        <div style="font-size: 24px; font-weight: 600; margin: 4px 0;">${day.getDate()}</div>
                        <div style="font-size: 12px; color: #65676b;">${day.toLocaleDateString('en-US', { month: 'short' })}</div>
                    </div>
                `;
            });
            
            html += `</div>`;
            
            // Events grid
            html += `<div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; min-height: 400px;">`;
            
            weekDays.forEach((day) => {
                const dayStr = day.toISOString().split('T')[0];
                const dayEvents = events.filter(e => {
                    const eventDate = new Date(e.start_time).toISOString().split('T')[0];
                    return eventDate === dayStr;
                });
                
                html += `
                    <div style="background: #f7f8fa; padding: 8px; border-radius: 8px; min-height: 400px;">
                `;
                
                dayEvents.forEach(event => {
                    const startTime = new Date(event.start_time);
                    const endTime = new Date(event.end_time);
                    const timeStr = `${startTime.getHours()}:${String(startTime.getMinutes()).padStart(2, '0')}`;
                    
                    html += `
                        <div style="background: #1877f2; color: white; padding: 8px; border-radius: 6px; margin-bottom: 8px; cursor: pointer; font-size: 12px;" 
                             onclick="editCalendarEvent('${event.id}')" title="${escapeHtml(event.description || '')}">
                            <div style="font-weight: 600;">${timeStr}</div>
                            <div style="margin-top: 4px;">${escapeHtml(event.title)}</div>
                            ${event.location ? `<div style="margin-top: 2px; opacity: 0.9;">📍 ${escapeHtml(event.location)}</div>` : ''}
                        </div>
                    `;
                });
                
                html += `</div>`;
            });
            
            html += `</div>`;
            
            container.innerHTML = html;
        }

        async function loadCalendarEvents() {
            const container = document.getElementById('calendarEventsList');
            if (!container) return;
            
            try {
                const response = await fetch('/api/calendar/events', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const events = await response.json();
                    renderCalendarEvents(events);
                } else {
                    container.innerHTML = '<div class="empty-state"><h3>No calendar events</h3><p>Create an event to get started</p></div>';
                }
            } catch (error) {
                container.innerHTML = '<div class="empty-state"><h3>No calendar events</h3><p>Create an event to get started</p></div>';
            }
        }

        function renderCalendarEvents(events) {
            const container = document.getElementById('calendarEventsList');
            if (events.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>No calendar events</h3></div>';
                return;
            }
            
            container.innerHTML = events.map(event => {
                const startDate = new Date(event.start_time);
                const endDate = new Date(event.end_time);
                return `
                <div class="conversation" style="padding: 16px; background: white; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; margin-bottom: 4px;">${escapeHtml(event.title)}</div>
                            ${event.description ? `<div style="color: #65676b; font-size: 14px; margin-bottom: 8px;">${escapeHtml(event.description)}</div>` : ''}
                            <div style="font-size: 13px; color: #8a8d91;">
                                <span>📅 ${startDate.toLocaleString()}</span>
                                ${event.location ? ` • 📍 ${escapeHtml(event.location)}` : ''}
                            </div>
                        </div>
                        <div style="display: flex; gap: 4px;">
                            <button class="icon-btn" onclick="editCalendarEvent('${event.id}')" title="Edit">✏️</button>
                            <button class="icon-btn" onclick="deleteCalendarEvent('${event.id}')" title="Delete">🗑️</button>
                        </div>
                    </div>
                </div>
            `;
            }).join('');
        }

        function createCalendarEvent() {
            const modal = document.createElement('div');
            modal.id = 'calendarModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 24px; max-width: 500px; width: 90%;">
                    <h2 style="margin: 0 0 20px 0; font-size: 20px;">Create Calendar Event</h2>
                    <div class="form-group">
                        <label>Title</label>
                        <input type="text" id="eventTitle" placeholder="Team Meeting" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px;">
                    </div>
                    <div class="form-group">
                        <label>Description (optional)</label>
                        <textarea id="eventDescription" placeholder="Discuss project updates" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px; resize: vertical;" rows="2"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Location (optional)</label>
                        <input type="text" id="eventLocation" placeholder="Conference Room A" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px;">
                    </div>
                    <div class="form-group">
                        <label>Start Time</label>
                        <input type="datetime-local" id="eventStartTime" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px;">
                    </div>
                    <div class="form-group">
                        <label>End Time</label>
                        <input type="datetime-local" id="eventEndTime" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px;">
                    </div>
                    <div style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 20px;">
                        <button onclick="closeCalendarModal()" style="padding: 8px 16px; border: 1px solid #dadde1; background: white; border-radius: 6px; cursor: pointer;">Cancel</button>
                        <button onclick="saveCalendarEvent()" class="compose-btn">Create</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Set default times (now and +1 hour)
            const now = new Date();
            const later = new Date(now.getTime() + 60 * 60 * 1000);
            document.getElementById('eventStartTime').value = now.toISOString().slice(0, 16);
            document.getElementById('eventEndTime').value = later.toISOString().slice(0, 16);
        }

        function closeCalendarModal() {
            const modal = document.getElementById('calendarModal');
            if (modal) modal.remove();
        }

        async function saveCalendarEvent() {
            const title = document.getElementById('eventTitle').value.trim();
            const description = document.getElementById('eventDescription').value.trim();
            const location = document.getElementById('eventLocation').value.trim();
            const start_time = document.getElementById('eventStartTime').value;
            const end_time = document.getElementById('eventEndTime').value;

            if (!title) {
                showNotification('Please enter a title', 'error');
                return;
            }
            if (!start_time || !end_time) {
                showNotification('Please enter start and end times', 'error');
                return;
            }

            try {
                const response = await fetch('/api/calendar/events', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title,
                        description: description || null,
                        location: location || null,
                        start_time: new Date(start_time).toISOString(),
                        end_time: new Date(end_time).toISOString(),
                        all_day: false
                    })
                });

                if (response.ok) {
                    showNotification('Event created', 'success');
                    closeCalendarModal();
                    loadCalendarEvents();
                } else {
                    showNotification('Failed to create event', 'error');
                }
            } catch (error) {
                showNotification('Failed to create event', 'error');
            }
        }

        function editCalendarEvent(id) {
            showNotification('Calendar event editing coming soon!', 'info');
        }

        async function deleteCalendarEvent(id) {
            if (!confirm('Delete this event?')) return;
            try {
                await fetch(`/api/calendar/events/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                showNotification('Event deleted', 'success');
                loadCalendarEvents();
            } catch (error) {
                showNotification('Failed to delete event', 'error');
            }
        }

        // ===== MONEY VIEW =====
        function showMoneyView(event) {
            hideAllViews();
            let moneyView = document.getElementById('moneyView');
            if (!moneyView) {
                moneyView = createMoneyView();
                document.getElementById('dynamicViewsContainer').appendChild(moneyView);
            }
            moneyView.style.display = 'block';
            if (event) updateSidebarActive(event);
            loadMoneyAccounts();
        }

        function createMoneyView() {
            const view = document.createElement('div');
            view.id = 'moneyView';
            view.style.display = 'none';
            view.innerHTML = `
                <div style="padding: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h1 style="font-size: 24px; font-weight: 600;">💰 Money</h1>
                        <button class="compose-btn" onclick="addMoneyAccount()">+ Add Account</button>
                    </div>
                    <div id="moneyTotalBalance" style="background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                        <div style="font-size: 14px; color: #65676b; margin-bottom: 4px;">Total Balance</div>
                        <div style="font-size: 32px; font-weight: 600;">$0.00</div>
                    </div>
                    <div id="moneyAccountsList" style="display: grid; gap: 12px;">
                        <div class="loading">Loading accounts...</div>
                    </div>
                </div>
            `;
            return view;
        }

        async function loadMoneyAccounts() {
            const container = document.getElementById('moneyAccountsList');
            const balanceContainer = document.getElementById('moneyTotalBalance');
            if (!container) return;
            
            try {
                const response = await fetch('/api/money/accounts', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    renderMoneyAccounts(data.accounts);
                    if (balanceContainer) {
                        balanceContainer.innerHTML = `
                            <div style="font-size: 14px; color: #65676b; margin-bottom: 4px;">Total Balance</div>
                            <div style="font-size: 32px; font-weight: 600;">$${data.total_balance.toFixed(2)}</div>
                        `;
                    }
                } else {
                    container.innerHTML = '<div class="empty-state"><h3>No accounts</h3><p>Add an account to track your finances</p></div>';
                }
            } catch (error) {
                container.innerHTML = '<div class="empty-state"><h3>No accounts</h3><p>Add an account to track your finances</p></div>';
            }
        }

        function renderMoneyAccounts(accounts) {
            const container = document.getElementById('moneyAccountsList');
            if (accounts.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>No accounts</h3></div>';
                return;
            }
            
            container.innerHTML = accounts.map(account => `
                <div class="conversation" style="padding: 16px; background: white; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 600; margin-bottom: 4px;">${escapeHtml(account.account_name)}</div>
                            <div style="font-size: 13px; color: #8a8d91;">${escapeHtml(account.account_type)}</div>
                        </div>
                        <div style="font-size: 20px; font-weight: 600;">$${account.balance.toFixed(2)}</div>
                    </div>
                </div>
            `).join('');
        }

        function addMoneyAccount() {
            showNotification('Account creation coming soon!', 'info');
        }

        // ===== HELPER FUNCTIONS =====
        function hideAllViews() {
            document.getElementById('conversationList').style.display = 'none';
            document.getElementById('galleryContainer').style.display = 'none';
            document.getElementById('dynamicViewsContainer').style.display = 'block';
            ['chatView', 'chatInterface', 'automationsView', 'remindersView', 'calendarView', 'moneyView', 'settingsView'].forEach(id => {
                const view = document.getElementById(id);
                if (view) view.style.display = 'none';
            });
        }

        function updateSidebarActive(event) {
            if (event && event.target) {
                document.querySelectorAll('.folder-item').forEach(f => f.classList.remove('active'));
                event.target.closest('.folder-item').classList.add('active');
            }
        }

        async function loadGalleryRecents() {
            const container = document.getElementById('recentsView');
            container.innerHTML = '<div class="loading">Loading attachments...</div>';
            
            try {
                const response = await fetch('/api/attachments/gallery/recents?limit=50', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    attachments = await response.json();
                } else {
                    attachments = getMockAttachments();
                }
            } catch (error) {
                console.log('Using mock attachments');
                attachments = getMockAttachments();
            }
            
            filteredAttachments = attachments;
            renderGalleryView();
        }

        async function loadGalleryBySender() {
            const container = document.getElementById('senderView');
            container.innerHTML = '<div class="loading">Loading attachments...</div>';
            
            try {
                const response = await fetch('/api/attachments/gallery/by-sender', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const senderData = await response.json();
                    renderSenderView(senderData);
                } else {
                    renderSenderView(getMockSenderData());
                }
            } catch (error) {
                console.log('Using mock sender data');
                renderSenderView(getMockSenderData());
            }
        }

        function switchGalleryView(mode) {
            currentView = mode;
            
            // Update button states
            document.querySelectorAll('.view-mode-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.mode === mode) {
                    btn.classList.add('active');
                }
            });
            
            // Hide all views
            document.getElementById('recentsView').style.display = 'none';
            document.getElementById('senderView').style.display = 'none';
            document.getElementById('listView').style.display = 'none';
            
            // Show selected view
            if (mode === 'recents') {
                document.getElementById('recentsView').style.display = 'grid';
                renderGalleryView();
            } else if (mode === 'sender') {
                document.getElementById('senderView').style.display = 'block';
                loadGalleryBySender();
            } else if (mode === 'list') {
                document.getElementById('listView').style.display = 'block';
                renderListView();
            }
        }

        function renderGalleryView() {
            const container = document.getElementById('recentsView');
            
            if (filteredAttachments.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>No attachments found</h3><p>Attachments from your emails will appear here</p></div>';
                return;
            }
            
            container.innerHTML = '';
            
            // Pagination
            const start = (currentPage - 1) * pageSize;
            const end = start + pageSize;
            const pageAttachments = filteredAttachments.slice(start, end);
            
            pageAttachments.forEach(attachment => {
                const card = createAttachmentCard(attachment);
                container.appendChild(card);
            });
            
            updatePagination();
        }

        function createAttachmentCard(attachment) {
            const card = document.createElement('div');
            card.className = 'attachment-card';
            
            const thumbnail = getThumbnailContent(attachment);
            
            card.innerHTML = `
                <div class="attachment-thumbnail">
                    ${thumbnail}
                </div>
                <div class="attachment-info">
                    <div class="attachment-filename" title="${escapeHtml(attachment.filename)}">
                        ${escapeHtml(attachment.filename)}
                    </div>
                    <div class="attachment-meta">
                        <span>${formatFileSize(attachment.size)}</span>
                        <span>${formatDate(attachment.received_at || attachment.created_at)}</span>
                    </div>
                </div>
            `;
            
            card.addEventListener('click', () => previewAttachment(attachment));
            
            return card;
        }

        function getThumbnailContent(attachment) {
            const contentType = attachment.content_type || '';
            
            if (contentType.startsWith('image/')) {
                // Check if thumbnail exists
                if (attachment.preview_generated) {
                    return `<img src="/api/attachments/${attachment.id}/thumbnail" alt="${escapeHtml(attachment.filename)}" onerror="this.parentElement.innerHTML='🖼️'">`;
                }
                return '🖼️';
            } else if (contentType === 'application/pdf') {
                return '📄';
            } else if (contentType.includes('word') || contentType.includes('document')) {
                return '📝';
            } else if (contentType.includes('sheet') || contentType.includes('excel')) {
                return '📊';
            } else if (contentType.includes('presentation') || contentType.includes('powerpoint')) {
                return '📽️';
            } else if (contentType.includes('zip') || contentType.includes('archive') || contentType.includes('compressed')) {
                return '📦';
            } else if (contentType.includes('video')) {
                return '🎥';
            } else if (contentType.includes('audio')) {
                return '🎵';
            } else {
                return '📎';
            }
        }

        function renderSenderView(senderData) {
            const container = document.getElementById('senderView');
            
            if (!senderData || senderData.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>No attachments found</h3></div>';
                return;
            }
            
            container.innerHTML = '';
            
            senderData.forEach(sender => {
                const group = document.createElement('div');
                group.className = 'sender-group';
                
                const initial = (sender.sender_name || sender.sender_email || '?')[0].toUpperCase();
                
                group.innerHTML = `
                    <div class="sender-header">
                        <div class="sender-info">
                            <div class="sender-avatar">${initial}</div>
                            <div class="sender-details">
                                <h3>${escapeHtml(sender.sender_name || sender.sender_email)}</h3>
                                <p>${escapeHtml(sender.sender_email)}</p>
                            </div>
                        </div>
                        <div class="sender-count">${sender.attachment_count} files</div>
                    </div>
                    <div class="sender-attachments" id="sender-${sender.sender_email.replace(/[^a-z0-9]/gi, '')}">
                        <div class="loading">Loading...</div>
                    </div>
                `;
                
                group.querySelector('.sender-header').addEventListener('click', () => {
                    toggleSenderGroup(group, sender.sender_email);
                });
                
                container.appendChild(group);
            });
        }

        async function toggleSenderGroup(groupElement, senderEmail) {
            const isExpanded = groupElement.classList.contains('expanded');
            
            if (isExpanded) {
                groupElement.classList.remove('expanded');
                return;
            }
            
            groupElement.classList.add('expanded');
            
            const attachmentsContainer = groupElement.querySelector('.sender-attachments');
            
            // Load attachments for this sender
            try {
                const response = await fetch(`/api/attachments/gallery?sender=${encodeURIComponent(senderEmail)}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                let senderAttachments;
                if (response.ok) {
                    const data = await response.json();
                    senderAttachments = data.attachments || data;
                } else {
                    senderAttachments = attachments.filter(a => a.sender_email === senderEmail);
                }
                
                renderSenderAttachments(attachmentsContainer, senderAttachments);
            } catch (error) {
                const senderAttachments = attachments.filter(a => a.sender_email === senderEmail);
                renderSenderAttachments(attachmentsContainer, senderAttachments);
            }
        }

        function renderSenderAttachments(container, attachments) {
            if (attachments.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No attachments</p></div>';
                return;
            }
            
            container.innerHTML = '';
            
            attachments.forEach(attachment => {
                const item = document.createElement('div');
                item.className = 'attachment-list-item';
                
                const icon = getThumbnailContent(attachment);
                const hasImage = attachment.content_type?.startsWith('image/') && attachment.preview_generated;
                
                item.innerHTML = `
                    <div class="attachment-icon">
                        ${hasImage ? `<img src="/api/attachments/${attachment.id}/thumbnail" alt="${escapeHtml(attachment.filename)}">` : icon}
                    </div>
                    <div class="attachment-details">
                        <h4>${escapeHtml(attachment.filename)}</h4>
                        <p>${formatFileSize(attachment.size)} • ${formatDate(attachment.received_at || attachment.created_at)}</p>
                    </div>
                `;
                
                item.addEventListener('click', () => previewAttachment(attachment));
                
                container.appendChild(item);
            });
        }

        function renderListView() {
            const container = document.getElementById('listView');
            
            if (filteredAttachments.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>No attachments found</h3></div>';
                return;
            }
            
            container.innerHTML = '';
            
            // Create table
            const table = document.createElement('div');
            table.style.background = 'white';
            table.style.borderRadius = '8px';
            table.style.overflow = 'hidden';
            
            const start = (currentPage - 1) * pageSize;
            const end = start + pageSize;
            const pageAttachments = filteredAttachments.slice(start, end);
            
            pageAttachments.forEach(attachment => {
                const row = document.createElement('div');
                row.className = 'attachment-list-item';
                row.style.margin = '0';
                row.style.borderRadius = '0';
                row.style.borderBottom = '1px solid #e4e6eb';
                
                const icon = getThumbnailContent(attachment);
                
                row.innerHTML = `
                    <div class="attachment-icon">
                        ${icon}
                    </div>
                    <div class="attachment-details" style="flex: 2;">
                        <h4>${escapeHtml(attachment.filename)}</h4>
                    </div>
                    <div style="flex: 1; font-size: 13px; color: #65676b;">
                        ${escapeHtml(attachment.sender_name || attachment.sender_email || 'Unknown')}
                    </div>
                    <div style="flex: 1; font-size: 13px; color: #65676b;">
                        ${formatDate(attachment.received_at || attachment.created_at)}
                    </div>
                    <div style="flex: 0.5; font-size: 13px; color: #65676b; text-align: right;">
                        ${formatFileSize(attachment.size)}
                    </div>
                `;
                
                row.addEventListener('click', () => previewAttachment(attachment));
                
                table.appendChild(row);
            });
            
            container.appendChild(table);
            updatePagination();
        }

        function searchAttachments() {
            const query = document.getElementById('gallerySearchInput').value.toLowerCase();
            
            if (!query) {
                filteredAttachments = attachments;
            } else {
                filteredAttachments = attachments.filter(att => 
                    att.filename.toLowerCase().includes(query) ||
                    (att.sender_name && att.sender_name.toLowerCase().includes(query)) ||
                    (att.sender_email && att.sender_email.toLowerCase().includes(query))
                );
            }
            
            currentPage = 1;
            applyFilters();
        }

        function applyFilters() {
            const dateFilter = document.getElementById('filterDate').value;
            const typeFilter = document.getElementById('filterType').value;
            const sizeFilter = document.getElementById('filterSize').value;
            
            let filtered = filteredAttachments;
            
            // Date filter
            if (dateFilter) {
                const now = new Date();
                filtered = filtered.filter(att => {
                    const attDate = new Date(att.received_at || att.created_at);
                    const diffDays = Math.floor((now - attDate) / (1000 * 60 * 60 * 24));
                    
                    if (dateFilter === 'today') return diffDays === 0;
                    if (dateFilter === 'week') return diffDays <= 7;
                    if (dateFilter === 'month') return diffDays <= 30;
                    return true;
                });
            }
            
            // Type filter
            if (typeFilter) {
                filtered = filtered.filter(att => {
                    const contentType = att.content_type || '';
                    
                    if (typeFilter === 'image') return contentType.startsWith('image/');
                    if (typeFilter === 'pdf') return contentType === 'application/pdf';
                    if (typeFilter === 'document') return contentType.includes('word') || contentType.includes('document');
                    if (typeFilter === 'spreadsheet') return contentType.includes('sheet') || contentType.includes('excel');
                    if (typeFilter === 'archive') return contentType.includes('zip') || contentType.includes('archive');
                    return true;
                });
            }
            
            // Size filter
            if (sizeFilter) {
                filtered = filtered.filter(att => {
                    const sizeMB = att.size / (1024 * 1024);
                    
                    if (sizeFilter === 'small') return sizeMB < 1;
                    if (sizeFilter === 'medium') return sizeMB >= 1 && sizeMB <= 10;
                    if (sizeFilter === 'large') return sizeMB > 10;
                    return true;
                });
            }
            
            filteredAttachments = filtered;
            currentPage = 1;
            
            if (currentView === 'recents') {
                renderGalleryView();
            } else if (currentView === 'list') {
                renderListView();
            }
        }

        function previewAttachment(attachment) {
            const modal = document.getElementById('previewModal');
            const content = modal.querySelector('.preview-content');
            
            const contentType = attachment.content_type || '';
            const isImage = contentType.startsWith('image/');
            const isPDF = contentType === 'application/pdf';
            
            let previewBody = '';
            if (isImage) {
                previewBody = `<img src="/api/attachments/${attachment.id}" alt="${escapeHtml(attachment.filename)}">`;
            } else if (isPDF) {
                previewBody = `<iframe src="/api/attachments/${attachment.id}" style="width: 100%; height: 500px; border: none;"></iframe>`;
            } else {
                previewBody = `<div style="text-align: center; padding: 40px;"><div style="font-size: 64px; margin-bottom: 16px;">${getThumbnailContent(attachment)}</div><p>Preview not available for this file type</p></div>`;
            }
            
            content.innerHTML = `
                <div class="preview-header">
                    <h3>${escapeHtml(attachment.filename)}</h3>
                    <div class="preview-actions">
                        <button class="btn-secondary" onclick="downloadAttachment('${attachment.id}', '${escapeHtml(attachment.filename)}')">Download</button>
                        <button class="btn-secondary" onclick="deleteAttachment('${attachment.id}')">Delete</button>
                        <button class="close-btn" onclick="closePreview()">×</button>
                    </div>
                </div>
                <div class="preview-body">
                    ${previewBody}
                </div>
                <div class="preview-metadata">
                    <div class="metadata-row">
                        <span class="metadata-label">From:</span>
                        <span class="metadata-value">${escapeHtml(attachment.sender_name || attachment.sender_email || 'Unknown')}</span>
                    </div>
                    <div class="metadata-row">
                        <span class="metadata-label">Date:</span>
                        <span class="metadata-value">${formatDate(attachment.received_at || attachment.created_at)}</span>
                    </div>
                    <div class="metadata-row">
                        <span class="metadata-label">Size:</span>
                        <span class="metadata-value">${formatFileSize(attachment.size)}</span>
                    </div>
                    <div class="metadata-row">
                        <span class="metadata-label">Type:</span>
                        <span class="metadata-value">${escapeHtml(attachment.content_type || 'Unknown')}</span>
                    </div>
                </div>
            `;
            
            modal.classList.add('active');
        }

        function closePreview() {
            document.getElementById('previewModal').classList.remove('active');
        }

        async function downloadAttachment(attachmentId, filename) {
            try {
                const response = await fetch(`/api/attachments/${attachmentId}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    showNotification('Download started', 'success');
                } else {
                    throw new Error('Download failed');
                }
            } catch (error) {
                showNotification('Download failed (demo mode)', 'info');
            }
        }

        async function deleteAttachment(attachmentId) {
            if (!confirm('Are you sure you want to delete this attachment?')) return;
            
            try {
                const response = await fetch(`/api/attachments/${attachmentId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    showNotification('Attachment deleted', 'success');
                    closePreview();
                    
                    // Remove from local state
                    attachments = attachments.filter(a => a.id !== attachmentId);
                    filteredAttachments = filteredAttachments.filter(a => a.id !== attachmentId);
                    
                    // Re-render current view
                    if (currentView === 'recents') {
                        renderGalleryView();
                    } else if (currentView === 'list') {
                        renderListView();
                    } else if (currentView === 'sender') {
                        loadGalleryBySender();
                    }
                } else {
                    throw new Error('Delete failed');
                }
            } catch (error) {
                showNotification('Delete failed (demo mode)', 'info');
                closePreview();
            }
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
            return (bytes / (1024 * 1024 * 1024)).toFixed(1) + ' GB';
        }

        function updatePagination() {
            const pagination = document.getElementById('galleryPagination');
            const totalPages = Math.ceil(filteredAttachments.length / pageSize);
            
            if (totalPages <= 1) {
                pagination.style.display = 'none';
                return;
            }
            
            pagination.style.display = 'flex';
            document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
            
            const prevBtn = pagination.querySelector('button:first-child');
            const nextBtn = pagination.querySelector('button:last-child');
            
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages;
        }

        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                if (currentView === 'recents') {
                    renderGalleryView();
                } else if (currentView === 'list') {
                    renderListView();
                }
            }
        }

        function nextPage() {
            const totalPages = Math.ceil(filteredAttachments.length / pageSize);
            if (currentPage < totalPages) {
                currentPage++;
                if (currentView === 'recents') {
                    renderGalleryView();
                } else if (currentView === 'list') {
                    renderListView();
                }
            }
        }

        // Close preview modal when clicking outside
        document.getElementById('previewModal')?.addEventListener('click', (e) => {
            if (e.target.id === 'previewModal') {
                closePreview();
            }
        });

        // Mock data for attachments
        function getMockAttachments() {
            return [
                {
                    id: 'att1',
                    filename: 'project-proposal.pdf',
                    content_type: 'application/pdf',
                    size: 2457600,
                    sender_email: 'john@example.com',
                    sender_name: 'John Doe',
                    received_at: new Date(Date.now() - 3600000).toISOString(),
                    preview_generated: false
                },
                {
                    id: 'att2',
                    filename: 'vacation-photo.jpg',
                    content_type: 'image/jpeg',
                    size: 1536000,
                    sender_email: 'jane@example.com',
                    sender_name: 'Jane Smith',
                    received_at: new Date(Date.now() - 7200000).toISOString(),
                    preview_generated: true
                },
                {
                    id: 'att3',
                    filename: 'quarterly-report.xlsx',
                    content_type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                    size: 524288,
                    sender_email: 'finance@example.com',
                    sender_name: 'Finance Team',
                    received_at: new Date(Date.now() - 86400000).toISOString(),
                    preview_generated: false
                },
                {
                    id: 'att4',
                    filename: 'meeting-notes.docx',
                    content_type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                    size: 102400,
                    sender_email: 'john@example.com',
                    sender_name: 'John Doe',
                    received_at: new Date(Date.now() - 172800000).toISOString(),
                    preview_generated: false
                },
                {
                    id: 'att5',
                    filename: 'presentation.pptx',
                    content_type: 'application/vnd.openxmlformats-officedocument.presentationml.presentation',
                    size: 5242880,
                    sender_email: 'jane@example.com',
                    sender_name: 'Jane Smith',
                    received_at: new Date(Date.now() - 259200000).toISOString(),
                    preview_generated: false
                }
            ];
        }

        function getMockSenderData() {
            return [
                {
                    sender_email: 'john@example.com',
                    sender_name: 'John Doe',
                    attachment_count: 2
                },
                {
                    sender_email: 'jane@example.com',
                    sender_name: 'Jane Smith',
                    attachment_count: 2
                },
                {
                    sender_email: 'finance@example.com',
                    sender_name: 'Finance Team',
                    attachment_count: 1
                }
            ];
        }

        // Debug Modal Functions
        async function openDebugModal() {
            document.getElementById('debugModal').classList.add('active');
            await loadDebugInfo();
        }

        function closeDebugModal() {
            document.getElementById('debugModal').classList.remove('active');
        }

        async function loadDebugInfo() {
            const debugContent = document.getElementById('debugContent');
            try {
                const response = await fetch('http://localhost:8080/api/debug/sync', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load debug info');
                }

                const data = await response.json();
                
                debugContent.innerHTML = `
                    <div style="font-family: monospace; font-size: 14px;">
                        <h3>User Information</h3>
                        <table style="width: 100%; border-collapse: collapse;">
                            <tr><td style="padding: 8px; border: 1px solid #ddd;"><strong>User ID:</strong></td><td style="padding: 8px; border: 1px solid #ddd;">${data.user_id}</td></tr>
                            <tr><td style="padding: 8px; border: 1px solid #ddd;"><strong>Email:</strong></td><td style="padding: 8px; border: 1px solid #ddd;">${data.email}</td></tr>
                            <tr><td style="padding: 8px; border: 1px solid #ddd;"><strong>OAuth Provider:</strong></td><td style="padding: 8px; border: 1px solid #ddd;">${data.oauth_provider || 'None'}</td></tr>
                        </table>

                        <h3 style="margin-top: 20px;">Service Status</h3>
                        <table style="width: 100%; border-collapse: collapse;">
                            <tr><td style="padding: 8px; border: 1px solid #ddd;"><strong>Services Initialized:</strong></td><td style="padding: 8px; border: 1px solid #ddd;">${data.is_initialized ? '✅ Yes' : '❌ No'}</td></tr>
                            <tr><td style="padding: 8px; border: 1px solid #ddd;"><strong>IMAP Service:</strong></td><td style="padding: 8px; border: 1px solid #ddd;">${data.has_imap_service ? '✅ Active' : '❌ Inactive'}</td></tr>
                            <tr><td style="padding: 8px; border: 1px solid #ddd;"><strong>SMTP Service:</strong></td><td style="padding: 8px; border: 1px solid #ddd;">${data.has_smtp_service ? '✅ Active' : '❌ Inactive'}</td></tr>
                            <tr><td style="padding: 8px; border: 1px solid #ddd;"><strong>OAuth Tokens:</strong></td><td style="padding: 8px; border: 1px solid #ddd;">${data.has_oauth_tokens ? '✅ Present' : '❌ Missing'}</td></tr>
                        </table>

                        <h3 style="margin-top: 20px;">Server Configuration</h3>
                        <table style="width: 100%; border-collapse: collapse;">
                            <tr><td style="padding: 8px; border: 1px solid #ddd;"><strong>IMAP Host:</strong></td><td style="padding: 8px; border: 1px solid #ddd;">${data.imap_host}:${data.imap_port}</td></tr>
                            <tr><td style="padding: 8px; border: 1px solid #ddd;"><strong>SMTP Host:</strong></td><td style="padding: 8px; border: 1px solid #ddd;">${data.smtp_host}:${data.smtp_port}</td></tr>
                        </table>

                        <h3 style="margin-top: 20px;">Email Statistics</h3>
                        <table style="width: 100%; border-collapse: collapse;">
                            <tr><td style="padding: 8px; border: 1px solid #ddd;"><strong>Total Emails:</strong></td><td style="padding: 8px; border: 1px solid #ddd;">${data.total_emails}</td></tr>
                        </table>

                        ${data.emails_by_folder.length > 0 ? `
                            <h4 style="margin-top: 10px;">Emails by Folder:</h4>
                            <table style="width: 100%; border-collapse: collapse;">
                                ${data.emails_by_folder.map(f => `
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;">${f.folder}</td><td style="padding: 8px; border: 1px solid #ddd;">${f.count}</td></tr>
                                `).join('')}
                            </table>
                        ` : '<p style="color: #999; margin-top: 10px;">No emails found in database</p>'}
                    </div>
                `;
            } catch (error) {
                console.error('Failed to load debug info:', error);
                debugContent.innerHTML = `
                    <div style="color: #d32f2f; padding: 20px; text-align: center;">
                        <p><strong>Error loading debug information</strong></p>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        async function testImapConnection() {
            const debugContent = document.getElementById('debugContent');
            const originalContent = debugContent.innerHTML;
            
            debugContent.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="spinner"></div><p>Testing IMAP connection...</p></div>';
            
            try {
                const response = await fetch('http://localhost:8080/api/debug/test-imap', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                    }
                });

                const data = await response.json();
                
                debugContent.innerHTML = originalContent + `
                    <div style="margin-top: 20px; padding: 15px; border-radius: 8px; background: ${data.success ? '#e8f5e9' : '#ffebee'};">
                        <h3 style="color: ${data.success ? '#2e7d32' : '#c62828'};">IMAP Connection Test</h3>
                        <p><strong>Status:</strong> ${data.success ? '✅ Success' : '❌ Failed'}</p>
                        <p><strong>Message:</strong> ${data.message}</p>
                        ${data.folders ? `
                            <p><strong>Available Folders:</strong></p>
                            <ul>
                                ${data.folders.map(f => `<li>${f}</li>`).join('')}
                            </ul>
                        ` : ''}
                        ${data.error ? `<p style="color: #c62828;"><strong>Error:</strong> ${data.error}</p>` : ''}
                    </div>
                `;
            } catch (error) {
                debugContent.innerHTML = originalContent + `
                    <div style="margin-top: 20px; padding: 15px; border-radius: 8px; background: #ffebee;">
                        <h3 style="color: #c62828;">IMAP Connection Test Failed</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        async function triggerManualSync() {
            const debugContent = document.getElementById('debugContent');
            const originalContent = debugContent.innerHTML;
            
            debugContent.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="spinner"></div><p>Syncing emails...</p></div>';
            
            try {
                const response = await fetch('http://localhost:8080/api/debug/manual-sync', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                    }
                });

                const data = await response.json();
                
                debugContent.innerHTML = originalContent + `
                    <div style="margin-top: 20px; padding: 15px; border-radius: 8px; background: ${data.success ? '#e8f5e9' : '#ffebee'};">
                        <h3 style="color: ${data.success ? '#2e7d32' : '#c62828'};">Manual Sync Result</h3>
                        <p><strong>Status:</strong> ${data.success ? '✅ Success' : '❌ Failed'}</p>
                        ${data.synced_counts ? `
                            <p><strong>Synced Emails:</strong></p>
                            <ul>
                                ${Object.entries(data.synced_counts).map(([folder, count]) => `<li>${folder}: ${count} emails</li>`).join('')}
                            </ul>
                        ` : ''}
                        ${data.errors && data.errors.length > 0 ? `
                            <p style="color: #c62828;"><strong>Errors:</strong></p>
                            <ul style="color: #c62828;">
                                ${data.errors.map(err => `<li>${err}</li>`).join('')}
                            </ul>
                        ` : ''}
                    </div>
                `;
                
                // Reload conversations after sync
                if (data.success) {
                    setTimeout(() => {
                        loadConversations(currentFolder);
                    }, 1000);
                }
            } catch (error) {
                debugContent.innerHTML = originalContent + `
                    <div style="margin-top: 20px; padding: 15px; border-radius: 8px; background: #ffebee;">
                        <h3 style="color: #c62828;">Manual Sync Failed</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>
