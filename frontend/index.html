<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Goose Hub</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #ffffff;
            color: rgb(16,23,41);
            font-weight: 400;
            line-height: 1.5;
        }

        /* Login Screen Styles */
        .login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: #ffffff;
        }

        .login-container {
            background: white;
            border: 1px solid rgb(16,23,41);
            width: 100%;
            max-width: 400px;
            padding: 40px;
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-header h1 {
            color: #0066FF;
            font-size: 32px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .login-header p {
            color: rgb(80,91,109);
            font-size: 16px;
            font-weight: 400;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: rgb(16,23,41);
            font-size: 14px;
        }

        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid rgb(16,23,41);
            border-radius: 0;
            font-size: 16px;
            background: #ffffff;
        }

        .form-group input:focus {
            outline: none;
            border-color: #0066FF;
            border-width: 2px;
        }

        .login-btn {
            width: 100%;
            padding: 12px;
            background: #0066FF;
            color: white;
            border: none;
            border-radius: 0;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        .login-btn:hover {
            background: #0052CC;
        }

        .login-btn:disabled {
            background: #CCCCCC;
            cursor: not-allowed;
        }

        .settings-link {
            text-align: center;
            margin-top: 16px;
        }

        .demo-notice {
            background: #F5F5F5;
            color: rgb(16,23,41);
            padding: 12px;
            margin-bottom: 20px;
            border-left: 2px solid rgb(16,23,41);
            font-size: 14px;
        }

        .error-message, .success-message {
            padding: 12px;
            margin-bottom: 20px;
            border-left: 2px solid;
            display: none;
        }

        .error-message {
            background: #F5F5F5;
            color: rgb(16,23,41);
            border-color: rgb(16,23,41);
        }

        .success-message {
            background: #F5F5F5;
            color: rgb(16,23,41);
            border-color: #0066FF;
        }

        /* Main App Styles */
        .main-app {
            display: none;
        }

        .main-app.active {
            display: block;
        }

        .header {
            background: white;

            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            color: rgb(16,23,41);
            letter-spacing: -0.5px;
        }

        .search-bar {
            flex: 1;
            max-width: 400px;
            margin: 0 20px;
        }

        .search-bar input {
            width: 100%;
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            background: rgb(244,244,245);
            outline: none;
            font-size: 14px;
        }

        .compose-btn {
            background: rgb(244,244,245);
            color: rgb(16,23,41);
            border: none;
            border-radius: 30px;

            padding: 8px 20px;
            cursor: pointer;
            font-weight: normal;
            font-size: 14px;
        }

        .compose-btn:hover {
            background: rgb(41,101,246);
            color: #fff;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .logout-btn {
            background: #ffffff;
            color: rgb(16,23,41);
            border: 1px solid rgb(16,23,41);
            padding: 8px 16px;
            border-radius: 0;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
        }

        .container {
            display: flex;

            margin: 20px auto;
            gap: 0;
            padding: 0 20px;
        }

        .sidebar {
            width: 240px;
            background: white;
            border-right: 1px solid rgb(229,229,229);
            padding: 0 20px 0 0;


            top: 80px;
            width: 200px;
        }

        .folder-item {
            padding: 10px 12px;
            border-radius: 0;
            cursor: pointer;
            align-items: center;
            margin-bottom: 0;
            width: 160px;

            font-size: 14px;
            font-weight: 400;
        }

        .folder-item:hover {
            background: rgb(244,244,245);
            border-radius: 8px;
        }

        .unread-count {
            background: #0066FF;
            color: white;
            padding: 2px 8px;
            border-radius: 0;
            font-size: 12px;
            font-weight: 600;
        }

        .main-content {
            flex: 1;
        }

        .conversation {
            background: white;
            border-radius: 0;
            margin-bottom: 0;
            padding: 12px 16px;
            width: 80%;

            cursor: pointer;
        }

        .conversation:hover {
            background: #F5F5F5;
        }

        .automationsList .conversation {

        }

        .conversation-line {
            display: flex;
            gap: 12px;
            justify-content: space-between;
            align-items: flex-start;
        }

        .timestamp {
            color: rgb(80,91,109);
            font-size: 13px;
            font-weight: 400;
            white-space: nowrap;
        }

        .conversation-info {
            flex: 1;
            min-width: 0;
        }

        .subject-line {
            font-size: 14px;
            font-weight: 500;
            color: rgb(16,23,41);
            margin-bottom: 4px;
        }

        .content-snippet {
            color: rgb(80,91,109);
            font-size: 13px;
            line-height: 1.4;
            font-weight: 400;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .conversation-actions-hover {
            display: none;
            gap: 8px;
            margin-left: 12px;
        }

        .conversation:hover .conversation-actions-hover {
            display: flex;
        }

        .icon-btn {
            background: transparent;
            border: 1px solid rgb(16,23,41);
            width: 32px;
            height: 32px;
            border-radius: 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .icon-btn:hover {
            background: #F5F5F5;
        }

        /* Slideover Panel */
        .slideover-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.3);
            z-index: 1000;
            display: none;
        }

        .slideover-overlay.active {
            display: block;
        }

        .slideover-panel {
            position: fixed;
            top: 0;
            right: -600px;
            width: 600px;
            height: 100%;
            background: white;
            border-left: 1px solid rgb(16,23,41);
            z-index: 1001;
            display: flex;
            flex-direction: column;
        }

        .slideover-overlay.active .slideover-panel {
            right: 0;
        }

        .slideover-header {
            padding: 20px;
            border-bottom: 1px solid rgb(16,23,41);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .slideover-header h2 {
            font-size: 18px;
            font-weight: 600;
            color: rgb(16,23,41);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: rgb(16,23,41);
            width: 36px;
            height: 36px;
            border-radius: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            background: #F5F5F5;
        }

        .slideover-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .chat-message {
            margin-bottom: 20px;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .message-sender {
            font-weight: 600;
            color: rgb(16,23,41);
            font-size: 14px;
        }

        .message-time {
            color: rgb(80,91,109);
            font-size: 13px;
            font-weight: 400;
        }

        .message-body {
            background: #F5F5F5;
            padding: 12px 16px;
            border-radius: 0;
            line-height: 1.5;
            color: rgb(16,23,41);
        }

        .slideover-footer {
            padding: 20px;
            border-top: 1px solid rgb(16,23,41);
        }

        .reply-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .reply-box {
            display: flex;
            gap: 8px;
        }

        .reply-box textarea {
            flex: 1;
            padding: 12px;
            border: 1px solid rgb(16,23,41);
            border-radius: 0;
            resize: none;
            font-family: inherit;
            font-size: 14px;
            min-height: 44px;
            max-height: 120px;
        }

        .reply-box textarea:focus {
            outline: none;
            border-color: #0066FF;
            border-width: 2px;
        }

        .send-btn {
            background: #0066FF;
            color: white;
            border: none;
            padding: 0 20px;
            border-radius: 0;
            cursor: pointer;
            font-weight: 500;
        }

        .send-btn:hover {
            background: #0052CC;
        }

        .unread {
            /*border-left: 2px solid #0066FF;*/
        }

        .loading, .empty-state {
            text-align: center;
            padding: 40px;
            color: rgb(80,91,109);
            font-weight: 400;
        }

        .empty-state h3 {
            margin-bottom: 8px;
            color: rgb(16,23,41);
            font-weight: 600;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border: 1px solid rgb(16,23,41);
            background: white;
            z-index: 10000;
        }

        .notification.success {
            border-left: 2px solid #0066FF;
        }

        .notification.error {
            border-left: 2px solid rgb(16,23,41);
        }

        .notification.info {
            border-left: 2px solid rgb(80,91,109);
        }

        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.3);
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .compose-modal {
            background: white;
            padding: 30px;
            border: 1px solid rgb(16,23,41);
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .compose-modal h2 {
            margin-bottom: 20px;
            color: rgb(16,23,41);
            font-weight: 600;
        }

        .compose-modal .form-group {
            margin-bottom: 15px;
        }

        .compose-modal textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid rgb(16,23,41);
            border-radius: 0;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            min-height: 150px;
        }

        .compose-modal textarea:focus {
            outline: none;
            border-color: #0066FF;
            border-width: 2px;
        }

        .drop-zone {
            border: 1px dashed rgb(16,23,41);
            border-radius: 0;
            padding: 20px;
            text-align: center;
            background: #F5F5F5;
            cursor: pointer;
            margin-bottom: 16px;
        }

        .drop-zone:hover {
            background: #E5E5E5;
        }

        .drop-zone.active {
            background: #E5E5E5;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .btn-secondary {
            padding: 10px 20px;
            border: 1px solid rgb(16,23,41);
            background: white;
            border-radius: 0;
            cursor: pointer;
            font-weight: 500;
        }

        .btn-secondary:hover {
            background: #F5F5F5;
        }

        .btn-primary {
            padding: 10px 20px;
            background: #0066FF;
            color: white;
            border: none;
            border-radius: 0;
            cursor: pointer;
            font-weight: 500;
        }

        .btn-primary:hover {
            background: #0052CC;
        }

        .btn-primary:disabled {
            background: #CCCCCC;
            cursor: not-allowed;
        }

        /* Attachment Gallery Styles */
        .gallery-container {
            display: none;
        }

        .gallery-container.active {
            display: block;
        }

        .gallery-header {
            background: white;
            border-bottom: 1px solid rgb(16,23,41);
            padding: 20px;
            margin-bottom: 20px;
        }

        .gallery-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 16px;
            color: rgb(16,23,41);
        }

        .gallery-controls {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
        }

        .view-mode-switcher {
            display: flex;
            gap: 4px;
            border: 1px solid rgb(16,23,41);
            padding: 4px;
        }

        .view-mode-btn {
            padding: 8px 16px;
            border: none;
            background: transparent;
            border-radius: 0;
            cursor: pointer;
            font-weight: 500;
            color: rgb(80,91,109);
        }

        .view-mode-btn.active {
            background: rgb(16,23,41);
            color: #ffffff;
        }

        .view-mode-btn:hover:not(.active) {
            background: #F5F5F5;
        }

        .gallery-search {
            flex: 1;
            min-width: 200px;
        }

        .gallery-search input {
            width: 100%;
            padding: 10px 16px;
            border: 1px solid #dadde1;
            border-radius: 8px;
            font-size: 14px;
        }

        .gallery-search input:focus {
            outline: none;
            border-color: #7C9CBF;
        }

        .filter-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .filter-select {
            padding: 8px 12px;
            border: 1px solid #dadde1;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 14px;
        }

        .filter-select:focus {
            outline: none;
            border-color: #7C9CBF;
        }

        /* Grid View */
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
        }

        .attachment-card {
            background: white;
            border: 1px solid rgb(16,23,41);
            overflow: hidden;
            cursor: pointer;
        }

        .attachment-card:hover {
            background: #F5F5F5;
        }

        .attachment-thumbnail {
            width: 100%;
            height: 150px;
            background: #F5F5F5;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            position: relative;
            overflow: hidden;
        }

        .attachment-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .attachment-info {
            padding: 12px;
        }

        .attachment-filename {
            font-weight: 500;
            font-size: 14px;
            color: rgb(16,23,41);
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .attachment-meta {
            font-size: 12px;
            color: rgb(80,91,109);
            display: flex;
            justify-content: space-between;
        }

        /* Sender View */
        .sender-list {
            background: white;
            border: 1px solid rgb(16,23,41);
            overflow: hidden;
        }

        .sender-group {
            border-bottom: 1px solid rgb(16,23,41);
        }

        .sender-group:last-child {
            border-bottom: none;
        }

        .sender-header {
            padding: 16px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
        }

        .sender-header:hover {
            background: #F5F5F5;
        }

        .sender-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .sender-avatar {
            width: 40px;
            height: 40px;
            border-radius: 0;
            background: #0066FF;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .sender-details h3 {
            font-size: 15px;
            font-weight: 600;
            color: rgb(16,23,41);
            margin-bottom: 2px;
        }

        .sender-details p {
            font-size: 13px;
            color: rgb(80,91,109);
        }

        .sender-count {
            background: #F5F5F5;
            color: rgb(16,23,41);
            padding: 4px 12px;
            border-radius: 0;
            font-size: 13px;
            font-weight: 600;
        }

        .sender-attachments {
            padding: 16px;
            background: #F5F5F5;
            display: none;
        }

        .sender-group.expanded .sender-attachments {
            display: block;
        }

        .sender-group.expanded .sender-header::after {
            content: '‚ñº';
        }

        .sender-header::after {
            content: '‚ñ∂';
            color: rgb(80,91,109);
            font-size: 12px;
        }

        .attachment-list-item {
            padding: 12px;
            background: white;
            border: 1px solid rgb(16,23,41);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
        }

        .attachment-list-item:hover {
            background: #F5F5F5;
        }

        .attachment-icon {
            width: 48px;
            height: 48px;
            border-radius: 0;
            background: #F5F5F5;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            flex-shrink: 0;
        }

        .attachment-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 0;
        }

        .attachment-details {
            flex: 1;
            min-width: 0;
        }

        .attachment-details h4 {
            font-size: 14px;
            font-weight: 500;
            color: rgb(16,23,41);
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .attachment-details p {
            font-size: 12px;
            color: rgb(80,91,109);
        }

        /* Preview Modal */
        .preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .preview-modal.active {
            display: flex;
        }

        .preview-content {
            max-width: 90%;
            max-height: 90%;
            background: white;
            border: 1px solid rgb(16,23,41);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .preview-header {
            padding: 16px 20px;
            border-bottom: 1px solid rgb(16,23,41);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .preview-header h3 {
            font-size: 16px;
            font-weight: 600;
            color: rgb(16,23,41);
        }

        .preview-actions {
            display: flex;
            gap: 8px;
        }

        .preview-body {
            flex: 1;
            overflow: auto;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: #F5F5F5;
        }

        .preview-body img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .preview-metadata {
            padding: 16px 20px;
            border-top: 1px solid rgb(16,23,41);
            background: white;
        }

        .metadata-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 14px;
        }

        .metadata-label {
            color: rgb(80,91,109);
            font-weight: 500;
        }

        .metadata-value {
            color: rgb(16,23,41);
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            padding: 20px;
            background: white;
            border-top: 1px solid rgb(16,23,41);
            margin-top: 20px;
        }

        .pagination button {
            padding: 8px 16px;
            border: 1px solid rgb(16,23,41);
            background: white;
            border-radius: 0;
            cursor: pointer;
            font-weight: 500;
        }

        .pagination button:hover:not(:disabled) {
            background: #F5F5F5;
        }

        .pagination button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .pagination span {
            color: rgb(80,91,109);
            font-size: 14px;
        }

        /* Filter Buttons */
        .filter-btn {
            padding: 8px 16px;
            background: rgb(244,244,245);
            color: rgb(16,23,41);
            border: none;
            border-radius: 30px;

            cursor: pointer;
            font-size: 14px;
        }

        .filter-btn:hover {
            background: rgb(41,101,246);
            color: white;
        }

        .filter-btn.active {
            background: rgb(16,23,41);
            color: white;
            border-color: rgb(16,23,41);
        }

        /* Notifications */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-width: 400px;
        }

        .notification {
            background: white;
            border: 1px solid rgb(16,23,41);
            padding: 16px;
            display: flex;
            align-items: start;
            gap: 12px;
            border-left: 2px solid;
        }

        .notification.success {
            border-color: #0066FF;
        }

        .notification.error {
            border-color: rgb(16,23,41);
        }

        .notification.info {
            border-color: rgb(80,91,109);
        }

        .notification.warning {
            border-color: rgb(16,23,41);
        }

        .notification-content {
            flex: 1;
            font-size: 14px;
            color: rgb(16,23,41);
        }

        /* Settings Modal Styles */
        .settings-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.3);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .settings-modal-overlay.active {
            display: flex;
        }

        .settings-modal {
            background: white;
            border: 1px solid rgb(16,23,41);
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .settings-modal h2 {
            margin: 0 0 8px 0;
            font-size: 24px;
            color: rgb(16,23,41);
            font-weight: 600;
        }

        .settings-modal .subtitle {
            color: rgb(80,91,109);
            margin-bottom: 24px;
            font-size: 14px;
        }

        .settings-section {
            margin-bottom: 24px;
            padding-bottom: 24px;
            border-bottom: 1px solid rgb(16,23,41);
        }

        .settings-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .settings-section h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            color: rgb(16,23,41);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .form-group-small {
            margin-bottom: 12px;
        }

        .form-group-small label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            font-size: 14px;
            color: rgb(16,23,41);
        }

        .form-group-small input,
        .form-group-small select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid rgb(16,23,41);
            border-radius: 0;
            font-size: 14px;
        }

        .form-group-small input:focus,
        .form-group-small select:focus {
            outline: none;
            border-color: #0066FF;
            border-width: 2px;
        }

        .help-text {
            font-size: 12px;
            color: rgb(80,91,109);
            margin-top: 4px;
        }

        .modal-footer {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid rgb(16,23,41);
        }

        .btn-link {
            background: none;
            border: none;
            color: #0066FF;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
            padding: 0;
        }

        .btn-link:hover {
            text-decoration: underline;
        }

        .settings-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
            padding: 12px;
            background: #F5F5F5;
            border: 1px solid rgb(16,23,41);
            cursor: pointer;
        }

        .settings-toggle input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .settings-toggle label {
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            margin: 0;
            color: rgb(16,23,41);
        }

        .collapsible-section {
            display: none;
        }

        /* Tab Views - Chat, Automations, Calendar, Money, Attachments, Settings */
        .tab-view {
            padding: 20px;
            font-size: 14px;
        }

        .tab-view-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .tab-view-title {
            font-size: 20px;
            font-weight: 600;
        }

        .tab-view-content {
            display: grid;
            gap: 12px;
        }

        .tab-card {
            padding: 16px;
            background: white;
            border-radius: 8px;
        }

        .tab-card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
        }

        .tab-card-body {
            flex: 1;
        }

        .tab-card-title {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .tab-card-description {
            color: rgb(80,91,109);
            font-size: 14px;
            margin-bottom: 8px;
        }

        .tab-card-meta {
            font-size: 13px;
            color: #8a8d91;
        }

        .tab-card-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .tab-card-toggle {
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .tab-card-toggle input {
            margin-right: 4px;
        }

    </style>
</head>
<body>
    <!-- Notification Container -->
    <div class="notification-container" id="notificationContainer"></div>

    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-container">
            <div class="login-header">
                <h1>üìß Goose Hub</h1>
            </div>

            <div class="demo-notice">
                <strong>Demo Mode:</strong> You can use any username/password to login and explore the features.
            </div>

            <div id="loginError" class="error-message"></div>
            <div id="loginSuccess" class="success-message"></div>

            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Username or Email</label>
                    <input type="text" id="username" name="username" required>
                </div>

                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password" required>
                </div>

                <button type="submit" class="login-btn" id="loginBtn">Sign In</button>
            </form>

            <div style="text-align: center; margin: 20px 0; color: #65676b; font-size: 14px;">
                <span>or</span>
            </div>

            <button type="button" class="login-btn" id="googleSignInBtn" style="background: white; color: rgb(16,23,41); border: 1px solid rgb(16,23,41); display: flex; align-items: center; justify-content: center; gap: 12px;">
                <svg width="18" height="18" viewBox="0 0 18 18"><path fill="#4285F4" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z"/><path fill="#34A853" d="M9 18c2.43 0 4.467-.806 5.956-2.184l-2.908-2.258c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332C2.438 15.983 5.482 18 9 18z"/><path fill="#FBBC05" d="M3.964 10.707c-.18-.54-.282-1.117-.282-1.707 0-.593.102-1.17.282-1.709V4.958H.957C.347 6.173 0 7.548 0 9c0 1.452.348 2.827.957 4.042l3.007-2.335z"/><path fill="#EA4335" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0 5.482 0 2.438 2.017.957 4.958L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z"/></svg>
                Sign in with Google
            </button>

            <div class="settings-link">
                <button class="btn-link" onclick="openAccountSettingsModal()">‚öôÔ∏è Create Account with Settings</button>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div class="main-app" id="mainApp">
        <div class="header">
            <div class="logo">üìß Goose Hub</div>
            <div class="search-bar">
                <input type="text" placeholder="Search" id="searchInput">
                <div class="search-results" id="searchResults" style="display: none; position: absolute; background: white; border: 1px solid #dadde1; border-radius: 8px; margin-top: 4px; max-height: 400px; overflow-y: auto; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 1000; width: 400px;"></div>
            </div>
            <div class="header-actions">
                <button class="compose-btn" id="gooseBtn">Goose</button>
                <button class="compose-btn" id="composeBtn">Compose</button>
                <button class="compose-btn" id="debugBtn">Debug</button>
            </div>
        </div>

        <div class="container">
            <div class="sidebar" id="sidebar">
                <div class="loading">Loading folders...</div>
                <!-- Attachments tab will be added here -->
            </div>

            <div id="conversationList" style="flex: 1;">
                <div class="loading">Loading conversations...</div>
            </div>
            <div class="main-content" id="dynamicViewsContainer" style="flex: 1;"></div>
        </div>
    </div>


    <!-- Slideover Panel -->
    <div class="slideover-overlay" id="slideoverOverlay">
        <div class="slideover-panel">
            <div class="slideover-header">
                <h2 id="slideoverSubject">Conversation</h2>
                <button class="close-btn" onclick="closeSlideover()">√ó</button>
            </div>
            <div class="slideover-content" id="slideoverContent">
                <!-- Messages will be loaded here -->
            </div>
            <div class="slideover-footer">
                <div class="reply-actions">
                    <button class="btn-secondary" onclick="replyTo()">Reply</button>
                    <button class="btn-secondary" onclick="replyAll()">Reply All</button>
                    <button class="btn-secondary" onclick="forward()">Forward</button>
                    <button class="btn-primary" onclick="analyzeEmail()">Analyze</button>
                </div>
                <div class="reply-box">
                    <textarea id="quickReplyText" placeholder="Write a reply..."></textarea>
                    <input type="file" id="replyFileInput" multiple style="display: none;">
                    <button class="send-btn" onclick="sendQuickReply()">Send</button>
                    <button class="btn-secondary" onclick="document.getElementById('replyFileInput').click()" style="margin-left: 8px;">üìé Attach</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Attachment Gallery -->
    <div class="container gallery-container" id="galleryContainer">
        <div class="main-content">
            <div class="gallery-header">
                <h1 class="gallery-title">üìé Attachments</h1>
                <div class="gallery-controls">
                    <div class="view-mode-switcher">
                        <button class="view-mode-btn active" data-mode="recents" onclick="switchGalleryView('recents')">Recents</button>
                        <button class="view-mode-btn" data-mode="sender" onclick="switchGalleryView('sender')">By Sender</button>
                        <button class="view-mode-btn" data-mode="list" onclick="switchGalleryView('list')">List</button>
                    </div>
                    <div class="gallery-search">
                        <input type="text" id="gallerySearchInput" placeholder="Search attachments..." oninput="searchAttachments()">
                    </div>
                    <div class="filter-group">
                        <select class="filter-select" id="filterDate" onchange="applyFilters()">
                            <option value="">All Time</option>
                            <option value="today">Today</option>
                            <option value="week">Last 7 Days</option>
                            <option value="month">Last 30 Days</option>
                        </select>
                        <select class="filter-select" id="filterType" onchange="applyFilters()">
                            <option value="">All Types</option>
                            <option value="image">Images</option>
                            <option value="pdf">PDFs</option>
                            <option value="document">Documents</option>
                            <option value="spreadsheet">Spreadsheets</option>
                            <option value="archive">Archives</option>
                        </select>
                        <select class="filter-select" id="filterSize" onchange="applyFilters()">
                            <option value="">All Sizes</option>
                            <option value="small">Small (&lt;1MB)</option>
                            <option value="medium">Medium (1-10MB)</option>
                            <option value="large">Large (&gt;10MB)</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Recents View -->
            <div id="recentsView" class="gallery-grid">
                <div class="loading">Loading attachments...</div>
            </div>

            <!-- Sender View -->
            <div id="senderView" class="sender-list" style="display: none;">
                <div class="loading">Loading attachments...</div>
            </div>

            <!-- List View -->
            <div id="listView" style="display: none;">
                <div class="loading">Loading attachments...</div>
            </div>

            <!-- Pagination -->
            <div class="pagination" id="galleryPagination" style="display: none;">
                <button onclick="previousPage()">Previous</button>
                <span id="pageInfo">Page 1</span>
                <button onclick="nextPage()">Next</button>
            </div>
        </div>
    </div>

    <!-- Preview Modal -->
    <div class="preview-modal" id="previewModal">
        <div class="preview-content" style="width: 800px; max-height: 90vh;">
            <!-- Preview content will be dynamically loaded -->
        </div>
    </div>

    <!-- Account Settings Modal -->
    <div class="settings-modal-overlay" id="accountSettingsModal">
        <div class="settings-modal">
            <h2>Create New Account</h2>
            <p class="subtitle">Configure your email and AI settings to create a new account</p>

            <form id="accountSettingsForm">
                <!-- Account Credentials -->
                <div class="settings-section">
                    <h3>Account Credentials</h3>
                    <div class="form-group-small">
                        <label>Email Address *</label>
                        <input type="email" id="new-email" name="email" required placeholder="your.email@example.com">
                    </div>
                    <div class="form-group-small">
                        <label>Password *</label>
                        <input type="password" id="new-password" name="password" required placeholder="Enter password">
                    </div>
                </div>

                <!-- Email Server Settings -->
                <div class="settings-section">
                    <h3>Email Server Settings</h3>
                    <div class="form-row">
                        <div class="form-group-small">
                            <label>IMAP Host *</label>
                            <input type="text" id="new-imap-host" name="imap_host" required placeholder="imap.gmail.com">
                        </div>
                        <div class="form-group-small">
                            <label>IMAP Port *</label>
                            <input type="number" id="new-imap-port" name="imap_port" required placeholder="993" value="993">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group-small">
                            <label>SMTP Host *</label>
                            <input type="text" id="new-smtp-host" name="smtp_host" required placeholder="smtp.gmail.com">
                        </div>
                        <div class="form-group-small">
                            <label>SMTP Port *</label>
                            <input type="number" id="new-smtp-port" name="smtp_port" required placeholder="587" value="587">
                        </div>
                    </div>
                    <p class="help-text">
                        For Gmail: IMAP: imap.gmail.com:993, SMTP: smtp.gmail.com:587<br>
                        For Outlook: IMAP: outlook.office365.com:993, SMTP: smtp.office365.com:587
                    </p>
                </div>

                <!-- AI/LLM Settings -->
                <div class="settings-section">
                    <h3>AI Agent Settings</h3>
                    <div class="settings-toggle">
                        <input type="checkbox" id="enable-ai" onchange="toggleAISettings(this.checked)">
                        <label for="enable-ai">Enable AI features (Goose Chat, Automations)</label>
                    </div>

                    <div id="ai-settings-section" class="collapsible-section">
                        <div class="form-group-small">
                            <label>LLM Provider *</label>
                            <select id="new-llm-provider" name="llm_provider" onchange="updateModelPlaceholder()">
                                <option value="anthropic">Anthropic (Claude)</option>
                                <option value="openai">OpenAI (GPT)</option>
                                <option value="databricks">Databricks</option>
                                <option value="local">Local GGUF</option>
                            </select>
                        </div>
                        <div class="form-group-small">
                            <label>API Key *</label>
                            <input type="password" id="new-api-key" name="api_key" placeholder="sk-ant-...">
                            <p class="help-text">Your API key will be stored securely and encrypted</p>
                        </div>
                        <div class="form-group-small">
                            <label>Model ID *</label>
                            <input type="text" id="new-model-id" name="model_id" placeholder="claude-3-5-sonnet-20241022">
                            <p class="help-text" id="model-help-text">
                                Recommended: claude-3-5-sonnet-20241022 for best performance
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Optional: Calendar Settings -->
                <div class="settings-section">
                    <h3>Calendar Integration (Optional)</h3>
                    <div class="settings-toggle">
                        <input type="checkbox" id="enable-calendar" onchange="toggleCalendarSettings(this.checked)">
                        <label for="enable-calendar">Enable calendar sync</label>
                    </div>

                    <div id="calendar-settings-section" class="collapsible-section">
                        <div class="form-group-small">
                            <label>CalDAV Server URL</label>
                            <input type="text" id="new-caldav-url" name="caldav_url" placeholder="https://caldav.example.com">
                        </div>
                        <div class="form-row">
                            <div class="form-group-small">
                                <label>Username</label>
                                <input type="text" id="new-caldav-username" name="caldav_username" placeholder="username">
                            </div>
                            <div class="form-group-small">
                                <label>Password</label>
                                <input type="password" id="new-caldav-password" name="caldav_password" placeholder="password">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeAccountSettingsModal()">Cancel</button>
                    <button type="submit" class="btn-primary" id="createAccountBtn">Create Account</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Debug Modal -->
    <div class="settings-modal-overlay" id="debugModal">
        <div class="settings-modal">
            <div class="settings-modal-header">
                <h2>üîß Sync Debug Information</h2>
                <button class="close-btn" onclick="closeDebugModal()">√ó</button>
            </div>
            <div class="settings-modal-body" style="max-height: 70vh; overflow-y: auto;">
                <div id="debugContent">
                    <div style="text-align: center; padding: 40px;">
                        <div class="spinner"></div>
                        <p>Loading debug information...</p>
                    </div>
                </div>
            </div>
            <div class="settings-modal-footer">
                <button type="button" class="btn-primary" onclick="testImapConnection()">Test IMAP</button>
                <button type="button" class="btn-primary" onclick="testCalDavConnection()">Test CalDAV</button>
                <button type="button" class="btn-primary" onclick="triggerManualSync()">Manual Sync</button>
                <button type="button" class="btn-secondary" onclick="closeDebugModal()">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let authToken = null;
        let currentFolder = 'INBOX';
        let conversations = [];
        let folders = [];
        let currentConversation = null;

        // Gallery state
        let currentView = 'recents';
        let attachments = [];
        let filteredAttachments = [];
        let currentPage = 1;
        let pageSize = 20;

        // ===== ERROR HANDLING HELPERS (MUST BE DEFINED EARLY) =====

        // Check if user is authenticated with real account
        function isRealAccount() {
            return authToken && authToken !== 'demo-token';
        }

        // Show feature unavailable message
        function showFeatureUnavailable(featureName) {
            showNotification(`${featureName} requires a real email account. Please register or login with valid credentials.`, 'info');
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
        });

        function initializeApp() {
            authToken = localStorage.getItem('auth_token');
            if (authToken) {
                showMainApp();
                loadFolders();
                loadConversations();
            } else {
                // Try auto-login first
                checkAutoLogin().then(autoLoggedIn => {
                    if (!autoLoggedIn) {
                        showLoginScreen();
                    }
                }).catch(e => {
                    console.error('Auto-login check failed:', e);
                    showLoginScreen();
                });
            }

            setupEventListeners();
        }

        // ===== ACCOUNT SETTINGS MODAL =====
        function openAccountSettingsModal() {
            document.getElementById('accountSettingsModal').classList.add('active');
        }

        function closeAccountSettingsModal() {
            document.getElementById('accountSettingsModal').classList.remove('active');
        }

        function toggleAISettings(enabled) {
            const section = document.getElementById('ai-settings-section');
            if (enabled) {
                section.style.display = 'block';
                section.querySelectorAll('input, select').forEach(el => el.required = true);
            } else {
                section.style.display = 'none';
                section.querySelectorAll('input, select').forEach(el => el.required = false);
            }
        }

        function toggleCalendarSettings(enabled) {
            const section = document.getElementById('calendar-settings-section');
            section.style.display = enabled ? 'block' : 'none';
        }

        function updateModelPlaceholder() {
            const provider = document.getElementById('new-llm-provider').value;
            const modelInput = document.getElementById('new-model-id');
            const helpText = document.getElementById('model-help-text');

            const placeholders = {
                'anthropic': {
                    placeholder: 'claude-3-5-sonnet-20241022',
                    help: 'Recommended: claude-3-5-sonnet-20241022 for best performance'
                },
                'openai': {
                    placeholder: 'gpt-4-turbo-preview',
                    help: 'Recommended: gpt-4-turbo-preview or gpt-3.5-turbo'
                },
                'databricks': {
                    placeholder: 'databricks-meta-llama-3-1-70b-instruct',
                    help: 'Enter your Databricks model endpoint'
                },
                'local': {
                    placeholder: 'path/to/model.gguf',
                    help: 'Path to your local GGUF model file'
                }
            };

            const config = placeholders[provider] || placeholders['anthropic'];
            modelInput.placeholder = config.placeholder;
            helpText.textContent = config.help;
        }

        // Handle account creation form submission
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('accountSettingsForm');
            if (form) {
                form.addEventListener('submit', handleAccountCreation);
            }
        });

        async function handleAccountCreation(e) {
            e.preventDefault();

            const createBtn = document.getElementById('createAccountBtn');
            const originalText = createBtn.textContent;
            createBtn.disabled = true;
            createBtn.textContent = 'Creating Account...';

            const formData = new FormData(e.target);
            const aiEnabled = document.getElementById('enable-ai').checked;
            const calendarEnabled = document.getElementById('enable-calendar').checked;

            // Build account data
            const accountData = {
                email: formData.get('email'),
                password: formData.get('password'),
                imap_host: formData.get('imap_host'),
                imap_port: parseInt(formData.get('imap_port')),
                smtp_host: formData.get('smtp_host'),
                smtp_port: parseInt(formData.get('smtp_port'))
            };

            // Add AI settings if enabled
            if (aiEnabled) {
                accountData.llm_provider = formData.get('llm_provider');
                accountData.api_key = formData.get('api_key');
                accountData.model_id = formData.get('model_id');
            }

            // Add calendar settings if enabled
            if (calendarEnabled) {
                accountData.caldav_url = formData.get('caldav_url');
                accountData.caldav_username = formData.get('caldav_username');
                accountData.caldav_password = formData.get('caldav_password');
            }

            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(accountData)
                });

                if (response.ok) {
                    const data = await response.json();
                    authToken = data.token;
                    localStorage.setItem('auth_token', authToken);
                    localStorage.setItem('user', JSON.stringify(data.user || { email: accountData.email }));

                    showNotification('Account created successfully!', 'success');
                    closeAccountSettingsModal();

                    setTimeout(() => {
                        showMainApp();
                        loadFolders();
                        loadConversations();
                    }, 1000);
                } else {
                    const error = await response.json();
                    showNotification(error.message || 'Failed to create account', 'error');
                }
            } catch (error) {
                console.error('Account creation error:', error);
                showNotification('Failed to create account. Please check your settings and try again.', 'error');
            } finally {
                createBtn.disabled = false;
                createBtn.textContent = originalText;
            }
        }

        // Close modal when clicking outside
        document.getElementById('accountSettingsModal')?.addEventListener('click', (e) => {
            if (e.target.id === 'accountSettingsModal') {
                closeAccountSettingsModal();
            }
        });

        // Keyboard shortcut to close modal
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const modal = document.getElementById('accountSettingsModal');
                if (modal && modal.classList.contains('active')) {
                    closeAccountSettingsModal();
                }
            }
        });

        // ===== END ACCOUNT SETTINGS MODAL =====

        function showLoginScreen() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainApp').classList.remove('active');

            // Check for OAuth redirect parameters
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            const email = urlParams.get('email');
            const oauthSuccess = urlParams.get('oauth_success');
            const error = urlParams.get('error');
            const errorMessage = urlParams.get('message');

            // Handle OAuth errors
            if (error) {
                let displayMessage = 'Authentication failed';
                if (error === 'email_init_failed') {
                    displayMessage = 'Failed to initialize email services. Please try again.';
                    if (errorMessage) {
                        displayMessage += ': ' + decodeURIComponent(errorMessage);
                    }
                }
                showNotification(displayMessage, 'error');
                // Clean up URL
                window.history.replaceState({}, document.title, '/');
                return;
            }

            // Handle successful OAuth login
            if (token && email) {
                // Store token and redirect to main app
                authToken = token;
                localStorage.setItem('auth_token', authToken);
                localStorage.setItem('user', JSON.stringify({ email }));

                // Show success message
                if (oauthSuccess) {
                    showNotification('Successfully signed in with Google! Your emails are being synced...', 'success');
                }

                // Clean up URL
                window.history.replaceState({}, document.title, '/');

                showMainApp();
                loadFolders();

                // Load conversations (sync is happening in background on backend)
                loadConversations();
            }
        }

        // Google Sign In Handler
        document.addEventListener('DOMContentLoaded', () => {
            const googleSignInBtn = document.getElementById('googleSignInBtn');
            if (googleSignInBtn) {
                googleSignInBtn.addEventListener('click', handleGoogleSignIn);
            }
        });

        async function handleGoogleSignIn() {
            try {
                console.log('Fetching Google auth URL...');
                const response = await fetch('/api/auth/google');
                console.log('Response status:', response.status);
                const text = await response.text();
                console.log('Response text:', text);
                const data = JSON.parse(text);
                console.log('Parsed data:', data);
                window.location.href = data.auth_url;
            } catch (error) {
                console.error('Google sign in error:', error);
                showNotification('Failed to initiate Google sign in', 'error');
            }
        }

        // Auto-login if single user exists (desktop app mode)
        async function checkAutoLogin() {
            try {
                // Check if we already have a token
                const existingToken = localStorage.getItem('auth_token');
                if (existingToken) {
                    return true; // Already logged in
                }

                // Try to get single user auto-login
                const response = await fetch('/api/auth/auto-login');
                if (response.ok) {
                    const data = await response.json();
                    if (data.token && data.user) {
                        // Auto-login successful
                        authToken = data.token;
                        localStorage.setItem('auth_token', authToken);
                        localStorage.setItem('user', JSON.stringify(data.user));

                        console.log('Auto-login successful for:', data.user.email);

                        // Show main app
                        document.getElementById('loginScreen').style.display = 'none';
                        document.getElementById('mainApp').classList.add('active');

                        // Load initial data
                        loadFolders();
                        loadConversations();
                        return true;
                    }
                }
            } catch (e) {
                console.log('Auto-login not available:', e);
            }
            return false;
        }

        // Manual sync trigger
        async function triggerManualSync() {
            showNotification('Starting email sync...', 'info');
            try {
                const response = await fetch('/api/debug/manual-sync', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (response.ok) {
                    showNotification('Email sync completed!', 'success');
                    loadConversations();
                } else {
                    showNotification('Sync failed. Please try again.', 'error');
                }
            } catch (error) {
                showNotification('Sync error: ' + error.message, 'error');
            }
        }

        function showMainApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').classList.add('active');
        }

        function setupEventListeners() {
            document.getElementById('loginForm')?.addEventListener('submit', handleLogin);
            document.getElementById('composeBtn')?.addEventListener('click', openComposeModal);
            document.getElementById('gooseBtn')?.addEventListener('click', openGooseChat);
            document.getElementById('logoutBtn')?.addEventListener('click', handleLogout);
            document.getElementById('debugBtn')?.addEventListener('click', openDebugModal);
            document.getElementById('searchInput')?.addEventListener('input', debounce(handleSearch, 500));
        }

        async function handleLogin(e) {
            e.preventDefault();

            const loginBtn = document.getElementById('loginBtn');
            const errorDiv = document.getElementById('loginError');
            const successDiv = document.getElementById('loginSuccess');

            loginBtn.disabled = true;
            loginBtn.textContent = 'Signing in...';
            errorDiv.style.display = 'none';
            successDiv.style.display = 'none';

            const formData = new FormData(e.target);
            const username = formData.get('username');
            const password = formData.get('password');

            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                if (response.ok) {
                    const data = await response.json();
                    authToken = data.token || 'demo-token';
                    localStorage.setItem('auth_token', authToken);
                    localStorage.setItem('user', JSON.stringify(data.user || { username, email: username }));

                    successDiv.textContent = 'Login successful!';
                    successDiv.style.display = 'block';

                    setTimeout(() => {
                        showMainApp();
                        loadFolders();
                        loadConversations();
                    }, 1000);
                } else {
                    throw new Error('Login failed');
                }
            } catch (error) {
                // Demo mode fallback
                console.log('Using demo mode');
                authToken = 'demo-token';
                localStorage.setItem('auth_token', authToken);
                localStorage.setItem('user', JSON.stringify({ username, email: username }));

                successDiv.textContent = 'Demo login successful!';
                successDiv.style.display = 'block';

                setTimeout(() => {
                    showMainApp();
                    loadFolders();
                    loadConversations();
                }, 1000);
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'Sign In';
            }
        }

        function handleLogout() {
            localStorage.removeItem('auth_token');
            localStorage.removeItem('user');
            authToken = null;
            showLoginScreen();
        }

        async function loadFolders() {
            try {
                const response = await fetch('/api/folders', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    folders = await response.json();
                } else {
                    folders = getMockFolders();
                }
            } catch (error) {
                folders = getMockFolders();
            }

            renderFolders();
        }

        function renderFolders() {
            console.log('renderFolders called with', folders.length, 'folders');
            const sidebar = document.getElementById('sidebar');
            sidebar.innerHTML = '';

            // Standard folders that should always be visible
            const standardFolders = ['INBOX', 'Sent', 'Drafts', 'Trash', 'Spam', 'Archive', 'Starred'];

            // Separate standard and non-standard folders
            const standard = folders.filter(f => standardFolders.includes(f.name));
            const nonStandard = folders.filter(f => !standardFolders.includes(f.name));

            // Render standard folders
            standard.forEach(folder => {
                const folderItem = document.createElement('div');
                folderItem.className = 'folder-item' + (folder.id === currentFolder ? ' active' : '');
                folderItem.innerHTML = `
                    <span>${formatFolderName(folder.name)}</span>
                    ${folder.unread_count > 0 ? `<span class="unread-count">${folder.unread_count}</span>` : ''}
                `;
                folderItem.addEventListener('click', () => selectFolder(folder.name));
                sidebar.appendChild(folderItem);
            });

            // Add "Show More" collapsible section for non-standard folders
            if (nonStandard.length > 0) {
                const showMoreHeader = document.createElement('div');
                showMoreHeader.className = 'folder-item';
                showMoreHeader.id = 'showMoreFolders';
                showMoreHeader.style.cursor = 'pointer';
                showMoreHeader.innerHTML = `
                    <span style="color: #65676b; font-size: 13px;">‚ñ∂ Show More (${nonStandard.length})</span>
                `;

                const nonStandardContainer = document.createElement('div');
                nonStandardContainer.id = 'nonStandardFolders';
                nonStandardContainer.style.display = 'none';

                nonStandard.forEach(folder => {
                    const folderItem = document.createElement('div');
                    folderItem.className = 'folder-item' + (folder.id === currentFolder ? ' active' : '');
                    folderItem.style.paddingLeft = '24px';
                    folderItem.innerHTML = `
                        <span>${formatFolderName(folder.name)}</span>
                        ${folder.unread_count > 0 ? `<span class="unread-count">${folder.unread_count}</span>` : ''}
                    `;
                    folderItem.addEventListener('click', () => selectFolder(folder.name));
                    nonStandardContainer.appendChild(folderItem);
                });

                showMoreHeader.addEventListener('click', () => toggleNonStandardFolders());
                sidebar.appendChild(showMoreHeader);
                sidebar.appendChild(nonStandardContainer);
            }

            // Add separator after email folders
            const separator1 = document.createElement('div');
            separator1.style.borderTop = '1px solid #e4e6eb';
            separator1.style.margin = '8px 0';
            sidebar.appendChild(separator1);

            // Add special views section
            // Add Attachments tab
            const attachmentsTab = document.createElement('div');
            attachmentsTab.className = 'folder-item';
            attachmentsTab.innerHTML = `
                <span>üìé Attachments</span>
            `;
            attachmentsTab.addEventListener('click', (e) => showAttachmentGallery(e));
            sidebar.appendChild(attachmentsTab);


            // Add Chat/Goose tab
            const chatTab = document.createElement('div');
            chatTab.className = 'folder-item';
            chatTab.innerHTML = `<span>Chat</span>`;
            chatTab.addEventListener('click', (e) => showChatView(e));
            sidebar.appendChild(chatTab);

            // Add Automations tab
            const automationsTab = document.createElement('div');
            automationsTab.className = 'folder-item';
            automationsTab.innerHTML = `<span>Automations</span>`;
            automationsTab.addEventListener('click', (e) => showAutomationsView(e));
            sidebar.appendChild(automationsTab);

            // Add Reminders tab
            const remindersTab = document.createElement('div');
            remindersTab.className = 'folder-item';
            remindersTab.innerHTML = `<span>‚úì Reminders</span>`;
            remindersTab.addEventListener('click', (e) => showRemindersView(e));
            sidebar.appendChild(remindersTab);

            // Add Calendar tab
            const calendarTab = document.createElement('div');
            calendarTab.className = 'folder-item';
            calendarTab.innerHTML = `<span>üìÖ Calendar</span>`;
            calendarTab.addEventListener('click', (e) => showCalendarView(e));
            sidebar.appendChild(calendarTab);

            // Add Money tab
            const moneyTab = document.createElement('div');
            moneyTab.className = 'folder-item';
            moneyTab.innerHTML = `<span>üí∞ Money</span>`;
            moneyTab.addEventListener('click', (e) => showMoneyView(e));
            sidebar.appendChild(moneyTab);

            // Add Settings tab
            const settingsTab = document.createElement('div');
            settingsTab.className = 'folder-item';
            settingsTab.id = 'settingsTabItem';
            settingsTab.innerHTML = `<span>‚öôÔ∏è Settings</span>`;
            settingsTab.addEventListener('click', (e) => showSettingsView(e));
            sidebar.appendChild(settingsTab);
        }

        function toggleNonStandardFolders() {
            const container = document.getElementById('nonStandardFolders');
            const header = document.getElementById('showMoreFolders');

            if (container.style.display === 'none') {
                container.style.display = 'block';
                header.innerHTML = `<span style="color: #65676b; font-size: 13px;">‚ñº Show Less</span>`;
            } else {
                container.style.display = 'none';
                header.innerHTML = `<span style="color: #65676b; font-size: 13px;">‚ñ∂ Show More (${container.children.length})</span>`;
            }
        }

        function selectFolder(folderId) {
            currentFolder = folderId;

            // Hide all special views
            hideAttachmentGallery();
            hideAllViews();

            // Show conversation list for email folders
            document.getElementById('conversationList').style.display = 'block';

            // Update active state
            document.querySelectorAll('.folder-item').forEach(f => f.classList.remove('active'));
            event.target.closest('.folder-item').classList.add('active');
            loadConversations();
        }

        async function loadConversations() {
            const container = document.getElementById('conversationList');
            container.innerHTML = '<div class="loading">Loading conversations...</div>';

            try {
                const response = await fetch(`/api/conversations?folder=${currentFolder}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    conversations = await response.json();

                    // Filter out empty chat conversations from inbox view
                    if (currentFolder === 'INBOX') {
                        conversations = conversations.filter(conv => {
                            // Filter out empty chat/automation conversations, keep all email conversations
                            if (conv.conversation_type === 'chat' || conv.conversation_type === 'automation') {
                                return conv.message_count && conv.message_count > 0;
                            }
                            return true;
                        });
                    }
                    // If no conversations found and user just logged in, show helpful message
                    if (conversations.length === 0) {
                        container.innerHTML = `
                            <div style="padding: 20px; text-align: center; color: #65676b;">
                                <p>No emails found. Syncing your inbox...</p>
                                <button onclick="triggerManualSync()" style="margin-top: 10px; padding: 8px 16px; background: #7C9CBF; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                    Sync Now
                                </button>
                            </div>
                        `;
                        return;
                    }
                } else {
                    conversations = getMockConversations();
                }
            } catch (error) {
                conversations = getMockConversations();
            }

            renderConversations();
        }

        function renderConversations() {
            const container = document.getElementById('conversationList');

            if (conversations.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>No conversations found</h3></div>';
                return;
            }

            container.innerHTML = '';
            conversations.forEach(conv => {
                const convEl = createConversationElement(conv);
                container.appendChild(convEl);
            });
        }

        function createConversationElement(conv) {
            const div = document.createElement('div');
            div.className = `conversation ${conv.unread_count > 0 ? 'unread' : ''}`;

            // Add special styling for chat and automation conversations
            if (conv.conversation_type === 'chat') {
                div.style.borderLeft = '4px solid #10a37f';
            } else if (conv.conversation_type === 'automation') {
                div.style.borderLeft = '4px solid #ff9800';
            }

            div.innerHTML = `
                <div class="conversation-line">
                    <div class="conversation-info">

                        ${conv.conversation_type === 'chat' ? `<span style="font-size: 16px; margin-right: 8px;">ü§ñ</span>` : ''}
                        ${conv.conversation_type === 'automation' ? `<span style="font-size: 16px; margin-right: 8px;">‚öôÔ∏è</span>` : ''}
                        <div class="subject-line">${escapeHtml(conv.subject)}</div>
                        <div class="content-snippet">${escapeHtml(conv.preview)}</div>
                    </div>
                    <div class="conversation-actions-hover">
                        <button class="icon-btn" onclick="event.stopPropagation(); replyAllDirect('${conv.id}')" title="Reply All">‚Ü©Ô∏è</button>
                        <button class="icon-btn" onclick="event.stopPropagation(); toggleStar('${conv.id}')" title="Star">‚≠ê</button>
                        <button class="icon-btn" onclick="event.stopPropagation(); moveConversation('${conv.id}')" title="Move">üìÅ</button>
                        <button class="icon-btn" onclick="event.stopPropagation(); deleteConv('${conv.id}')" title="Delete">üóëÔ∏è</button>
                    </div>
                    <div class="timestamp">${formatDate(conv.last_message_date)}</div>
                </div>
            `;

            // Add context menu
            div.addEventListener('contextmenu', (e) => showContextMenu(e, conv));
            div.addEventListener('click', () => {
                if (conv.conversation_type === 'chat' || conv.conversation_type === 'automation') {
                    // Open the chat interface directly with the conversation ID
                    openChatConversationFromInbox(conv.id);
                } else {
                    openSlideover(conv);
                }
            });

            return div;
        }

        function openChatConversationFromInbox(conversationId) {
            // Hide inbox and show chat interface
            hideAllViews();
            document.getElementById('conversationList').style.display = 'none';

            // Update sidebar to show chat as active
            document.querySelectorAll('.folder-item').forEach(f => f.classList.remove('active'));

            // Open the chat interface
            openChatConversation(conversationId);
        }

        function showContextMenu(e, conv) {
            e.preventDefault();

            // Remove any existing context menu
            const existing = document.querySelector('.context-menu');
            if (existing) existing.remove();

            const menu = document.createElement('div');
            menu.className = 'context-menu';
            menu.style.cssText = `
                position: fixed;
                left: ${e.clientX}px;
                top: ${e.clientY}px;
                background: white;
                border: 1px solid #dadde1;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                min-width: 200px;
            `;

            const menuItems = [
                { label: 'ü§ñ Ask Goose about this', action: () => askGooseAboutEmail(conv) },
                { label: '‚Ü©Ô∏è Reply', action: () => replyAllDirect(conv.id) },
                { label: '‚≠ê Star', action: () => toggleStar(conv.id) },
                { label: 'üìÅ Move', action: () => moveConversation(conv.id) },
                { label: 'üóëÔ∏è Delete', action: () => deleteConv(conv.id) },
            ];

            menuItems.forEach(item => {
                const menuItem = document.createElement('div');
                menuItem.textContent = item.label;
                menuItem.style.cssText = 'padding: 12px 16px; cursor: pointer; transition: background 0.2s;';
                menuItem.onmouseover = () => menuItem.style.background = '#f0f2f5';
                menuItem.onmouseout = () => menuItem.style.background = 'white';
                menuItem.onclick = () => {
                    item.action();
                    menu.remove();
                };
                menu.appendChild(menuItem);
            });

            document.body.appendChild(menu);

            // Close menu on click outside
            setTimeout(() => {
                document.addEventListener('click', () => menu.remove(), { once: true });
            }, 0);
        }

        async function askGooseAboutEmail(conv) {
            // Create a new chat with context about the email
            const response = await fetch('/api/chat/conversations', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${authToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ title: `Chat about: ${conv.subject}` })
            });
            const data = await response.json();
            if (data.id) {
                // Send initial message with email context
                await fetch(`/api/chat/conversations/${data.id}/messages`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content: `I need help with this email:\n\nSubject: ${conv.subject}\n\nCan you help me understand it and suggest a response?`
                    })
                });
                showChatView(data.id);
            }
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const diffHours = Math.floor((now - date) / (1000 * 60 * 60));

            if (diffHours < 1) return 'Just now';
            if (diffHours < 24) return `${diffHours}h`;
            if (diffHours < 48) return 'Yesterday';
            return date.toLocaleDateString();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Format folder names: INBOX -> Inbox, SENT MAIL -> Sent Mail
        function formatFolderName(name) {
            if (!name) return '';
            return name.toLowerCase().replace(/\b\w/g, l => l.toUpperCase());
        }

        // Notification System
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notificationContainer');
            if (!container) return;

            const notification = document.createElement('div');
            notification.className = `notification ${type}`;

            const icons = {
                success: '‚úì',
                error: '‚úó',
                info: '‚Ñπ',
                warning: '‚ö†'
            };

            notification.innerHTML = `
                <div style="font-size: 20px;">${icons[type] || icons.info}</div>
                <div class="notification-content">${escapeHtml(message)}</div>
                <button onclick="this.parentElement.remove()" style="background: none; border: none; cursor: pointer; font-size: 18px; color: #65676b;">√ó</button>
            `;

            container.appendChild(notification);

            // Auto-dismiss after 3 seconds
            setTimeout(() => {
                notification.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 300);
            }, 3000);
        }

        // Handle API errors gracefully
        function handleApiError(error, context, response = null) {
            console.error(`${context} error:`, error);
            if (response) {
                if (response.status === 401) {
                    showNotification('Please login to access this feature', 'error');
                } else if (response.status === 404) {
                    showNotification('This feature is not available yet', 'info');
                } else {
                    showNotification(`${context} is currently unavailable`, 'error');
                }
            } else {
                showNotification(`${context} is currently unavailable`, 'error');
            }
        }

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        async function handleSearch(e) {
            const query = e.target.value.toLowerCase();
            const searchResults = document.getElementById('searchResults');

            if (!query) {
                searchResults.style.display = 'none';
                renderConversations();
                return;
            }

            // Show search results with animation
            searchResults.style.display = 'block';
            searchResults.style.animation = 'slideDown 0.2s ease-out';
            searchResults.innerHTML = '<div style="padding: 12px; color: #65676b;">Searching...</div>';

            // Try API search first
            try {
                const response = await fetch(`/api/search?q=${encodeURIComponent(query)}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const results = await response.json();
                    if (results.emails && results.emails.length > 0) {
                        // Show results in dropdown
                        searchResults.innerHTML = results.emails.slice(0, 5).map(email => `
                            <div style="padding: 12px; border-bottom: 1px solid #e4e6eb; cursor: pointer;"
                                 onclick="loadConversationById('${email.thread_id || email.id}')">
                                <div style="font-weight: 600; margin-bottom: 4px;">${email.subject}</div>
                                <div style="font-size: 12px; color: #65676b;">${email.from_address}</div>
                            </div>
                        `).join('');

                        // Convert search results to conversation format and display
                        displaySearchResults(results.emails);
                        return;
                    }
                }
            } catch (error) {
                console.log('API search failed, using local filter:', error);
            }

            // Fallback to local filtering
            const filtered = conversations.filter(conv =>
                conv.subject.toLowerCase().includes(query) ||
                conv.preview.toLowerCase().includes(query) ||
                conv.participants.some(p => p.toLowerCase().includes(query))
            );

            const container = document.getElementById('conversationList');
            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>No results found</h3></div>';
                return;
            }

            container.innerHTML = '';
            filtered.forEach(conv => {
                const convEl = createConversationElement(conv);
                container.appendChild(convEl);
            });
        }

        function displaySearchResults(emails) {
            const container = document.getElementById('conversationList');
            if (emails.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>No results found</h3></div>';
                return;
            }

            container.innerHTML = '';
            emails.forEach(email => {
                // Convert email to conversation format
                const conv = {
                    id: email.id,
                    subject: email.subject,
                    preview: email.body_text?.substring(0, 100) || '',
                    participants: [email.from_address],
                    date: email.date,
                    unread: !email.is_read
                };
                const convEl = createConversationElement(conv);
                container.appendChild(convEl);
            });
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => notification.remove(), 3000);
        }

        // Action functions - NOW FULLY IMPLEMENTED
        async function openGooseChat() {
            try {
                const response = await fetch('/api/chat/conversations', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ title: 'New Chat' })
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('Chat conversation created:', data);
                    if (data.id) {
                        showChatView(data.id);
                    } else {
                        console.error('No conversation ID returned:', data);
                        showNotification('Failed to create chat conversation', 'error');
                    }
                } else if (response.status === 401) {
                    showNotification('Please login to use Goose Chat', 'error');
                } else if (response.status === 500) {
                    const error = await response.json().catch(() => ({}));
                    showNotification(error.error || 'Unable to start chat. Please check your AI settings.', 'error');
                } else {
                    showNotification('Unable to start chat. Please try again later.', 'error');
                }
            } catch (error) {
                console.error('Goose Chat error:', error);
                showNotification('Chat service is currently unavailable', 'error');
            }
        }

        function openComposeModal(options = {}) {
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';

            const modal = document.createElement('div');
            modal.className = 'compose-modal';
            modal.innerHTML = `
                <h2>Compose Email</h2>
                <div class="drop-zone" id="composeDropZone">Drop files here or click to upload</div>
                <form id="composeForm">
                    <div class="form-group">
                        <label>To:</label>
                        <input type="text" name="to" value="${options.to || ''}" required>
                    </div>
                    <div class="form-group">
                        <label>Subject:</label>
                        <input type="text" name="subject" value="${options.subject || ''}" required>
                    </div>
                    <div class="form-group">
                        <label>Message:</label>
                        <textarea name="body" required>${options.body || ''}</textarea>
                        <input type="file" id="composeFileInput" multiple style="display: none;">
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn-secondary" onclick="closeComposeModal()">Cancel</button>
                        <button type="submit" class="btn-primary">Send</button>
                    </div>
                </form>
            `;

            overlay.appendChild(modal);
            document.body.appendChild(overlay);

            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) closeComposeModal();
            });

            // Setup drag and drop
            const dropZone = document.getElementById('composeDropZone');
            const fileInput = document.getElementById('composeFileInput');

            dropZone.addEventListener('click', () => fileInput.click());

            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.style.borderColor = '#7C9CBF';
                dropZone.style.background = '#f0f7ff';
            });

            dropZone.addEventListener('dragleave', () => {
                dropZone.style.borderColor = '#dadde1';
                dropZone.style.background = '#f9fafb';
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.style.borderColor = '#dadde1';
                dropZone.style.background = '#f9fafb';

                const files = Array.from(e.dataTransfer.files);
                handleFileUpload(files, dropZone);
            });

            fileInput.addEventListener('change', (e) => {
                const files = Array.from(e.target.files);
                handleFileUpload(files, dropZone);
            });

            // Also enable drag-drop on textarea
            const textarea = modal.querySelector('textarea');
            textarea.addEventListener('drop', (e) => {
                e.preventDefault();
                const files = Array.from(e.dataTransfer.files);
                handleFileUpload(files, dropZone);
            });

            document.getElementById('composeForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);

                try {
                    await fetch('/api/emails/send', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            to: formData.get('to').split(',').map(e => e.trim()),
                            subject: formData.get('subject'),
                            body_text: formData.get('body')
                        })
                    });

                    showNotification('Email sent successfully!', 'success');
                    closeComposeModal();
                    loadConversations();
                } catch (error) {
                    console.log('Send email (demo mode):', formData.get('to'));
                    showNotification('Email sent (demo mode)!', 'success');
                    closeComposeModal();
                }
            });
        }

        function handleFileUpload(files, dropZone) {
            if (files.length === 0) return;

            const fileList = files.map(f => f.name).join(', ');
            dropZone.innerHTML = `
                <div style="color: #7C9CBF;">
                    üìé ${files.length} file(s) attached: ${fileList}
                </div>
            `;

            // In a real implementation, upload files to server
            showNotification(`${files.length} file(s) attached`, 'success');
        }

        function closeComposeModal() {
            document.querySelector('.modal-overlay')?.remove();
        }

        // ===== EMAIL ANALYSIS FUNCTION =====
        async function analyzeEmail() {
            if (!currentConversation) {
                showNotification('No email selected', 'error');
                return;
            }

            try {
                // Create a new chat conversation with custom system prompt
                const response = await fetch('/api/chat/conversations', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title: `Analysis: ${currentConversation.subject}`,
                        system_prompt: `You are an executive assistant to a very senior professional. Your role is to analyze emails and provide actionable insights.

For each email, you should:
1. Detect the intent and classify it as:
   a) SPAM - Unsolicited or promotional content
   b) ACTION_REQUIRED - Request for information or action (create a reminder)
   c) INFORMATIONAL - Updates not directly addressed to the recipient
   d) INVOICE - Bills or payment requests
   e) SOCIAL - Personal interactions from family/friends
   f) OTHER - Anything else

2. Provide a short summary (1-2 sentences)
3. Recommend next steps
4. If ACTION_REQUIRED, use the create_reminder tool to create an appropriate reminder
5. Tag the email with your findings

Be concise, professional, and actionable.`
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    const conversationId = data.id;

                    // Get the full email content
                    const emailResponse = await fetch(`/api/conversations/${currentConversation.id}`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });

                    let emailContent = '';
                    if (emailResponse.ok) {
                        const emailData = await emailResponse.json();
                        const messages = emailData.messages || [emailData];
                        emailContent = messages.map(msg => `\nFrom: ${msg.from_address || msg.from || 'Unknown'}\nDate: ${msg.date}\nSubject: ${currentConversation.subject}\n\n${msg.body_text || msg.body || ''}`).join('\n---\n');
                    }

                    // Send the email for analysis
                    await fetch(`/api/chat/conversations/${conversationId}/messages`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            content: `Please analyze this email and provide your classification, summary, and recommended next steps:\n\n${emailContent}`
                        })
                    });

                    // Close slideover and open chat interface
                    closeSlideover();
                    showNotification('Analyzing email...', 'info');
                    setTimeout(() => {
                        openChatConversation(conversationId);
                    }, 500);
                } else {
                    showNotification('Failed to create analysis chat', 'error');
                }
            } catch (error) {
                console.error('Email analysis error:', error);
                showNotification('Failed to analyze email', 'error');
            }
        }

        // Slideover functions
        function openSlideover(conv) {
            currentConversation = conv;
            const overlay = document.getElementById('slideoverOverlay');
            const subject = document.getElementById('slideoverSubject');
            const content = document.getElementById('slideoverContent');

            subject.textContent = conv.subject;

            // Load conversation messages
            loadConversationMessages(conv.id);

            overlay.classList.add('active');
        }

        function closeSlideover() {
            const overlay = document.getElementById('slideoverOverlay');
            overlay.classList.remove('active');
            currentConversation = null;
        }

        async function loadConversationMessages(convId) {
            const content = document.getElementById('slideoverContent');
            content.innerHTML = '<div class="loading">Loading messages...</div>';

            try {
                const response = await fetch(`/api/conversations/${convId}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('Loaded data:', data);

                    // Check if it's a conversation object with messages array
                    let messages;
                    if (data.messages && Array.isArray(data.messages)) {
                        messages = data.messages;
                    } else if (Array.isArray(data)) {
                        messages = data;
                    } else {
                        messages = [data];
                    }
                    console.log('Rendering messages:', messages);

                    renderEmailMessages(messages);
                } else {
                    console.error('API failed with status:', response.status);
                    content.innerHTML = '<div class="empty-state"><h3>Unable to load messages</h3><p>Failed to load conversation.</p></div>';
                }
            } catch (error) {
                console.error('Error loading messages:', error);
                content.innerHTML = '<div class="empty-state"><h3>Unable to load messages</h3><p>Error: ' + error.message + '</p></div>';
            }
        }

        function renderEmailMessages(messages) {
            const content = document.getElementById('slideoverContent');


            if (!messages || messages.length === 0) {
                content.innerHTML = '<div class="empty-state"><h3>No messages found</h3></div>';
                return;
            }

            content.innerHTML = '';
            messages.forEach(msg => {
                // Determine if this is an email message or chat message
                const isEmail = msg.message_id || msg.from_address;

                if (isEmail) {
                    // Render email message
                    const msgEl = document.createElement('div');
                    msgEl.className = 'email-message';
                    msgEl.style.cssText = 'padding: 16px; border-bottom: 1px solid #e4e6eb; background: white;';
                    msgEl.innerHTML = `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <div style="font-weight: 600; color: #050505;">${escapeHtml(msg.from_address)}</div>
                            <div style="color: #65676b; font-size: 13px;">${formatDate(msg.date)}</div>
                        </div>
                        <div style="color: #050505; line-height: 1.5;">${msg.body_html || escapeHtml(msg.body_text || '')}</div>
                    `;
                    content.appendChild(msgEl);
                } else {
                    // Render chat message (original logic)
                    const msgEl = document.createElement('div');
                msgEl.className = 'chat-message';
                msgEl.innerHTML = `
                    <div class="message-header">
                        <div class="message-sender">${escapeHtml(msg.from || msg.sender)}</div>
                        <div class="message-time">${formatDate(msg.date || msg.timestamp)}</div>
                    </div>
                    <div class="message-body">${escapeHtml(msg.body || msg.text)}</div>
                `;
                content.appendChild(msgEl);
                }
            });
        }

        async function sendQuickReply() {
            const textarea = document.getElementById('quickReplyText');
            const fileInput = document.getElementById('replyFileInput');
            const text = textarea.value.trim();

            if (!text || !currentConversation) return;

            // Handle file attachments
            const files = fileInput.files;
            if (files.length > 0) {
                const fileNames = Array.from(files).map(f => f.name).join(', ');
                showNotification(`Reply with ${files.length} attachment(s): ${fileNames}`, 'info');
                // In real implementation, upload files to server
            }

            // Setup drag-drop on reply textarea
            textarea.addEventListener('dragover', (e) => e.preventDefault());
            textarea.addEventListener('drop', (e) => {
                e.preventDefault();
                const droppedFiles = Array.from(e.dataTransfer.files);
                if (droppedFiles.length > 0) {
                    const dt = new DataTransfer();
                    droppedFiles.forEach(f => dt.items.add(f));
                    fileInput.files = dt.files;
                    showNotification(`${droppedFiles.length} file(s) attached to reply`, 'success');
                }
            });

            try {
                await fetch('/api/emails/send', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        to: currentConversation.participants,
                        subject: 'Re: ' + currentConversation.subject,
                        body_text: text
                    })
                });

                textarea.value = '';
                fileInput.value = '';
                showNotification('Reply sent!', 'success');
                loadConversationMessages(currentConversation.id);
            } catch (error) {
                console.log('Quick reply (demo mode):', text);
                textarea.value = '';
                showNotification('Reply sent (demo mode)!', 'success');

                // Add message to chat in demo mode
                const content = document.getElementById('slideoverContent');
                const msgEl = document.createElement('div');
                msgEl.className = 'chat-message';
                msgEl.innerHTML = `
                    <div class="message-header">
                        <div class="message-sender">You</div>
                        <div class="message-time">Just now</div>
                    </div>
                    <div class="message-body">${escapeHtml(text)}</div>
                `;
                content.appendChild(msgEl);
            }
        }

        function replyTo() {
            if (!currentConversation) return;
            closeSlideover();
            openComposeModal({
                to: currentConversation.participants[0],
                subject: 'Re: ' + currentConversation.subject
            });
        }

        function replyAll() {
            if (!currentConversation) return;
            closeSlideover();
            openComposeModal({
                to: currentConversation.participants.join(', '),
                subject: 'Re: ' + currentConversation.subject
            });
        }

        function forward() {
            if (!currentConversation) return;
            closeSlideover();
            openComposeModal({
                subject: 'Fwd: ' + currentConversation.subject,
                body: `\n\n---------- Forwarded message ---------\nSubject: ${currentConversation.subject}\n\n${currentConversation.preview}`
            });
        }

        // Hover action functions
        function replyAllDirect(convId) {
            const conv = conversations.find(c => c.id === convId);
            if (!conv) return;

            openComposeModal({
                to: conv.participants.join(', '),
                subject: 'Re: ' + conv.subject
            });
        }

        function toggleStar(convId) {
            console.log('Toggle star:', convId);
            showNotification('Star toggled!', 'success');
            // In real implementation, update the conversation's starred status
        }

        function moveConversation(convId) {
            const folders = ['inbox', 'sent', 'drafts', 'starred', 'trash'];
            const folderName = prompt('Move to folder:\n' + folders.join('\n'));

            if (folderName && folders.includes(folderName.toLowerCase())) {
                console.log('Move conversation', convId, 'to', folderName);
                showNotification(`Moved to ${formatFolderName(folderName)}`, 'success');
                // In real implementation, call API to move conversation
            }
        }

        async function deleteConv(convId) {
            if (!confirm('Move this conversation to trash?')) return;

            try {
                await fetch(`/api/emails/${convId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                showNotification('Conversation moved to trash', 'success');
                loadConversations();
            } catch (error) {
                console.log('Delete conversation (demo mode):', convId);
                showNotification('Conversation moved to trash (demo mode)', 'success');
                conversations = conversations.filter(c => c.id !== convId);
                renderConversations();
            }
        }

        // Close slideover when clicking overlay
        document.getElementById('slideoverOverlay')?.addEventListener('click', (e) => {
            if (e.target.id === 'slideoverOverlay') {
                closeSlideover();
            }
        });

        // Mock data
        function getMockFolders() {
            return [
                { id: 'inbox', name: 'Inbox', unread_count: 2 },
                { id: 'sent', name: 'Sent', unread_count: 0 },
                { id: 'drafts', name: 'Drafts', unread_count: 0 },
                { id: 'starred', name: 'Starred', unread_count: 0 },
                { id: 'trash', name: 'Trash', unread_count: 0 }
            ];
        }

        function getMockConversations() {
            return [
                {
                    id: '1',
                    subject: 'Welcome to Frame Email Client',
                    participants: ['Frame Support'],
                    last_message_date: new Date().toISOString(),
                    unread_count: 1,
                    message_count: 1,
                    preview: 'Thank you for trying Frame Email Client! This is a demo conversation to show how the interface works. Click Reply to compose a response, or use Reply All to include all participants.'
                },
                {
                    id: '2',
                    subject: 'Getting Started Guide',
                    participants: ['Frame Team'],
                    last_message_date: new Date(Date.now() - 3600000).toISOString(),
                    unread_count: 0,
                    message_count: 1,
                    preview: 'Here are some tips to get you started: 1. Use keyboard shortcuts for faster navigation 2. Try the search feature 3. Organize emails with folders 4. Use quick reply for fast responses'
                },
                {
                    id: '3',
                    subject: 'Project Update - Q4 2024',
                    participants: ['John Doe', 'Jane Smith'],
                    last_message_date: new Date(Date.now() - 7200000).toISOString(),
                    unread_count: 0,
                    message_count: 3,
                    preview: 'The Q4 project is progressing well. We have completed 75% of the planned features and are on track for the December release.'
                }
            ];
        }

        function getMockMessages(convId) {
            const conv = conversations.find(c => c.id === convId);
            if (!conv) return [];

            // Generate mock messages based on conversation
            if (convId === '1') {
                return [
                    {
                        from: 'Frame Support',
                        date: new Date().toISOString(),
                        body: 'Thank you for trying Frame Email Client! This is a demo conversation to show how the interface works. Click Reply to compose a response, or use Reply All to include all participants.'
                    }
                ];
            } else if (convId === '2') {
                return [
                    {
                        from: 'Frame Team',
                        date: new Date(Date.now() - 3600000).toISOString(),
                        body: 'Here are some tips to get you started:\n\n1. Use keyboard shortcuts for faster navigation\n2. Try the search feature\n3. Organize emails with folders\n4. Use quick reply for fast responses'
                    }
                ];
            } else if (convId === '3') {
                return [
                    {
                        from: 'John Doe',
                        date: new Date(Date.now() - 7200000).toISOString(),
                        body: 'The Q4 project is progressing well. We have completed 75% of the planned features and are on track for the December release.'
                    },
                    {
                        from: 'Jane Smith',
                        date: new Date(Date.now() - 3600000).toISOString(),
                        body: 'Great update! I\'ve reviewed the latest milestone and everything looks good. Should we schedule a meeting to discuss the remaining 25%?'
                    },
                    {
                        from: 'John Doe',
                        date: new Date(Date.now() - 1800000).toISOString(),
                        body: 'Yes, let\'s meet tomorrow at 2 PM. I\'ll send out a calendar invite.'
                    }
                ];
            }

            return [{ from: conv.participants[0], date: conv.last_message_date, body: conv.preview }];
        }

        // ============================================
        // ATTACHMENT GALLERY FUNCTIONS
        // ============================================

        function showAttachmentGallery(event) {
            // Hide conversation list
            document.getElementById('conversationList').style.display = 'none';

            // Show gallery
            const gallery = document.getElementById('galleryContainer');
            gallery.classList.add('active');
            gallery.style.display = 'block';

            // Update sidebar active state
            document.querySelectorAll('.folder-item').forEach(f => f.classList.remove('active'));
            event.target.closest('.folder-item').classList.add('active');

            // Load attachments
            loadGalleryRecents();
        }

        function hideAttachmentGallery() {
            // Hide gallery
            document.getElementById('galleryContainer').classList.remove('active');
            document.getElementById('galleryContainer').style.display = 'none';

            // Show conversation list
            document.getElementById('conversationList').style.display = 'block';
        }

        // ===== CHAT VIEW =====
        function showChatView(eventOrId) {
            hideAllViews();
            let chatView = document.getElementById('chatView');
            if (!chatView) {
                chatView = createChatView();
                document.getElementById('dynamicViewsContainer').appendChild(chatView);
            }
            chatView.style.display = 'block';

            // Handle both event object and conversation ID
            if (typeof eventOrId === 'string') {
                // It's a conversation ID, open it directly
                openChatConversation(eventOrId);
            } else if (eventOrId) {
                updateSidebarActive(eventOrId);
            }
            loadChatConversations();
        }

        function createChatView() {
            const view = document.createElement('div');
            view.id = 'chatView';
            view.style.display = 'none';
            view.className = 'tab-view';
            view.innerHTML = `
                <div class="tab-view-header">
                    <h1 class="tab-view-title">üí¨ Chat</h1>
                    <button class="compose-btn" onclick="startNewChat()">+ New Chat</button>
                </div>
                <div id="chatConversationsList" class="tab-view-content">
                    <div class="loading">Loading chat conversations...</div>
                </div>
            `;
            return view;
        }

        async function loadChatConversations() {
            const container = document.getElementById('chatConversationsList');
            if (!container) return;

            try {
                const response = await fetch('/api/chat/conversations', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const conversations = await response.json();
                    renderChatConversations(conversations);
                } else {
                    container.innerHTML = '<div class="empty-state"><h3>No chat conversations yet</h3><p>Start a new chat to get help with your emails</p></div>';
                }
            } catch (error) {
                container.innerHTML = '<div class="empty-state"><h3>No chat conversations yet</h3><p>Start a new chat to get help with your emails</p></div>';
            }
        }

        function renderChatConversations(conversations) {
            const container = document.getElementById('chatConversationsList');
            if (conversations.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>No chat conversations yet</h3><p>Start a new chat to get help with your emails</p></div>';
                return;
            }

            container.innerHTML = conversations.map(conv => `
                <div class="conversation" onclick="openChatConversation('${conv.id}')" style="cursor: pointer;">
                    <div class="conversation-line">
                        <div class="conversation-info">
                            <div class="subject-line">
                                ${conv.automation_id ? '<span style="background: #e3f2fd; color: #1976d2; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; margin-right: 8px;">‚ö° AUTO</span>' : ''}
                                üí¨ ${escapeHtml(conv.title || 'New Chat')}
                            </div>
                            <div class="content-snippet">${escapeHtml(conv.last_message || 'No messages yet')}</div>
                        </div>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <div class="timestamp">${formatDate(conv.updated_at)}</div>
                            <button class="icon-btn" onclick="event.stopPropagation(); deleteChatConversationFromList('${conv.id}')" title="Delete" style="font-size: 14px;">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function startNewChat() {
            try {
                const response = await fetch('/api/chat/conversations', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ title: 'New Chat' })
                });

                if (response.ok) {
                    const data = await response.json();
                    openChatConversation(data.id);
                }
            } catch (error) {
                showNotification('Failed to create chat', 'error');
            }
        }

        function openChatConversation(conversationId) {
            hideAllViews();
            let chatInterface = document.getElementById('chatInterface');
            if (!chatInterface) {
                chatInterface = createChatInterface();
                document.getElementById('dynamicViewsContainer').appendChild(chatInterface);
            }
            chatInterface.style.display = 'block';
            chatInterface.dataset.conversationId = conversationId;
            loadChatMessages(conversationId);
        }

        function createChatInterface() {
            const view = document.createElement('div');
            view.id = 'chatInterface';
            view.style.display = 'none';
            view.innerHTML = `
                <div style="display: flex; flex-direction: column; height: calc(100vh - 60px); background: white; border-radius: 8px; margin: 20px;">
                    <div style="padding: 16px; border-bottom: 1px solid #e4e6eb; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <button onclick="showChatView()" style="background: none; border: none; cursor: pointer; font-size: 20px;">‚Üê</button>
                            <span style="font-weight: 600; margin-left: 12px;">üí¨ Chat</span>
                        </div>
                        <button onclick="deleteChatConversation()" class="icon-btn" title="Delete Conversation">üóëÔ∏è</button>
                    </div>
                    <div id="chatMessagesContainer" style="flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 16px;">
                        <div class="loading">Loading messages...</div>
                    </div>
                    <div style="padding: 16px; border-top: 1px solid #e4e6eb;">
                        <div style="display: flex; gap: 8px;">
                            <textarea id="chatMessageInput" placeholder="Type your message... (Shift+Enter for new line)"
                                style="flex: 1; padding: 12px; border: 1px solid #dadde1; border-radius: 8px; resize: none; font-family: inherit; font-size: 14px;"
                                rows="3"
                                onkeydown="handleChatInputKeydown(event)"></textarea>
                            <button onclick="sendChatMessage()" class="compose-btn" style="align-self: flex-end; height: fit-content;">Send</button>
                        </div>
                    </div>
                </div>
            `;
            return view;
        }

        async function loadChatMessages(conversationId) {
            const container = document.getElementById('chatMessagesContainer');
            if (!container) return;

            try {
                const response = await fetch(`/api/chat/conversations/${conversationId}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const messages = await response.json();
                    renderChatMessages(messages);
                } else {
                    container.innerHTML = '<div class="empty-state"><h3>Failed to load messages</h3></div>';
                }
            } catch (error) {
                container.innerHTML = '<div class="empty-state"><h3>Failed to load messages</h3></div>';
            }
        }

        function renderChatMessages(messages) {
            const container = document.getElementById('chatMessagesContainer');
            if (messages.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No messages yet. Start the conversation!</p></div>';
                return;
            }

            container.innerHTML = messages.map(msg => {
                const isUser = msg.role === 'user';
                const timestamp = new Date(msg.created_at).toLocaleTimeString();
                return `
                    <div style="display: flex; ${isUser ? 'justify-content: flex-end' : 'justify-content: flex-start'}; ${!isUser ? 'animation: fadeIn 0.5s ease-in;' : ''}">
                        <div style="max-width: 70%; padding: 12px 16px; border-radius: 12px; ${isUser ? 'background: #7C9CBF; color: white;' : 'background: #f0f2f5; color: #1c1e21;'}">
                            <div style="white-space: pre-wrap; word-wrap: break-word;">${escapeHtml(msg.content)}</div>
                            <div style="font-size: 11px; margin-top: 4px; opacity: 0.7;">${timestamp}</div>
                        </div>
                    </div>
                `;
            }).join('');

            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
        }

        function handleChatInputKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendChatMessage();
            }
        }

        async function sendChatMessage() {
            const input = document.getElementById('chatMessageInput');
            const chatInterface = document.getElementById('chatInterface');
            const conversationId = chatInterface?.dataset.conversationId;
            console.log('Sending message to conversation:', conversationId);

            if (!input || !conversationId) return;

            const content = input.value.trim();
            if (!content) return;

            // Clear input and disable
            input.value = '';
            input.disabled = true;

            // Add user message to UI immediately
            const container = document.getElementById('chatMessagesContainer');
            const userMsgHtml = `
                <div style="display: flex; justify-content: flex-end;">
                    <div style="max-width: 70%; padding: 12px 16px; border-radius: 12px; background: #7C9CBF; color: white;">
                        <div style="white-space: pre-wrap; word-wrap: break-word;">${escapeHtml(content)}</div>
                        <div style="font-size: 11px; margin-top: 4px; opacity: 0.7;">${new Date().toLocaleTimeString()}</div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', userMsgHtml);

            // Add loading indicator
            const loadingHtml = `
                <div id="chatLoading" style="display: flex; justify-content: flex-start;">
                    <div style="max-width: 70%; padding: 12px 16px; border-radius: 12px; background: #f0f2f5; color: #1c1e21;">
                        <div>ü§ñ Thinking...</div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', loadingHtml);
            container.scrollTop = container.scrollHeight;

            try {
                console.log('Posting message to:', `/api/chat/conversations/${conversationId}/messages`);
                const response = await fetch(`/api/chat/conversations/${conversationId}/messages`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ content })
                });

                console.log('Message response status:', response.status);
                // Remove loading indicator
                document.getElementById('chatLoading')?.remove();

                if (response.ok) {
                    const data = await response.json();

                    // Display tool calls if any
                    if (data.tool_calls && data.tool_calls.length > 0) {
                        for (const toolCall of data.tool_calls) {
                            const toolHtml = `
                                <div style="display: flex; justify-content: flex-start; margin: 8px 0;">
                                    <div style="max-width: 70%; padding: 10px 14px; border-radius: 8px; background: #fff3cd; border-left: 3px solid #ffc107;">
                                        <div style="font-weight: 600; font-size: 12px; color: #856404; margin-bottom: 4px;">üîß Tool: ${escapeHtml(toolCall.tool)}</div>
                                        <div style="font-size: 11px; color: #856404; margin-bottom: 6px;">Args: ${escapeHtml(JSON.stringify(toolCall.args).substring(0, 100))}${JSON.stringify(toolCall.args).length > 100 ? '...' : ''}</div>
                                        <div style="font-size: 11px; color: #856404;">Result: ${escapeHtml(JSON.stringify(toolCall.result).substring(0, 150))}${JSON.stringify(toolCall.result).length > 150 ? '...' : ''}</div>
                                    </div>
                                </div>
                            `;
                            container.insertAdjacentHTML('beforeend', toolHtml);
                        }
                    }

                    // Display assistant response
                    const assistantHtml = `
                        <div style="display: flex; justify-content: flex-start;">
                            <div style="max-width: 70%; padding: 12px 16px; border-radius: 12px; background: #f0f2f5; color: #1c1e21;">
                                <div style="white-space: pre-wrap; word-wrap: break-word;">${escapeHtml(data.assistant_response)}</div>
                                <div style="font-size: 11px; margin-top: 4px; opacity: 0.7;">${new Date().toLocaleTimeString()}</div>
                            </div>
                        </div>
                    `;
                    container.insertAdjacentHTML('beforeend', assistantHtml);
                    container.scrollTop = container.scrollHeight;
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('Failed to send message:', errorData);
                    showNotification(
                        errorData.error || 'Failed to send message. Please check your AI configuration in Settings.',
                        'error');
                }
            } catch (error) {
                document.getElementById('chatLoading')?.remove();
                showNotification('Failed to send message', 'error');
            } finally {
                input.disabled = false;
                input.focus();
            }
        }

        async function deleteChatConversation() {
            // Delete from detail view (called from header button)
            const chatInterface = document.getElementById('chatInterface');
            const conversationId = chatInterface?.dataset.conversationId;
            if (!conversationId) return;

            try {
                await fetch(`/api/chat/conversations/${conversationId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                showNotification('Conversation deleted', 'success');
                showChatView();
            } catch (error) {
                showNotification('Failed to delete conversation', 'error');
            }
        }

        async function deleteChatConversationFromList(conversationId) {
            // Delete from list view (no confirmation)
            if (!conversationId) return;

            try {
                await fetch(`/api/chat/conversations/${conversationId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                showNotification('Conversation deleted', 'success');
                loadChatConversations();
            } catch (error) {
                showNotification('Failed to delete conversation', 'error');
            }
        }

        // ===== AUTOMATIONS VIEW =====
        function showAutomationsView(event) {
            hideAllViews();
            let automationsView = document.getElementById('automationsView');
            if (!automationsView) {
                automationsView = createAutomationsView();
                document.getElementById('dynamicViewsContainer').appendChild(automationsView);
            }
            automationsView.style.display = 'block';
            if (event) updateSidebarActive(event);
            loadAutomations();
        }

        function createAutomationsView() {
            const view = document.createElement('div');
            view.id = 'automationsView';
            view.style.display = 'none';
            view.className = 'tab-view';
            view.innerHTML = `
                <div class="tab-view-header">
                    <h1 class="tab-view-title">‚öôÔ∏è Automations</h1>
                    <button class="compose-btn" onclick="createAutomation()">+ New Automation</button>
                </div>
                <div id="automationsList" class="tab-view-content">
                    <div class="loading">Loading automations...</div>
                </div>
            `;
            return view;
        }

        async function loadAutomations() {
            const container = document.getElementById('automationsList');
            if (!container) return;

            try {
                const response = await fetch('/api/automations', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const automations = await response.json();
                    renderAutomations(automations);
                } else {
                    container.innerHTML = '<div class="empty-state"><h3>No automations yet</h3><p>Create an automation to run AI tasks on a schedule</p></div>';
                }
            } catch (error) {
                container.innerHTML = '<div class="empty-state"><h3>No automations yet</h3><p>Create an automation to run AI tasks on a schedule</p></div>';
            }
        }

        function renderAutomations(automations) {
            const container = document.getElementById('automationsList');
            if (automations.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>No automations yet</h3><p>Create an automation to run AI tasks on a schedule</p></div>';
                return;
            }

            container.innerHTML = automations.map(auto => `
                <div class="tab-card">
                    <div class="tab-card-header">
                        <div class="tab-card-body">
                            <div class="tab-card-title">${escapeHtml(auto.name)}</div>
                            <div class="tab-card-description">${escapeHtml(auto.description || '')}</div>
                            <div class="tab-card-meta">
                                <span>üìÖ ${escapeHtml(auto.schedule_human || auto.schedule)}</span>
                                ${auto.last_run ? ` ‚Ä¢ Last run: ${formatDate(auto.last_run)}` : ''}
                            </div>
                        </div>
                        <div class="tab-card-actions">
                            <label class="tab-card-toggle">
                                <input type="checkbox" ${auto.enabled ? 'checked' : ''}
                                    onchange="toggleAutomation('${auto.id}', this.checked)"
                                    >
                                <span style="font-size: 13px;">${auto.enabled ? 'Enabled' : 'Disabled'}</span>
                            </label>
                            <button class="icon-btn" onclick="runAutomation('${auto.id}')" title="Run Now">‚ñ∂Ô∏è</button>
                            <button class="icon-btn" onclick="editAutomation('${auto.id}')" title="Edit">‚úèÔ∏è</button>
                            <button class="icon-btn" onclick="deleteAutomation('${auto.id}')" title="Delete">üóëÔ∏è</button>
                            <button class="icon-btn" onclick="viewAutomationDetail('${auto.id}')" title="View Details & Runs">üìä</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function createAutomation() {
            const modal = document.createElement('div');
            modal.id = 'automationModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 24px; max-width: 500px; width: 90%;">
                    <h2 style="margin: 0 0 20px 0; font-size: 20px;">Create Automation</h2>
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" id="automationName" placeholder="Daily email summary" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px;">
                    </div>
                    <div class="form-group">
                        <label>Description (optional)</label>
                        <input type="text" id="automationDescription" placeholder="Summarize unread emails" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px;">
                    </div>
                    <div class="form-group">
                        <label>Schedule (cron expression)</label>
                        <select id="automationSchedulePreset" onchange="updateScheduleInput(this.value)" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px; margin-bottom: 8px;">
                            <option value="">Custom</option>
                            <option value="0 9 * * *">Daily at 9 AM</option>
                            <option value="0 9 * * 1">Weekly on Monday at 9 AM</option>
                            <option value="0 9 1 * *">Monthly on 1st at 9 AM</option>
                            <option value="0 */6 * * *">Every 6 hours</option>
                        </select>
                        <input type="text" id="automationSchedule" placeholder="0 9 * * *" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px;">
                        <small style="color: #65676b;">Format: minute hour day month weekday</small>
                    </div>
                    <div class="form-group">
                        <label>AI Prompt</label>
                        <textarea id="automationPrompt" placeholder="Summarize all unread emails from the last 24 hours" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px; resize: vertical;" rows="4"></textarea>
                    </div>
                    <div style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 20px;">
                        <button onclick="closeAutomationModal()" style="padding: 8px 16px; border: 1px solid #dadde1; background: white; border-radius: 6px; cursor: pointer;">Cancel</button>
                        <button onclick="saveAutomation()" class="compose-btn">Create</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function updateScheduleInput(preset) {
            const input = document.getElementById('automationSchedule');
            if (preset && input) {
                input.value = preset;
            }
        }

        function closeAutomationModal() {
            const modal = document.getElementById('automationModal');
            if (modal) modal.remove();
        }

        async function saveAutomation() {
            const name = document.getElementById('automationName').value.trim();
            const description = document.getElementById('automationDescription').value.trim();
            const schedule = document.getElementById('automationSchedule').value.trim();
            const prompt = document.getElementById('automationPrompt').value.trim();

            if (!name) {
                showNotification('Please enter a name', 'error');
                return;
            }
            if (!schedule) {
                showNotification('Please enter a schedule', 'error');
                return;
            }
            if (!prompt) {
                showNotification('Please enter a prompt', 'error');
                return;
            }

            try {
                const response = await fetch('/api/automations', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name,
                        description: description || null,
                        schedule,
                        prompt,
                        enabled: true
                    })
                });

                if (response.ok) {
                    showNotification('Automation created', 'success');
                    closeAutomationModal();
                    loadAutomations();
                } else {
                    showNotification('Failed to create automation', 'error');
                }
            } catch (error) {
                showNotification('Failed to create automation', 'error');
            }
        }

        async function runAutomation(automationId) {
            if (!confirm('Run this automation now?')) return;

            showNotification('Running automation...', 'info');

            try {
                const response = await fetch(`/api/automations/${automationId}/trigger`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    showNotification('‚úÖ Automation completed! Check Goose Chat for results.', 'success');
                    loadAutomations();
                } else {
                    showNotification('Failed to run automation', 'error');
                }
            } catch (error) {
                console.error('Failed to run automation:', error);
                showNotification('Failed to run automation', 'error');
            }
        }

        async function viewAutomationTools() {
            try {
                const response = await fetch('/api/agent/tools', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    const tools = data.tools;

                    const modal = document.createElement('div');
                    modal.id = 'toolsModal';
                    modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000; overflow-y: auto;';
                    modal.innerHTML = `
                        <div style="background: white; border-radius: 12px; padding: 24px; max-width: 800px; width: 90%; max-height: 80vh; overflow-y: auto;">
                            <h2 style="margin: 0 0 20px 0; font-size: 20px;">üîß Available AI Tools (${tools.length})</h2>
                            <div style="display: grid; gap: 16px;">
                                ${tools.map(tool => `
                                    <div style="border: 1px solid #e4e6eb; border-radius: 8px; padding: 16px;">
                                        <div style="font-weight: 600; font-size: 16px; margin-bottom: 8px;">${tool.name}</div>
                                        <div style="color: #65676b; margin-bottom: 12px;">${tool.description}</div>
                                        ${tool.parameters.length > 0 ? `
                                            <div style="font-size: 14px;">
                                                <div style="font-weight: 600; margin-bottom: 4px;">Parameters:</div>
                                                <ul style="margin: 0; padding-left: 20px;">
                                                    ${tool.parameters.map(param => `
                                                        <li style="margin-bottom: 4px;">
                                                            <code style="background: #f0f2f5; padding: 2px 6px; border-radius: 3px;">${param.name}</code>
                                                            <span style="color: #8a8d91;">(${param.param_type}${param.required ? ', required' : ', optional'})</span>
                                                            - ${param.description}
                                                        </li>
                                                    `).join('')}
                                                </ul>
                                            </div>
                                        ` : ''}
                                    </div>
                                `).join('')}
                            </div>
                            <div style="margin-top: 20px; text-align: right;">
                                <button onclick="document.getElementById('toolsModal').remove()" class="compose-btn">Close</button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                }
            } catch (error) {
                console.error('Failed to load tools:', error);
                showNotification('Failed to load tools', 'error');
            }
        }

        async function toggleAutomation(id, enabled) {
            try {
                await fetch(`/api/automations/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ enabled })
                });
                showNotification(`Automation ${enabled ? 'enabled' : 'disabled'}`, 'success');
            } catch (error) {
                showNotification('Failed to update automation', 'error');
            }
        }

        async function runAutomation(id) {
            try {
                await fetch(`/api/automations/${id}/trigger`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                showNotification('Automation triggered', 'success');
            } catch (error) {
                showNotification('Failed to run automation', 'error');
            }
        }

        async function editAutomation(id) {
            try {
                // Fetch automation details
                const response = await fetch(`/api/automations/${id}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!response.ok) {
                    showNotification('Failed to load automation', 'error');
                    return;
                }

                const automation = await response.json();

                // Create edit modal
                const modal = document.createElement('div');
                modal.id = 'automationEditModal';
                modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
                modal.innerHTML = `
                    <div style="background: white; border-radius: 12px; padding: 24px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h2 style="margin: 0; font-size: 20px;">Edit Automation</h2>
                            <button onclick="document.getElementById('automationEditModal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                        </div>

                        <div class="form-group">
                            <label style="font-weight: 600; display: block; margin-bottom: 8px;">Name</label>
                            <input type="text" id="editAutomationName" value="${escapeHtml(automation.name)}" style="width: 100%; padding: 10px; border: 1px solid #dadde1; border-radius: 6px; font-size: 14px;">
                        </div>

                        <div class="form-group">
                            <label style="font-weight: 600; display: block; margin-bottom: 8px;">Description (optional)</label>
                            <input type="text" id="editAutomationDescription" value="${escapeHtml(automation.description || '')}" style="width: 100%; padding: 10px; border: 1px solid #dadde1; border-radius: 6px; font-size: 14px;">
                        </div>

                        <div class="form-group">
                            <label style="font-weight: 600; display: block; margin-bottom: 8px;">Schedule (cron expression)</label>
                            <select id="editAutomationSchedulePreset" onchange="updateEditScheduleInput(this.value)" style="width: 100%; padding: 10px; border: 1px solid #dadde1; border-radius: 6px; margin-bottom: 8px; font-size: 14px;">
                                <option value="">Custom</option>
                                <option value="0 9 * * *">Daily at 9 AM</option>
                                <option value="0 9 * * 1">Weekly on Monday at 9 AM</option>
                                <option value="0 9 1 * *">Monthly on 1st at 9 AM</option>
                                <option value="0 */6 * * *">Every 6 hours</option>
                                <option value="0 */1 * * *">Every hour</option>
                                <option value="*/30 * * * *">Every 30 minutes</option>
                            </select>
                            <input type="text" id="editAutomationSchedule" value="${escapeHtml(automation.schedule)}" placeholder="0 9 * * *" style="width: 100%; padding: 10px; border: 1px solid #dadde1; border-radius: 6px; font-size: 14px;">
                            <div style="font-size: 12px; color: #65676b; margin-top: 4px;">üìÖ ${escapeHtml(automation.schedule_human)}</div>
                            <small style="color: #65676b; font-size: 12px;">Format: minute hour day month weekday</small>
                        </div>

                        <div class="form-group">
                            <label style="font-weight: 600; display: block; margin-bottom: 8px;">AI Prompt</label>
                            <textarea id="editAutomationPrompt" placeholder="Summarize all unread emails from the last 24 hours" style="width: 100%; padding: 10px; border: 1px solid #dadde1; border-radius: 6px; resize: vertical; font-size: 14px; font-family: inherit;" rows="6">${escapeHtml(automation.prompt)}</textarea>
                            <small style="color: #65676b; font-size: 12px;">This prompt will be sent to the AI agent when the automation runs</small>
                        </div>

                        <div class="form-group">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" id="editAutomationEnabled" ${automation.enabled ? 'checked' : ''} style="margin-right: 8px;">
                                <span style="font-weight: 600;">Enabled</span>
                            </label>
                        </div>

                        <div style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 24px;">
                            <button onclick="document.getElementById('automationEditModal').remove()" style="padding: 10px 20px; border: 1px solid #dadde1; background: white; border-radius: 6px; cursor: pointer; font-size: 14px;">Cancel</button>
                            <button onclick="saveAutomationEdit('${id}')" class="compose-btn" style="padding: 10px 20px;">Save Changes</button>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);
            } catch (error) {
                console.error('Failed to load automation for editing:', error);
                showNotification('Failed to load automation', 'error');
            }
        }

        function updateEditScheduleInput(preset) {
            const input = document.getElementById('editAutomationSchedule');
            if (preset && input) {
                input.value = preset;
            }
        }

        async function saveAutomationEdit(id) {
            const name = document.getElementById('editAutomationName').value.trim();
            const description = document.getElementById('editAutomationDescription').value.trim();
            const schedule = document.getElementById('editAutomationSchedule').value.trim();
            const prompt = document.getElementById('editAutomationPrompt').value.trim();
            const enabled = document.getElementById('editAutomationEnabled').checked;

            if (!name) {
                showNotification('Please enter a name', 'error');
                return;
            }
            if (!schedule) {
                showNotification('Please enter a schedule', 'error');
                return;
            }
            if (!prompt) {
                showNotification('Please enter a prompt', 'error');
                return;
            }

            try {
                const response = await fetch(`/api/automations/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name, description: description || null, schedule, prompt, enabled })
                });

                if (response.ok) {
                    showNotification('Automation updated successfully', 'success');
                    document.getElementById('automationEditModal').remove();
                    loadAutomations();
                } else {
                    const error = await response.json().catch(() => ({}));
                    showNotification(error.error || 'Failed to update automation', 'error');
                }
            } catch (error) {
                console.error('Failed to save automation:', error);
                showNotification('Failed to update automation', 'error');
            }
        }

        async function deleteAutomation(id) {
            if (!confirm('Delete this automation?')) return;
            try {
                await fetch(`/api/automations/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                showNotification('Automation deleted', 'success');
                loadAutomations();
            } catch (error) {
                showNotification('Failed to delete automation', 'error');
            }
        }

        async function viewAutomationDetail(automationId) {
            try {
                // Fetch automation details
                const autoResponse = await fetch(`/api/automations/${automationId}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!autoResponse.ok) {
                    showNotification('Failed to load automation details', 'error');
                    return;
                }

                const automation = await autoResponse.json();

                // Fetch automation runs
                const runsResponse = await fetch(`/api/automations/${automationId}/runs`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                const runs = runsResponse.ok ? await runsResponse.json() : [];

                // Create modal
                const modal = document.createElement('div');
                modal.id = 'automationDetailModal';
                modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000; overflow-y: auto; padding: 20px;';
                modal.innerHTML = `
                    <div style="background: white; border-radius: 12px; padding: 24px; max-width: 800px; width: 100%; max-height: 90vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h2 style="margin: 0; font-size: 20px;">Automation Details</h2>
                            <button onclick="document.getElementById('automationDetailModal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                        </div>

                        <!-- Automation Info -->
                        <div style="background: #f5f5f5; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                            <div style="margin-bottom: 12px;">
                                <label style="font-weight: 600; display: block; margin-bottom: 4px;">Name</label>
                                <input type="text" id="editName" value="${escapeHtml(automation.name)}" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px;">
                            </div>
                            <div style="margin-bottom: 12px;">
                                <label style="font-weight: 600; display: block; margin-bottom: 4px;">Description</label>
                                <input type="text" id="editDescription" value="${escapeHtml(automation.description || '')}" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px;">
                            </div>
                            <div style="margin-bottom: 12px;">
                                <label style="font-weight: 600; display: block; margin-bottom: 4px;">Schedule (Cron)</label>
                                <input type="text" id="editSchedule" value="${escapeHtml(automation.schedule)}" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px;">
                                <div style="font-size: 12px; color: #65676b; margin-top: 4px;">üìÖ ${escapeHtml(automation.schedule_human)}</div>
                            </div>
                            <div style="margin-bottom: 12px;">
                                <label style="font-weight: 600; display: block; margin-bottom: 4px;">Prompt</label>
                                <textarea id="editPrompt" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px; min-height: 100px;">${escapeHtml(automation.prompt)}</textarea>
                            </div>
                            <div style="margin-bottom: 12px;">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" id="editEnabled" ${automation.enabled ? 'checked' : ''} style="margin-right: 8px;">
                                    <span style="font-weight: 600;">Enabled</span>
                                </label>
                            </div>
                            <button class="compose-btn" onclick="saveAutomationDetails('${automationId}')" style="width: 100%;">Save Changes</button>
                        </div>

                        <!-- Runs History -->
                        <div>
                            <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 12px;">Run History</h3>
                            ${runs.length === 0 ? '<p style="color: #65676b;">No runs yet</p>' : `
                                <div style="display: grid; gap: 8px;">
                                    ${runs.map(run => `
                                        <div style="background: ${run.status === 'success' ? '#e7f3e7' : run.status === 'failed' ? '#fce8e8' : '#f0f0f0'}; padding: 12px; border-radius: 6px; cursor: pointer;" onclick="viewRunDetail('${automationId}', '${run.id}')">
                                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                                <div>
                                                    <span style="font-weight: 600;">${run.status === 'success' ? '‚úÖ' : run.status === 'failed' ? '‚ùå' : '‚è≥'} ${run.status.toUpperCase()}</span>
                                                    <div style="font-size: 12px; color: #65676b; margin-top: 4px;">
                                                        Started: ${formatDate(run.started_at)}
                                                        ${run.completed_at ? ` ‚Ä¢ Completed: ${formatDate(run.completed_at)}` : ''}
                                                    </div>
                                                </div>
                                                <button class="btn-secondary" onclick="event.stopPropagation(); viewRunDetail('${automationId}', '${run.id}')" style="font-size: 12px; padding: 4px 8px;">View ‚Üí</button>
                                            </div>
                                            ${run.error ? `<div style="color: #c41e3a; font-size: 12px; margin-top: 8px;">Error: ${escapeHtml(run.error)}</div>` : ''}
                                        </div>
                                    `).join('')}
                                </div>
                            `}
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);
            } catch (error) {
                console.error('Failed to load automation details:', error);
                showNotification('Failed to load automation details', 'error');
            }
        }

        async function saveAutomationDetails(automationId) {
            const name = document.getElementById('editName').value;
            const description = document.getElementById('editDescription').value;
            const schedule = document.getElementById('editSchedule').value;
            const prompt = document.getElementById('editPrompt').value;
            const enabled = document.getElementById('editEnabled').checked;

            try {
                const response = await fetch(`/api/automations/${automationId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name, description, schedule, prompt, enabled })
                });

                if (response.ok) {
                    showNotification('Automation updated', 'success');
                    document.getElementById('automationDetailModal').remove();
                    loadAutomations();
                } else {
                    showNotification('Failed to update automation', 'error');
                }
            } catch (error) {
                showNotification('Failed to update automation', 'error');
            }
        }

        async function viewRunDetail(automationId, runId) {
            // This will open the chat conversation associated with the run
            window.location.hash = '#goose';
            showGooseView();
        }

        // ===== REMINDERS VIEW =====
        function showRemindersView(event) {
            hideAllViews();
            let remindersView = document.getElementById('remindersView');
            if (!remindersView) {
                remindersView = createRemindersView();
                document.getElementById('dynamicViewsContainer').appendChild(remindersView);
            }
            remindersView.style.display = 'block';
            if (event) updateSidebarActive(event);
            loadReminders();
        }

        function createRemindersView() {
            const view = document.createElement('div');
            view.id = 'remindersView';
            view.style.display = 'none';
            view.className = 'tab-view';
            view.innerHTML = `
                <div class="tab-view-header">
                    <h1 class="tab-view-title">‚úì Reminders</h1>
                    <button class="compose-btn" onclick="createReminder()">+ New Reminder</button>
                </div>
                    <div style="margin-bottom: 16px; display: flex; gap: 8px;">
                        <button class="filter-btn active" data-filter="active" onclick="filterReminders('active')">Active</button>
                        <button class="filter-btn" data-filter="completed" onclick="filterReminders('completed')">Completed</button>
                        <button class="filter-btn" data-filter="all" onclick="filterReminders('all')">All</button>
                    </div>
                <div id="remindersList" class="tab-view-content">
                    <div class="loading">Loading reminders...</div>
            `;
            return view;
        }

        let currentReminderFilter = 'active';

        async function loadReminders() {
            const container = document.getElementById('remindersList');
            if (!container) return;

            try {
                const response = await fetch(`/api/reminders?filter=${currentReminderFilter}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const reminders = await response.json();
                    renderReminders(reminders);
                } else {
                    container.innerHTML = '<div class="empty-state"><h3>No reminders yet</h3><p>Create a reminder to track your tasks</p></div>';
                }
            } catch (error) {
                container.innerHTML = '<div class="empty-state"><h3>No reminders yet</h3><p>Create a reminder to track your tasks</p></div>';
            }
        }

        function renderReminders(reminders) {
            const container = document.getElementById('remindersList');
            if (reminders.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>No reminders found</h3></div>';
                return;
            }

            container.innerHTML = reminders.map(reminder => {
                const isOverdue = reminder.due_date && new Date(reminder.due_date) < new Date() && !reminder.completed;
                return `
                <div class="tab-card" style="${reminder.completed ? 'opacity: 0.6;' : ''}">
                    <div style="display: flex; gap: 12px; align-items: start; width: 100%;">
                        <input type="checkbox" ${reminder.completed ? 'checked' : ''}
                            onchange="toggleReminder('${reminder.id}', this.checked)"
                            style="margin-top: 4px; cursor: pointer;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; margin-bottom: 4px; ${reminder.completed ? 'text-decoration: line-through;' : ''}">
                                ${escapeHtml(reminder.title)}
                            </div>
                            ${reminder.notes ? `<div style="color: #65676b; font-size: 14px; margin-bottom: 8px;">${escapeHtml(reminder.notes)}</div>` : ''}
                            ${reminder.due_date ? `
                                <div style="font-size: 13px; color: ${isOverdue ? '#c62828' : '#8a8d91'};">
                                    üìÖ Due: ${formatDate(reminder.due_date)} ${isOverdue ? '(Overdue)' : ''}
                                </div>
                            ` : ''}
                        </div>
                        <div style="display: flex; gap: 4px;">
                            <button class="icon-btn" onclick="editReminder('${reminder.id}')" title="Edit">‚úèÔ∏è</button>
                            <button class="icon-btn" onclick="deleteReminder('${reminder.id}')" title="Delete">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>
            `;
            }).join('');
        }

        function filterReminders(filter) {
            currentReminderFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });
            loadReminders();
        }

        function createReminder() {
            const modal = document.createElement('div');
            modal.id = 'reminderModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 24px; max-width: 500px; width: 90%;">
                    <h2 style="margin: 0 0 20px 0; font-size: 20px;">Create Reminder</h2>
                    <div class="form-group">
                        <label>Title</label>
                        <input type="text" id="reminderTitle" placeholder="Complete project report" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px;">
                    </div>
                    <div class="form-group">
                        <label>Notes (optional)</label>
                        <textarea id="reminderNotes" placeholder="Include Q4 metrics and team feedback" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px; resize: vertical;" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Due Date (optional)</label>
                        <input type="datetime-local" id="reminderDueDate" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px;">
                    </div>
                    <div style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 20px;">
                        <button onclick="closeReminderModal()" style="padding: 8px 16px; border: 1px solid #dadde1; background: white; border-radius: 6px; cursor: pointer;">Cancel</button>
                        <button onclick="saveReminder()" class="compose-btn">Create</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function closeReminderModal() {
            const modal = document.getElementById('reminderModal');
            if (modal) modal.remove();
        }

        async function saveReminder() {
            const title = document.getElementById('reminderTitle').value.trim();
            const notes = document.getElementById('reminderNotes').value.trim();
            const due_date = document.getElementById('reminderDueDate').value;

            if (!title) {
                showNotification('Please enter a title', 'error');
                return;
            }

            try {
                const response = await fetch('/api/reminders', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title,
                        notes: notes || null,
                        due_date: due_date ? new Date(due_date).toISOString() : null
                    })
                });

                if (response.ok) {
                    showNotification('Reminder created', 'success');
                    closeReminderModal();
                    loadReminders();
                } else {
                    showNotification('Failed to create reminder', 'error');
                }
            } catch (error) {
                showNotification('Failed to create reminder', 'error');
            }
        }

        async function toggleReminder(id, completed) {
            try {
                await fetch(`/api/reminders/${id}/complete`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ completed })
                });
                loadReminders();
            } catch (error) {
                showNotification('Failed to update reminder', 'error');
            }
        }

        function editReminder(id) {
            showNotification('Reminder editing coming soon!', 'info');
        }

        async function deleteReminder(id) {
            if (!confirm('Delete this reminder?')) return;
            try {
                await fetch(`/api/reminders/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                showNotification('Reminder deleted', 'success');
                loadReminders();
            } catch (error) {
                showNotification('Failed to delete reminder', 'error');
            }
        }

        // ===== SETTINGS VIEW =====
        function showSettingsView(event) {
            hideAllViews();
            let settingsView = document.getElementById('settingsView');
            if (!settingsView) {
                settingsView = createSettingsView();
                document.getElementById('dynamicViewsContainer').appendChild(settingsView);
            }
            settingsView.style.display = 'block';
            if (event) updateSidebarActive(event);
        }

        function createSettingsView() {
            const view = document.createElement('div');
            view.id = 'settingsView';
            view.style.display = 'none';
            view.className = 'tab-view';
            view.innerHTML = `
                <div style="max-width: 800px;">
                    <h1 class="tab-view-title" style="margin-bottom: 24px;">‚öôÔ∏è Settings</h1>

                    <div style="background: white; border-radius: 8px; padding: 20px; margin-bottom: 16px;">
                        <h2 style="font-size: 18px; font-weight: 600; margin-bottom: 16px;">Email Settings</h2>
                        <div class="form-group">
                            <label>IMAP Host</label>
                            <input id="setting-imap-host" type="text" placeholder="imap.gmail.com" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px;">
                        </div>
                        <div class="form-group">
                            <label>SMTP Host</label>
                            <input id="setting-smtp-host" type="text" placeholder="smtp.gmail.com" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px;">
                        </div>
                    </div>

                    <div style="background: white; border-radius: 8px; padding: 20px; margin-bottom: 16px;">
                        <h2 style="font-size: 18px; font-weight: 600; margin-bottom: 16px;">AI Agent Settings</h2>
                        <div class="form-group">
                            <label>LLM Provider</label>
                            <select id="setting-llm-provider" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px;">
                                <option>Anthropic</option>
                                <option>OpenAI</option>
                                <option>Databricks</option>
                                <option>Local GGUF</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>API Key</label>
                            <input id="setting-api-key" type="password" placeholder="Enter API key" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px;">
                        </div>
                        <div class="form-group">
                            <label>Model ID</label>
                            <input id="setting-model-id" type="text" placeholder="claude-3-5-sonnet-20241022" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px;">
                        </div>
                    </div>

                    <div style="background: white; border-radius: 8px; padding: 20px; margin-bottom: 16px;">
                        <h2 style="font-size: 18px; font-weight: 600; margin-bottom: 16px;">Calendar Settings</h2>
                        <div class="form-group">
                            <label>CalDAV Server URL</label>
                            <input id="setting-caldav-url" type="text" placeholder="https://caldav.example.com" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px;">
                        </div>
                        <div class="form-group">
                            <label>Username</label>
                            <input id="setting-caldav-username" type="text" placeholder="username" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px;">
                        </div>
                        <div class="form-group">
                            <label>Password</label>
                            <input id="setting-caldav-password" type="password" placeholder="password" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px;">
                        </div>
                    </div>

                    <div style="background: white; border-radius: 8px; padding: 20px;">
                        <h2 style="font-size: 18px; font-weight: 600; margin-bottom: 16px;">Personal Money Settings</h2>
                        <div class="form-group">
                            <label>Bank Account</label>
                            <input id="setting-bank-account" type="text" placeholder="Account credentials" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px;">
                        </div>
                        <div class="form-group">
                            <label>Cash App ID</label>
                            <input id="setting-cashapp-id" type="text" placeholder="$cashtag" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px;">
                        </div>
                    </div>

                    <div style="margin-top: 20px; text-align: right;">
                        <button class="compose-btn" id="save-settings-btn" style="padding: 12px 32px;">üíæ Save Settings</button>
                    </div>

                    <div id="settings-save-status" style="margin-top: 16px; padding: 12px; border-radius: 8px; display: none;"></div>
                </div>
            `;

            // Attach event listener after DOM is created
            setTimeout(() => {
                const saveBtn = document.getElementById('save-settings-btn');
                if (saveBtn) {
                    saveBtn.addEventListener('click', saveSettings);
                }
            }, 0);

            // Add auto-save listeners after view is created
            setTimeout(() => {
                const settingInputs = [
                    'setting-imap-host', 'setting-smtp-host', 'setting-llm-provider',
                    'setting-api-key', 'setting-model-id', 'setting-caldav-url',
                    'setting-caldav-username', 'setting-caldav-password',
                    'setting-bank-account', 'setting-cashapp-id'
                ];

                settingInputs.forEach(id => {
                    const input = document.getElementById(id);
                    if (input) {
                        input.addEventListener('change', () => saveSettings());
                    }
                });

                // Load current settings
                loadSettings();
            }, 100);

            return view;
        }

        async function loadSettings() {
            try {
                // Load user settings from database
                const response = await fetch('/api/settings', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const settings = await response.json();

                    // Populate AI settings
                    if (settings.ai_provider) {
                        const providerSelect = document.getElementById('setting-llm-provider');
                        if (providerSelect) {
                            providerSelect.value = settings.ai_provider.charAt(0).toUpperCase() + settings.ai_provider.slice(1);
                        }
                    }
                    if (settings.ai_api_key) {
                        const apiKeyInput = document.getElementById('setting-api-key');
                        if (apiKeyInput) apiKeyInput.value = settings.ai_api_key;
                    }
                    if (settings.ai_model) {
                        const modelInput = document.getElementById('setting-model-id');
                        if (modelInput) modelInput.value = settings.ai_model;
                    }

                    console.log('Settings loaded:', settings);
                }

                // Load environment settings (API keys, etc.)
                const envResponse = await fetch('/api/settings/env', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (envResponse.ok) {
                    const envSettings = await envResponse.json();
                    if (envSettings.anthropic_api_key) {
                        const apiKeyInput = document.getElementById('setting-api-key');
                        if (apiKeyInput) apiKeyInput.value = envSettings.anthropic_api_key;
                    }
                    // Load CalDAV settings from environment
                    if (envSettings.caldav_url) {
                        const caldavUrlInput = document.getElementById('setting-caldav-url');
                        if (caldavUrlInput) caldavUrlInput.value = envSettings.caldav_url;
                    }
                    if (envSettings.caldav_username) {
                        const caldavUsernameInput = document.getElementById('setting-caldav-username');
                        if (caldavUsernameInput) caldavUsernameInput.value = envSettings.caldav_username;
                    }
                    if (envSettings.caldav_password) {
                        const caldavPasswordInput = document.getElementById('setting-caldav-password');
                        if (caldavPasswordInput) caldavPasswordInput.value = envSettings.caldav_password;
                    }
                    console.log('Environment settings loaded');
                }
            } catch (error) {
                console.error('Failed to load settings:', error);
            }
        }

        async function saveSettings() {
            console.log('saveSettings() called');
            console.log('authToken:', authToken ? 'exists' : 'missing');

            if (!authToken) {
                alert('Not authenticated. Please log in again.');
                return;
            }

            const settings = {
                // User preferences
                // imap_host: document.getElementById('setting-imap-host')?.value,
                // smtp_host: document.getElementById('setting-smtp-host')?.value,
                ai_provider: document.getElementById('setting-llm-provider')?.value?.toLowerCase(),
                ai_api_key: document.getElementById('setting-api-key')?.value,
                ai_model: document.getElementById('setting-model-id')?.value,
                caldav_url: document.getElementById('setting-caldav-url')?.value,
                caldav_username: document.getElementById('setting-caldav-username')?.value,
                caldav_password: document.getElementById('setting-caldav-password')?.value,
                bank_account: document.getElementById('setting-bank-account')?.value,
                cashapp_id: document.getElementById('setting-cashapp-id')?.value
            };

            console.log('Settings to save:', settings);

            try {
                const statusDiv = document.getElementById('settings-save-status');
                statusDiv.style.display = 'block';
                statusDiv.style.background = '#e3f2fd';
                statusDiv.style.color = '#1976d2';
                statusDiv.textContent = '‚è≥ Saving settings...';

                // Save user settings to database
                console.log('Sending PUT /api/settings...');
                const response = await fetch('/api/settings', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settings)
                });

                console.log('Database save response:', response.status, response.ok);

                // Save API key to .env file
                if (settings.ai_api_key || settings.caldav_url || settings.caldav_username || settings.caldav_password) {
                    console.log('Sending POST /api/settings/env...');
                    const envResponse = await fetch('/api/settings/env', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            anthropic_api_key: settings.ai_api_key,
                            caldav_url: settings.caldav_url,
                            caldav_username: settings.caldav_username,
                            caldav_password: settings.caldav_password
                        })
                    });

                    console.log('Env save response:', envResponse.status, envResponse.ok);

                    if (envResponse.ok) {
                        const envResult = await envResponse.json();
                        console.log('Environment settings saved:', envResult.message);
                    } else {
                        const errorText = await envResponse.text();
                        console.error('Failed to save env settings:', errorText);
                    }
                }

                if (response.ok) {
                    statusDiv.style.display = 'block';
                    statusDiv.style.background = '#e8f5e8';
                    statusDiv.style.color = '#2e7d32';
                    statusDiv.textContent = '‚úì Settings saved successfully';
                    setTimeout(() => { statusDiv.style.display = 'none'; }, 3000);
                } else {
                    statusDiv.style.display = 'block';
                    statusDiv.style.background = '#ffebee';
                    statusDiv.style.color = '#c62828';
                    statusDiv.textContent = '‚úó Failed to save settings';
                }
            } catch (error) {
                console.error('Failed to save settings:', error);
                const statusDiv = document.getElementById('settings-save-status');
                statusDiv.style.display = 'block';
                statusDiv.style.background = '#ffebee';
                statusDiv.style.color = '#c62828';
                statusDiv.textContent = `‚úó Error: ${error.message}`;
            }
        }

        // ===== CALENDAR VIEW =====
        function showCalendarView(event) {
            hideAllViews();
            let calendarView = document.getElementById('calendarView');
            if (!calendarView) {
                calendarView = createCalendarView();
                document.getElementById('dynamicViewsContainer').appendChild(calendarView);
            }
            calendarView.style.display = 'block';
            if (event) updateSidebarActive(event);
            loadCalendarEvents(); // Load events for list view
            renderWeekCalendar(); // Render week view by default
        }

        function createCalendarView() {
            const view = document.createElement('div');
            view.id = 'calendarView';
            view.style.display = 'none';
            view.className = 'tab-view';
            view.innerHTML = `
                <div class="tab-view-header">
                    <h1 class="tab-view-title">üìÖ Calendar</h1>
                    <div style="display: flex; gap: 8px;">
                        <button class="compose-btn" onclick="toggleCalendarView()" id="calendarViewToggle">List View</button>
                        <button class="compose-btn" onclick="createCalendarEvent()">+ New Event</button>
                    </div>
                </div>
                <div id="calendarWeekView" style="display: block;"></div>
                <div id="calendarEventsList" style="display: none; gap: 12px;">
                    <div class="loading">Loading events...</div>
                </div>
            `;
            return view;
        }

        let calendarViewMode = 'week'; // 'list' or 'week' - default to week view

        function toggleCalendarView() {
            const weekView = document.getElementById('calendarWeekView');
            const listView = document.getElementById('calendarEventsList');
            const toggleBtn = document.getElementById('calendarViewToggle');

            if (calendarViewMode === 'list') {
                calendarViewMode = 'week';
                weekView.style.display = 'block';
                listView.style.display = 'none';
                toggleBtn.textContent = 'List View';
                renderWeekCalendar();
            } else {
                calendarViewMode = 'list';
                weekView.style.display = 'none';
                listView.style.display = 'block';
                toggleBtn.textContent = 'Week View';
            }
        }

        async function renderWeekCalendar() {
            const container = document.getElementById('calendarWeekView');
            if (!container) return;

            // Get current week dates
            const today = new Date();
            const currentDay = today.getDay();
            const monday = new Date(today);
            monday.setDate(today.getDate() - (currentDay === 0 ? 6 : currentDay - 1));

            const weekDays = [];
            for (let i = 0; i < 7; i++) {
                const day = new Date(monday);
                day.setDate(monday.getDate() + i);
                weekDays.push(day);
            }

            // Fetch events for the week
            const dateFrom = weekDays[0].toISOString().split('T')[0];
            const dateTo = new Date(weekDays[6]);
            dateTo.setDate(dateTo.getDate() + 1);
            const dateToStr = dateTo.toISOString().split('T')[0];

            let events = [];
            try {
                const response = await fetch(`/api/calendar/events?date_from=${dateFrom}&date_to=${dateToStr}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (response.ok) {
                    events = await response.json();
                }
            } catch (error) {
                console.error('Failed to load events:', error);
            }

            // Render week calendar
            const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

            let html = `
                <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-bottom: 16px;">
            `;

            // Header row with day names and dates
            weekDays.forEach((day, idx) => {
                const isToday = day.toDateString() === today.toDateString();
                html += `
                    <div style="background: ${isToday ? '#e7f3ff' : 'white'}; padding: 12px; border-radius: 8px; text-align: center; border: ${isToday ? '2px solid #7C9CBF' : '1px solid #e4e6eb'};">
                        <div style="font-weight: 600; font-size: 14px;">${dayNames[idx]}</div>
                        <div style="font-size: 24px; font-weight: 600; margin: 4px 0;">${day.getDate()}</div>
                        <div style="font-size: 12px; color: #65676b;">${day.toLocaleDateString('en-US', { month: 'short' })}</div>
                    </div>
                `;
            });

            html += `</div>`;

            // Events grid
            html += `<div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; min-height: 400px;">`;

            weekDays.forEach((day) => {
                const dayStr = day.toISOString().split('T')[0];
                const dayEvents = events.filter(e => {
                    // SQLite returns datetime as "2025-10-29 12:00:00", need to convert to ISO format
                    const eventDateStr = e.start_time.replace(' ', 'T');
                    const eventDate = new Date(eventDateStr).toISOString().split('T')[0];
                    return eventDate === dayStr;
                });

                html += `
                    <div style="background: #f7f8fa; padding: 8px; border-radius: 8px; min-height: 400px;">
                `;

                dayEvents.forEach(event => {
                    // SQLite returns datetime as "2025-10-29 12:00:00", need to convert to ISO format
                    const startTimeStr = event.start_time.replace(' ', 'T');
                    const startTime = new Date(startTimeStr);
                    const endTime = new Date(event.end_time.replace(' ', 'T'));
                    const timeStr = `${startTime.getHours()}:${String(startTime.getMinutes()).padStart(2, '0')}`;

                    html += `
                        <div style="background: #7C9CBF; color: white; padding: 8px; border-radius: 6px; margin-bottom: 8px; cursor: pointer; font-size: 12px;"
                             onclick="editCalendarEvent('${event.id}')" title="${escapeHtml(event.description || '')}">
                            <div style="font-weight: 600;">${timeStr}</div>
                            <div style="margin-top: 4px;">${escapeHtml(event.title)}</div>
                            ${event.location ? `<div style="margin-top: 2px; opacity: 0.9;">üìç ${escapeHtml(event.location)}</div>` : ''}
                        </div>
                    `;
                });

                html += `</div>`;
            });

            html += `</div>`;

            container.innerHTML = html;
        }

        async function loadCalendarEvents() {
            const container = document.getElementById('calendarEventsList');
            if (!container) return;

            try {
                const response = await fetch('/api/calendar/events', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const events = await response.json();
                    renderCalendarEvents(events);
                } else {
                    container.innerHTML = '<div class="empty-state"><h3>No calendar events</h3><p>Create an event to get started</p></div>';
                }
            } catch (error) {
                container.innerHTML = '<div class="empty-state"><h3>No calendar events</h3><p>Create an event to get started</p></div>';
            }
        }

        function renderCalendarEvents(events) {
            const container = document.getElementById('calendarEventsList');
            if (events.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>No calendar events</h3></div>';
                return;
            }

            container.innerHTML = events.map(event => {
                const startDate = new Date(event.start_time);
                const endDate = new Date(event.end_time);
                return `
                <div class="conversation" style="padding: 16px; background: white; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; margin-bottom: 4px;">${escapeHtml(event.title)}</div>
                            ${event.description ? `<div style="color: #65676b; font-size: 14px; margin-bottom: 8px;">${escapeHtml(event.description)}</div>` : ''}
                            <div style="font-size: 13px; color: #8a8d91;">
                                <span>üìÖ ${startDate.toLocaleString()}</span>
                                ${event.location ? ` ‚Ä¢ üìç ${escapeHtml(event.location)}` : ''}
                            </div>
                        </div>
                        <div style="display: flex; gap: 4px;">
                            <button class="icon-btn" onclick="editCalendarEvent('${event.id}')" title="Edit">‚úèÔ∏è</button>
                            <button class="icon-btn" onclick="deleteCalendarEvent('${event.id}')" title="Delete">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>
            `;
            }).join('');
        }

        function createCalendarEvent() {
            const modal = document.createElement('div');
            modal.id = 'calendarModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 24px; max-width: 500px; width: 90%;">
                    <h2 style="margin: 0 0 20px 0; font-size: 20px;">Create Calendar Event</h2>
                    <div class="form-group">
                        <label>Title</label>
                        <input type="text" id="eventTitle" placeholder="Team Meeting" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px;">
                    </div>
                    <div class="form-group">
                        <label>Description (optional)</label>
                        <textarea id="eventDescription" placeholder="Discuss project updates" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px; resize: vertical;" rows="2"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Location (optional)</label>
                        <input type="text" id="eventLocation" placeholder="Conference Room A" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px;">
                    </div>
                    <div class="form-group">
                        <label>Start Time</label>
                        <input type="datetime-local" id="eventStartTime" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px;">
                    </div>
                    <div class="form-group">
                        <label>End Time</label>
                        <input type="datetime-local" id="eventEndTime" style="width: 100%; padding: 8px; border: 1px solid #dadde1; border-radius: 4px;">
                    </div>
                    <div style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 20px;">
                        <button onclick="closeCalendarModal()" style="padding: 8px 16px; border: 1px solid #dadde1; background: white; border-radius: 6px; cursor: pointer;">Cancel</button>
                        <button onclick="saveCalendarEvent()" class="compose-btn">Create</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Set default times (now and +1 hour)
            const now = new Date();
            const later = new Date(now.getTime() + 60 * 60 * 1000);
            document.getElementById('eventStartTime').value = now.toISOString().slice(0, 16);
            document.getElementById('eventEndTime').value = later.toISOString().slice(0, 16);
        }

        function closeCalendarModal() {
            const modal = document.getElementById('calendarModal');
            if (modal) modal.remove();
        }

        async function saveCalendarEvent() {
            const title = document.getElementById('eventTitle').value.trim();
            const description = document.getElementById('eventDescription').value.trim();
            const location = document.getElementById('eventLocation').value.trim();
            const start_time = document.getElementById('eventStartTime').value;
            const end_time = document.getElementById('eventEndTime').value;

            if (!title) {
                showNotification('Please enter a title', 'error');
                return;
            }
            if (!start_time || !end_time) {
                showNotification('Please enter start and end times', 'error');
                return;
            }

            try {
                const response = await fetch('/api/calendar/events', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title,
                        description: description || null,
                        location: location || null,
                        start_time: new Date(start_time).toISOString(),
                        end_time: new Date(end_time).toISOString(),
                        all_day: false
                    })
                });

                if (response.ok) {
                    showNotification('Event created', 'success');
                    closeCalendarModal();
                    loadCalendarEvents();
                } else {
                    showNotification('Failed to create event', 'error');
                }
            } catch (error) {
                showNotification('Failed to create event', 'error');
            }
        }

        function editCalendarEvent(id) {
            showNotification('Calendar event editing coming soon!', 'info');
        }

        async function deleteCalendarEvent(id) {
            if (!confirm('Delete this event?')) return;
            try {
                await fetch(`/api/calendar/events/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                showNotification('Event deleted', 'success');
                loadCalendarEvents();
            } catch (error) {
                showNotification('Failed to delete event', 'error');
            }
        }

        // ===== MONEY VIEW =====
        function showMoneyView(event) {
            hideAllViews();
            let moneyView = document.getElementById('moneyView');
            if (!moneyView) {
                moneyView = createMoneyView();
                document.getElementById('dynamicViewsContainer').appendChild(moneyView);
            }
            moneyView.style.display = 'block';
            if (event) updateSidebarActive(event);
            loadMoneyAccounts();
        }

        function createMoneyView() {
            const view = document.createElement('div');
            view.id = 'moneyView';
            view.style.display = 'none';
            view.className = 'tab-view';
            view.innerHTML = `
                <div class="tab-view-header">
                    <h1 class="tab-view-title">üí∞ Money</h1>
                    <button class="compose-btn" onclick="addMoneyAccount()">+ Add Account</button>
                </div>
                <div id="moneyTotalBalance" style="background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                    <div style="font-size: 14px; color: #65676b; margin-bottom: 4px;">Total Balance</div>
                    <div style="font-size: 32px; font-weight: 600;">$0.00</div>
                </div>
                <div id="moneyAccountsList" class="tab-view-content">
                    <div class="loading">Loading accounts...</div>
                </div>
            `;
            return view;
        }

        async function loadMoneyAccounts() {
            const container = document.getElementById('moneyAccountsList');
            const balanceContainer = document.getElementById('moneyTotalBalance');
            if (!container) return;

            try {
                const response = await fetch('/api/money/accounts', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    renderMoneyAccounts(data.accounts);
                    if (balanceContainer) {
                        balanceContainer.innerHTML = `
                            <div style="font-size: 14px; color: #65676b; margin-bottom: 4px;">Total Balance</div>
                            <div style="font-size: 32px; font-weight: 600;">$${data.total_balance.toFixed(2)}</div>
                        `;
                    }
                } else {
                    container.innerHTML = '<div class="empty-state"><h3>No accounts</h3><p>Add an account to track your finances</p></div>';
                }
            } catch (error) {
                container.innerHTML = '<div class="empty-state"><h3>No accounts</h3><p>Add an account to track your finances</p></div>';
            }
        }

        function renderMoneyAccounts(accounts) {
            const container = document.getElementById('moneyAccountsList');
            if (accounts.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>No accounts</h3></div>';
                return;
            }

            container.innerHTML = accounts.map(account => `
                <div class="tab-card">
                    <div class="tab-card-header">
                        <div>
                            <div style="font-weight: 600; margin-bottom: 4px;">${escapeHtml(account.account_name)}</div>
                            <div style="font-size: 13px; color: #8a8d91;">${escapeHtml(account.account_type)}</div>
                        </div>
                        <div style="font-size: 20px; font-weight: 600;">$${account.balance.toFixed(2)}</div>
                    </div>
                </div>
            `).join('');
        }

        function addMoneyAccount() {
            showNotification('Account creation coming soon!', 'info');
        }

        // ===== HELPER FUNCTIONS =====
        function hideAllViews() {
            document.getElementById('conversationList').style.display = 'none';
            document.getElementById('galleryContainer').style.display = 'none';
            document.getElementById('dynamicViewsContainer').style.display = 'block';
            ['chatView', 'chatInterface', 'automationsView', 'remindersView', 'calendarView', 'moneyView', 'settingsView'].forEach(id => {
                const view = document.getElementById(id);
                if (view) view.style.display = 'none';
            });
        }

        function updateSidebarActive(event) {
            if (event && event.target) {
                document.querySelectorAll('.folder-item').forEach(f => f.classList.remove('active'));
                event.target.closest('.folder-item').classList.add('active');
            }
        }

        async function loadGalleryRecents() {
            const container = document.getElementById('recentsView');
            container.innerHTML = '<div class="loading">Loading attachments...</div>';

            try {
                console.log('Loading gallery recents for user');
                const response = await fetch('/api/attachments/gallery/recents?limit=50', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('Gallery response:', data);
                    // Handle both array and object responses
                    if (Array.isArray(data)) {
                        attachments = data;
                    } else if (data.attachments) {
                        attachments = data.attachments;
                    } else {
                        attachments = [];
                    }
                    console.log('Loaded attachments:', attachments.length);
                } else {
                    console.log('Failed to load attachments, using mock data');
                    attachments = getMockAttachments();
                }
            } catch (error) {
                console.error('Error loading attachments:', error);
                attachments = getMockAttachments();
            }

            filteredAttachments = attachments;

            if (attachments.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>No attachments found</h3><p>Attachments from your emails will appear here once they are downloaded and processed.</p></div>';
                return;
            }

            renderGalleryView();
        }

        async function loadGalleryBySender() {
            const container = document.getElementById('senderView');
            container.innerHTML = '<div class="loading">Loading attachments...</div>';

            try {
                const response = await fetch('/api/attachments/gallery/by-sender', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const senderData = await response.json();
                    renderSenderView(senderData);
                } else {
                    renderSenderView(getMockSenderData());
                }
            } catch (error) {
                console.log('Using mock sender data');
                renderSenderView(getMockSenderData());
            }
        }

        function switchGalleryView(mode) {
            currentView = mode;

            // Update button states
            document.querySelectorAll('.view-mode-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.mode === mode) {
                    btn.classList.add('active');
                }
            });

            // Hide all views
            document.getElementById('recentsView').style.display = 'none';
            document.getElementById('senderView').style.display = 'none';
            document.getElementById('listView').style.display = 'none';

            // Show selected view
            if (mode === 'recents') {
                document.getElementById('recentsView').style.display = 'grid';
                renderGalleryView();
            } else if (mode === 'sender') {
                document.getElementById('senderView').style.display = 'block';
                loadGalleryBySender();
            } else if (mode === 'list') {
                document.getElementById('listView').style.display = 'block';
                renderListView();
            }
        }

        function renderGalleryView() {
            const container = document.getElementById('recentsView');

            if (filteredAttachments.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>No attachments found</h3><p>Attachments from your emails will appear here</p></div>';
                return;
            }

            container.innerHTML = '';

            // Pagination
            const start = (currentPage - 1) * pageSize;
            const end = start + pageSize;
            const pageAttachments = filteredAttachments.slice(start, end);

            pageAttachments.forEach(attachment => {
                const card = createAttachmentCard(attachment);
                container.appendChild(card);
            });

            updatePagination();
        }

        function createAttachmentCard(attachment) {
            const card = document.createElement('div');
            card.className = 'attachment-card';

            const thumbnail = getThumbnailContent(attachment);

            card.innerHTML = `
                <div class="attachment-thumbnail">
                    ${thumbnail}
                </div>
                <div class="attachment-info">
                    <div class="attachment-filename" title="${escapeHtml(attachment.filename)}">
                        ${escapeHtml(attachment.filename)}
                    </div>
                    <div class="attachment-meta">
                        <span>${formatFileSize(attachment.size)}</span>
                        <span>${formatDate(attachment.received_at || attachment.created_at)}</span>
                    </div>
                </div>
            `;

            card.addEventListener('click', () => previewAttachment(attachment));

            return card;
        }

        function getThumbnailContent(attachment) {
            const contentType = attachment.content_type || '';

            if (contentType.startsWith('image/')) {
                // Check if thumbnail exists
                if (attachment.preview_generated) {
                    return `<img src="/api/attachments/${attachment.id}/thumbnail" alt="${escapeHtml(attachment.filename)}" onerror="this.parentElement.innerHTML='üñºÔ∏è'">`;
                }
                return 'üñºÔ∏è';
            } else if (contentType === 'application/pdf') {
                return 'üìÑ';
            } else if (contentType.includes('word') || contentType.includes('document')) {
                return 'üìù';
            } else if (contentType.includes('sheet') || contentType.includes('excel')) {
                return 'üìä';
            } else if (contentType.includes('presentation') || contentType.includes('powerpoint')) {
                return 'üìΩÔ∏è';
            } else if (contentType.includes('zip') || contentType.includes('archive') || contentType.includes('compressed')) {
                return 'üì¶';
            } else if (contentType.includes('video')) {
                return 'üé•';
            } else if (contentType.includes('audio')) {
                return 'üéµ';
            } else {
                return 'üìé';
            }
        }

        function renderSenderView(senderData) {
            const container = document.getElementById('senderView');

            if (!senderData || senderData.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>No attachments found</h3></div>';
                return;
            }

            container.innerHTML = '';

            senderData.forEach(sender => {
                const group = document.createElement('div');
                group.className = 'sender-group';

                const initial = (sender.sender_name || sender.sender_email || '?')[0].toUpperCase();

                group.innerHTML = `
                    <div class="sender-header">
                        <div class="sender-info">
                            <div class="sender-avatar">${initial}</div>
                            <div class="sender-details">
                                <h3>${escapeHtml(sender.sender_name || sender.sender_email)}</h3>
                                <p>${escapeHtml(sender.sender_email)}</p>
                            </div>
                        </div>
                        <div class="sender-count">${sender.attachment_count} files</div>
                    </div>
                    <div class="sender-attachments" id="sender-${sender.sender_email.replace(/[^a-z0-9]/gi, '')}">
                        <div class="loading">Loading...</div>
                    </div>
                `;

                group.querySelector('.sender-header').addEventListener('click', () => {
                    toggleSenderGroup(group, sender.sender_email);
                });

                container.appendChild(group);
            });
        }

        async function toggleSenderGroup(groupElement, senderEmail) {
            const isExpanded = groupElement.classList.contains('expanded');

            if (isExpanded) {
                groupElement.classList.remove('expanded');
                return;
            }

            groupElement.classList.add('expanded');

            const attachmentsContainer = groupElement.querySelector('.sender-attachments');

            // Load attachments for this sender
            try {
                const response = await fetch(`/api/attachments/gallery?sender=${encodeURIComponent(senderEmail)}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                let senderAttachments;
                if (response.ok) {
                    const data = await response.json();
                    senderAttachments = data.attachments || data;
                } else {
                    senderAttachments = attachments.filter(a => a.sender_email === senderEmail);
                }

                renderSenderAttachments(attachmentsContainer, senderAttachments);
            } catch (error) {
                const senderAttachments = attachments.filter(a => a.sender_email === senderEmail);
                renderSenderAttachments(attachmentsContainer, senderAttachments);
            }
        }

        function renderSenderAttachments(container, attachments) {
            if (attachments.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No attachments</p></div>';
                return;
            }

            container.innerHTML = '';

            attachments.forEach(attachment => {
                const item = document.createElement('div');
                item.className = 'attachment-list-item';

                const icon = getThumbnailContent(attachment);
                const hasImage = attachment.content_type?.startsWith('image/') && attachment.preview_generated;

                item.innerHTML = `
                    <div class="attachment-icon">
                        ${hasImage ? `<img src="/api/attachments/${attachment.id}/thumbnail" alt="${escapeHtml(attachment.filename)}">` : icon}
                    </div>
                    <div class="attachment-details">
                        <h4>${escapeHtml(attachment.filename)}</h4>
                        <p>${formatFileSize(attachment.size)} ‚Ä¢ ${formatDate(attachment.received_at || attachment.created_at)}</p>
                    </div>
                `;

                item.addEventListener('click', () => previewAttachment(attachment));

                container.appendChild(item);
            });
        }

        function renderListView() {
            const container = document.getElementById('listView');

            if (filteredAttachments.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>No attachments found</h3></div>';
                return;
            }

            container.innerHTML = '';

            // Create table
            const table = document.createElement('div');
            table.style.background = 'white';
            table.style.borderRadius = '8px';
            table.style.overflow = 'hidden';

            const start = (currentPage - 1) * pageSize;
            const end = start + pageSize;
            const pageAttachments = filteredAttachments.slice(start, end);

            pageAttachments.forEach(attachment => {
                const row = document.createElement('div');
                row.className = 'attachment-list-item';
                row.style.margin = '0';
                row.style.borderRadius = '0';
                row.style.borderBottom = '1px solid #e4e6eb';

                const icon = getThumbnailContent(attachment);

                row.innerHTML = `
                    <div class="attachment-icon">
                        ${icon}
                    </div>
                    <div class="attachment-details" style="flex: 2;">
                        <h4>${escapeHtml(attachment.filename)}</h4>
                    </div>
                    <div style="flex: 1; font-size: 13px; color: #65676b;">
                        ${escapeHtml(attachment.sender_name || attachment.sender_email || 'Unknown')}
                    </div>
                    <div style="flex: 1; font-size: 13px; color: #65676b;">
                        ${formatDate(attachment.received_at || attachment.created_at)}
                    </div>
                    <div style="flex: 0.5; font-size: 13px; color: #65676b; text-align: right;">
                        ${formatFileSize(attachment.size)}
                    </div>
                `;

                row.addEventListener('click', () => previewAttachment(attachment));

                table.appendChild(row);
            });

            container.appendChild(table);
            updatePagination();
        }

        function searchAttachments() {
            const query = document.getElementById('gallerySearchInput').value.toLowerCase();

            if (!query) {
                filteredAttachments = attachments;
            } else {
                filteredAttachments = attachments.filter(att =>
                    att.filename.toLowerCase().includes(query) ||
                    (att.sender_name && att.sender_name.toLowerCase().includes(query)) ||
                    (att.sender_email && att.sender_email.toLowerCase().includes(query))
                );
            }

            currentPage = 1;
            applyFilters();
        }

        function applyFilters() {
            const dateFilter = document.getElementById('filterDate').value;
            const typeFilter = document.getElementById('filterType').value;
            const sizeFilter = document.getElementById('filterSize').value;

            let filtered = filteredAttachments;

            // Date filter
            if (dateFilter) {
                const now = new Date();
                filtered = filtered.filter(att => {
                    const attDate = new Date(att.received_at || att.created_at);
                    const diffDays = Math.floor((now - attDate) / (1000 * 60 * 60 * 24));

                    if (dateFilter === 'today') return diffDays === 0;
                    if (dateFilter === 'week') return diffDays <= 7;
                    if (dateFilter === 'month') return diffDays <= 30;
                    return true;
                });
            }

            // Type filter
            if (typeFilter) {
                filtered = filtered.filter(att => {
                    const contentType = att.content_type || '';

                    if (typeFilter === 'image') return contentType.startsWith('image/');
                    if (typeFilter === 'pdf') return contentType === 'application/pdf';
                    if (typeFilter === 'document') return contentType.includes('word') || contentType.includes('document');
                    if (typeFilter === 'spreadsheet') return contentType.includes('sheet') || contentType.includes('excel');
                    if (typeFilter === 'archive') return contentType.includes('zip') || contentType.includes('archive');
                    return true;
                });
            }

            // Size filter
            if (sizeFilter) {
                filtered = filtered.filter(att => {
                    const sizeMB = att.size / (1024 * 1024);

                    if (sizeFilter === 'small') return sizeMB < 1;
                    if (sizeFilter === 'medium') return sizeMB >= 1 && sizeMB <= 10;
                    if (sizeFilter === 'large') return sizeMB > 10;
                    return true;
                });
            }

            filteredAttachments = filtered;
            currentPage = 1;

            if (currentView === 'recents') {
                renderGalleryView();
            } else if (currentView === 'list') {
                renderListView();
            }
        }

        function previewAttachment(attachment) {
            const modal = document.getElementById('previewModal');
            const content = modal.querySelector('.preview-content');

            const contentType = attachment.content_type || '';
            const isImage = contentType.startsWith('image/');
            const isPDF = contentType === 'application/pdf';

            let previewBody = '';
            if (isImage) {
                previewBody = `<img src="/api/attachments/${attachment.id}" alt="${escapeHtml(attachment.filename)}">`;
            } else if (isPDF) {
                previewBody = `<iframe src="/api/attachments/${attachment.id}" style="width: 100%; height: 500px; border: none;"></iframe>`;
            } else {
                previewBody = `<div style="text-align: center; padding: 40px;"><div style="font-size: 64px; margin-bottom: 16px;">${getThumbnailContent(attachment)}</div><p>Preview not available for this file type</p></div>`;
            }

            content.innerHTML = `
                <div class="preview-header">
                    <h3>${escapeHtml(attachment.filename)}</h3>
                    <div class="preview-actions">
                        <button class="btn-secondary" onclick="downloadAttachment('${attachment.id}', '${escapeHtml(attachment.filename)}')">Download</button>
                        <button class="btn-secondary" onclick="deleteAttachment('${attachment.id}')">Delete</button>
                        <button class="close-btn" onclick="closePreview()">√ó</button>
                    </div>
                </div>
                <div class="preview-body">
                    ${previewBody}
                </div>
                <div class="preview-metadata">
                    <div class="metadata-row">
                        <span class="metadata-label">From:</span>
                        <span class="metadata-value">${escapeHtml(attachment.sender_name || attachment.sender_email || 'Unknown')}</span>
                    </div>
                    <div class="metadata-row">
                        <span class="metadata-label">Date:</span>
                        <span class="metadata-value">${formatDate(attachment.received_at || attachment.created_at)}</span>
                    </div>
                    <div class="metadata-row">
                        <span class="metadata-label">Size:</span>
                        <span class="metadata-value">${formatFileSize(attachment.size)}</span>
                    </div>
                    <div class="metadata-row">
                        <span class="metadata-label">Type:</span>
                        <span class="metadata-value">${escapeHtml(attachment.content_type || 'Unknown')}</span>
                    </div>
                </div>
            `;

            modal.classList.add('active');
        }

        function closePreview() {
            document.getElementById('previewModal').classList.remove('active');
        }

        async function downloadAttachment(attachmentId, filename) {
            try {
                const response = await fetch(`/api/attachments/${attachmentId}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    showNotification('Download started', 'success');
                } else {
                    throw new Error('Download failed');
                }
            } catch (error) {
                showNotification('Download failed (demo mode)', 'info');
            }
        }

        async function deleteAttachment(attachmentId) {
            if (!confirm('Are you sure you want to delete this attachment?')) return;

            try {
                const response = await fetch(`/api/attachments/${attachmentId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    showNotification('Attachment deleted', 'success');
                    closePreview();

                    // Remove from local state
                    attachments = attachments.filter(a => a.id !== attachmentId);
                    filteredAttachments = filteredAttachments.filter(a => a.id !== attachmentId);

                    // Re-render current view
                    if (currentView === 'recents') {
                        renderGalleryView();
                    } else if (currentView === 'list') {
                        renderListView();
                    } else if (currentView === 'sender') {
                        loadGalleryBySender();
                    }
                } else {
                    throw new Error('Delete failed');
                }
            } catch (error) {
                showNotification('Delete failed (demo mode)', 'info');
                closePreview();
            }
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
            return (bytes / (1024 * 1024 * 1024)).toFixed(1) + ' GB';
        }

        function updatePagination() {
            const pagination = document.getElementById('galleryPagination');
            const totalPages = Math.ceil(filteredAttachments.length / pageSize);

            if (totalPages <= 1) {
                pagination.style.display = 'none';
                return;
            }

            pagination.style.display = 'flex';
            document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;

            const prevBtn = pagination.querySelector('button:first-child');
            const nextBtn = pagination.querySelector('button:last-child');

            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages;
        }

        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                if (currentView === 'recents') {
                    renderGalleryView();
                } else if (currentView === 'list') {
                    renderListView();
                }
            }
        }

        function nextPage() {
            const totalPages = Math.ceil(filteredAttachments.length / pageSize);
            if (currentPage < totalPages) {
                currentPage++;
                if (currentView === 'recents') {
                    renderGalleryView();
                } else if (currentView === 'list') {
                    renderListView();
                }
            }
        }

        // Close preview modal when clicking outside
        document.getElementById('previewModal')?.addEventListener('click', (e) => {
            if (e.target.id === 'previewModal') {
                closePreview();
            }
        });

        // Mock data for attachments
        function getMockAttachments() {
            return [
                {
                    id: 'att1',
                    filename: 'project-proposal.pdf',
                    content_type: 'application/pdf',
                    size: 2457600,
                    sender_email: 'john@example.com',
                    sender_name: 'John Doe',
                    received_at: new Date(Date.now() - 3600000).toISOString(),
                    preview_generated: false
                },
                {
                    id: 'att2',
                    filename: 'vacation-photo.jpg',
                    content_type: 'image/jpeg',
                    size: 1536000,
                    sender_email: 'jane@example.com',
                    sender_name: 'Jane Smith',
                    received_at: new Date(Date.now() - 7200000).toISOString(),
                    preview_generated: true
                },
                {
                    id: 'att3',
                    filename: 'quarterly-report.xlsx',
                    content_type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                    size: 524288,
                    sender_email: 'finance@example.com',
                    sender_name: 'Finance Team',
                    received_at: new Date(Date.now() - 86400000).toISOString(),
                    preview_generated: false
                },
                {
                    id: 'att4',
                    filename: 'meeting-notes.docx',
                    content_type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                    size: 102400,
                    sender_email: 'john@example.com',
                    sender_name: 'John Doe',
                    received_at: new Date(Date.now() - 172800000).toISOString(),
                    preview_generated: false
                },
                {
                    id: 'att5',
                    filename: 'presentation.pptx',
                    content_type: 'application/vnd.openxmlformats-officedocument.presentationml.presentation',
                    size: 5242880,
                    sender_email: 'jane@example.com',
                    sender_name: 'Jane Smith',
                    received_at: new Date(Date.now() - 259200000).toISOString(),
                    preview_generated: false
                }
            ];
        }

        function getMockSenderData() {
            return [
                {
                    sender_email: 'john@example.com',
                    sender_name: 'John Doe',
                    attachment_count: 2
                },
                {
                    sender_email: 'jane@example.com',
                    sender_name: 'Jane Smith',
                    attachment_count: 2
                },
                {
                    sender_email: 'finance@example.com',
                    sender_name: 'Finance Team',
                    attachment_count: 1
                }
            ];
        }

        // Debug Modal Functions
        async function openDebugModal() {
            document.getElementById('debugModal').classList.add('active');
            await loadDebugInfo();
        }

        function closeDebugModal() {
            document.getElementById('debugModal').classList.remove('active');
        }

        async function loadDebugInfo() {
            const debugContent = document.getElementById('debugContent');
            try {
                const response = await fetch('http://localhost:8080/api/debug/sync', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load debug info');
                }

                const data = await response.json();

                debugContent.innerHTML = `
                    <div style="font-family: monospace; font-size: 14px;">
                        <h3>User Information</h3>
                        <table style="width: 100%; border-collapse: collapse;">
                            <tr><td style="padding: 8px; border: 1px solid #ddd;"><strong>User ID:</strong></td><td style="padding: 8px; border: 1px solid #ddd;">${data.user_id}</td></tr>
                            <tr><td style="padding: 8px; border: 1px solid #ddd;"><strong>Email:</strong></td><td style="padding: 8px; border: 1px solid #ddd;">${data.email}</td></tr>
                            <tr><td style="padding: 8px; border: 1px solid #ddd;"><strong>OAuth Provider:</strong></td><td style="padding: 8px; border: 1px solid #ddd;">${data.oauth_provider || 'None'}</td></tr>
                        </table>

                        <h3 style="margin-top: 20px;">Service Status</h3>
                        <table style="width: 100%; border-collapse: collapse;">
                            <tr><td style="padding: 8px; border: 1px solid #ddd;"><strong>Services Initialized:</strong></td><td style="padding: 8px; border: 1px solid #ddd;">${data.is_initialized ? '‚úÖ Yes' : '‚ùå No'}</td></tr>
                            <tr><td style="padding: 8px; border: 1px solid #ddd;"><strong>IMAP Service:</strong></td><td style="padding: 8px; border: 1px solid #ddd;">${data.has_imap_service ? '‚úÖ Active' : '‚ùå Inactive'}</td></tr>
                            <tr><td style="padding: 8px; border: 1px solid #ddd;"><strong>SMTP Service:</strong></td><td style="padding: 8px; border: 1px solid #ddd;">${data.has_smtp_service ? '‚úÖ Active' : '‚ùå Inactive'}</td></tr>
                            <tr><td style="padding: 8px; border: 1px solid #ddd;"><strong>OAuth Tokens:</strong></td><td style="padding: 8px; border: 1px solid #ddd;">${data.has_oauth_tokens ? '‚úÖ Present' : '‚ùå Missing'}</td></tr>
                        </table>

                        <h3 style="margin-top: 20px;">Server Configuration</h3>
                        <table style="width: 100%; border-collapse: collapse;">
                            <tr><td style="padding: 8px; border: 1px solid #ddd;"><strong>IMAP Host:</strong></td><td style="padding: 8px; border: 1px solid #ddd;">${data.imap_host}:${data.imap_port}</td></tr>
                            <tr><td style="padding: 8px; border: 1px solid #ddd;"><strong>SMTP Host:</strong></td><td style="padding: 8px; border: 1px solid #ddd;">${data.smtp_host}:${data.smtp_port}</td></tr>
                        </table>

                        <h3 style="margin-top: 20px;">Email Statistics</h3>
                        <table style="width: 100%; border-collapse: collapse;">
                            <tr><td style="padding: 8px; border: 1px solid #ddd;"><strong>Total Emails:</strong></td><td style="padding: 8px; border: 1px solid #ddd;">${data.total_emails}</td></tr>
                        </table>

                        ${data.emails_by_folder.length > 0 ? `
                            <h4 style="margin-top: 10px;">Emails by Folder:</h4>
                            <table style="width: 100%; border-collapse: collapse;">
                                ${data.emails_by_folder.map(f => `
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;">${formatFolderName(f.folder)}</td><td style="padding: 8px; border: 1px solid #ddd;">${f.count}</td></tr>
                                `).join('')}
                            </table>
                        ` : '<p style="color: #999; margin-top: 10px;">No emails found in database</p>'}

                        <h3 style="margin-top: 20px;">üìÖ Calendar Sync Status</h3>
                        <table style="width: 100%; border-collapse: collapse;">
                            <tr><td style="padding: 8px; border: 1px solid #ddd;"><strong>Total Events:</strong></td><td style="padding: 8px; border: 1px solid #ddd;">${data.calendar_sync_status.total_events}</td></tr>
                            <tr><td style="padding: 8px; border: 1px solid #ddd;"><strong>Events This Month:</strong></td><td style="padding: 8px; border: 1px solid #ddd;">${data.calendar_sync_status.events_this_month}</td></tr>
                            <tr><td style="padding: 8px; border: 1px solid #ddd;"><strong>Events Next Month:</strong></td><td style="padding: 8px; border: 1px solid #ddd;">${data.calendar_sync_status.events_next_month}</td></tr>
                            <tr><td style="padding: 8px; border: 1px solid #ddd;"><strong>CalDAV Configured:</strong></td><td style="padding: 8px; border: 1px solid #ddd;">${data.calendar_sync_status.caldav_configured ? '‚úÖ Yes' : '‚ùå No'}</td></tr>
                            <tr><td style="padding: 8px; border: 1px solid #ddd;"><strong>CalDAV URL:</strong></td><td style="padding: 8px; border: 1px solid #ddd;">${data.calendar_sync_status.caldav_url || 'Not configured'}</td></tr>
                            <tr><td style="padding: 8px; border: 1px solid #ddd;"><strong>Sync Enabled:</strong></td><td style="padding: 8px; border: 1px solid #ddd;">${data.calendar_sync_status.sync_enabled ? '‚úÖ Enabled' : '‚ùå Disabled'}</td></tr>
                            <tr><td style="padding: 8px; border: 1px solid #ddd;"><strong>Last Sync:</strong></td><td style="padding: 8px; border: 1px solid #ddd;">${data.calendar_sync_status.last_sync || 'Never'}</td></tr>
                            <tr><td style="padding: 8px; border: 1px solid #ddd;"><strong>Pending Sync:</strong></td><td style="padding: 8px; border: 1px solid #ddd;">${data.calendar_sync_status.pending_sync}</td></tr>
                        </table>

                        ${data.calendar_sync_status.calendars.length > 0 ? `
                            <h4 style="margin-top: 10px;">Events by Calendar:</h4>
                            <table style="width: 100%; border-collapse: collapse;">
                                ${data.calendar_sync_status.calendars.map(c => `
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;">${c.calendar_id}</td><td style="padding: 8px; border: 1px solid #ddd;">${c.event_count}</td></tr>
                                `).join('')}
                            </table>
                        ` : ''}

                        ${data.calendar_sync_status.sync_errors.length > 0 ? `
                            <h4 style="margin-top: 10px; color: #d32f2f;">Sync Errors:</h4>
                            <ul style="color: #d32f2f;">
                                ${data.calendar_sync_status.sync_errors.map(e => `<li>${e}</li>`).join('')}
                            </ul>
                        ` : ''}
                    </div>
                `;
            } catch (error) {
                console.error('Failed to load debug info:', error);
                debugContent.innerHTML = `
                    <div style="color: #d32f2f; padding: 20px; text-align: center;">
                        <p><strong>Error loading debug information</strong></p>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        async function testImapConnection() {
            const debugContent = document.getElementById('debugContent');
            const originalContent = debugContent.innerHTML;

            debugContent.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="spinner"></div><p>Testing IMAP connection...</p></div>';

            try {
                const response = await fetch('http://localhost:8080/api/debug/test-imap', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                    }
                });

                const data = await response.json();

                debugContent.innerHTML = originalContent + `
                    <div style="margin-top: 20px; padding: 15px; border-radius: 8px; background: ${data.success ? '#e8f5e9' : '#ffebee'};">
                        <h3 style="color: ${data.success ? '#2e7d32' : '#c62828'};">IMAP Connection Test</h3>
                        <p><strong>Status:</strong> ${data.success ? '‚úÖ Success' : '‚ùå Failed'}</p>
                        <p><strong>Message:</strong> ${data.message}</p>
                        ${data.folders ? `
                            <p><strong>Available Folders:</strong></p>
                            <ul>
                                ${data.folders.map(f => `<li>${formatFolderName(f)}</li>`).join('')}
                            </ul>
                        ` : ''}
                        ${data.error ? `<p style="color: #c62828;"><strong>Error:</strong> ${data.error}</p>` : ''}
                    </div>
                `;
            } catch (error) {
                debugContent.innerHTML = originalContent + `
                    <div style="margin-top: 20px; padding: 15px; border-radius: 8px; background: #ffebee;">
                        <h3 style="color: #c62828;">IMAP Connection Test Failed</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        async function triggerManualSync() {
            const debugContent = document.getElementById('debugContent');
            const originalContent = debugContent.innerHTML;

            debugContent.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="spinner"></div><p>Syncing emails...</p></div>';

            try {
                const response = await fetch('http://localhost:8080/api/debug/manual-sync', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                    }
                });

                const data = await response.json();

                debugContent.innerHTML = originalContent + `
                    <div style="margin-top: 20px; padding: 15px; border-radius: 8px; background: ${data.success ? '#e8f5e9' : '#ffebee'};">
                        <h3 style="color: ${data.success ? '#2e7d32' : '#c62828'};">Manual Sync Result</h3>
                        <p><strong>Status:</strong> ${data.success ? '‚úÖ Success' : '‚ùå Failed'}</p>
                        ${data.synced_counts ? `
                            <p><strong>Synced Emails:</strong></p>
                            <ul>
                                ${Object.entries(data.synced_counts).map(([folder, count]) => `<li>${formatFolderName(folder)}: ${count} emails</li>`).join('')}
                            </ul>
                        ` : ''}
                        ${data.errors && data.errors.length > 0 ? `
                            <p style="color: #c62828;"><strong>Errors:</strong></p>
                            <ul style="color: #c62828;">
                                ${data.errors.map(err => `<li>${err}</li>`).join('')}
                            </ul>
                        ` : ''}
                    </div>
                `;

                // Reload conversations after sync
                if (data.success) {
                    setTimeout(() => {
                        loadConversations(currentFolder);
                    }, 1000);
                }
            } catch (error) {
                debugContent.innerHTML = originalContent + `
                    <div style="margin-top: 20px; padding: 15px; border-radius: 8px; background: #ffebee;">
                        <h3 style="color: #c62828;">Manual Sync Failed</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        async function testCalDavConnection() {
            const debugContent = document.getElementById('debugContent');
            const originalContent = debugContent.innerHTML;

            debugContent.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="spinner"></div><p>Testing CalDAV connection...</p></div>';

            try {
                const response = await fetch('http://localhost:8080/api/debug/test-caldav', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to test CalDAV connection');
                }

                const data = await response.json();

                debugContent.innerHTML = originalContent + `
                    <div style="margin-top: 20px; padding: 15px; border-radius: 8px; background: ${data.success ? '#e8f5e9' : '#ffebee'};">
                        <h3 style="color: ${data.success ? '#2e7d32' : '#c62828'};">üìÖ CalDAV Connection Test</h3>
                        <p><strong>Status:</strong> ${data.success ? '‚úÖ Success' : '‚ùå Failed'}</p>
                        <p><strong>Message:</strong> ${data.message}</p>
                        ${data.event_count !== null && data.event_count !== undefined ? `
                            <p><strong>Events Found:</strong> ${data.event_count}</p>
                        ` : ''}
                        ${data.error ? `
                            <p style="color: #c62828;"><strong>Error:</strong> ${data.error}</p>
                        ` : ''}
                    </div>
                `;
            } catch (error) {
                console.error('Failed to test CalDAV connection:', error);
                debugContent.innerHTML = originalContent + `
                    <div style="margin-top: 20px; padding: 15px; border-radius: 8px; background: #ffebee;">
                        <h3 style="color: #c62828;">üìÖ CalDAV Connection Test Failed</h3>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <p style="margin-top: 10px; font-size: 12px; color: #666;">
                            Make sure CalDAV is configured in your .env file:
                            <br>CALDAV_URL, CALDAV_USERNAME, CALDAV_PASSWORD
                        </p>
                    </div>
                `;
            }
        }
    </script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
      lucide.createIcons();
    </script>
</body>
</html>
