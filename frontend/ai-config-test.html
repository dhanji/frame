<!DOCTYPE html>
<html>
<head>
    <title>AI Configuration Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .section {
            background: #f5f5f5;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        input, select, button {
            padding: 10px;
            margin: 5px 0;
            width: 100%;
            box-sizing: border-box;
        }
        button {
            background: #0066FF;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
        }
        button:hover {
            background: #0052CC;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success {
            background: #d4edda;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
        }
        label {
            display: block;
            margin-top: 10px;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <h1>ü§ñ AI Configuration Test</h1>
    
    <div class="section">
        <h2>Step 1: Login</h2>
        <label>Email:</label>
        <input type="email" id="email" placeholder="your@email.com">
        <label>Password:</label>
        <input type="password" id="password" placeholder="Your password">
        <button onclick="login()">Login</button>
        <div id="loginStatus"></div>
    </div>

    <div class="section">
        <h2>Step 2: Check Current AI Configuration</h2>
        <button onclick="checkConfig()">Check Configuration</button>
        <div id="configStatus"></div>
    </div>

    <div class="section">
        <h2>Step 3: Update AI Settings</h2>
        <label>AI Provider:</label>
        <select id="aiProvider">
            <option value="anthropic">Anthropic (Claude)</option>
            <option value="openai">OpenAI (GPT)</option>
        </select>
        <label>API Key:</label>
        <input type="password" id="apiKey" placeholder="sk-ant-... or sk-...">
        <label>Model:</label>
        <input type="text" id="model" value="claude-3-5-sonnet-20241022" placeholder="claude-3-5-sonnet-20241022">
        <button onclick="updateSettings()">Save AI Settings</button>
        <div id="updateStatus"></div>
    </div>

    <div class="section">
        <h2>Step 4: Test AI Chat</h2>
        <label>Test Message:</label>
        <input type="text" id="testMessage" value="Hello! Can you help me?" placeholder="Type a test message">
        <button onclick="testChat()">Send Test Message</button>
        <div id="chatStatus"></div>
    </div>

    <script>
        let authToken = null;
        let conversationId = null;

        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const status = document.getElementById('loginStatus');

            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email,
                        password,
                        imap_host: 'imap.gmail.com',
                        imap_port: 993,
                        smtp_host: 'smtp.gmail.com',
                        smtp_port: 587
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    authToken = data.token;
                    status.className = 'status success';
                    status.textContent = '‚úÖ Login successful! Token: ' + authToken.substring(0, 20) + '...';
                } else {
                    const error = await response.json();
                    status.className = 'status error';
                    status.textContent = '‚ùå Login failed: ' + (error.error || 'Unknown error');
                }
            } catch (error) {
                status.className = 'status error';
                status.textContent = '‚ùå Error: ' + error.message;
            }
        }

        async function checkConfig() {
            const status = document.getElementById('configStatus');
            if (!authToken) {
                status.className = 'status error';
                status.textContent = '‚ùå Please login first';
                return;
            }

            try {
                const response = await fetch('/api/settings', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const settings = await response.json();
                    status.className = 'status info';
                    status.innerHTML = `
                        <strong>Current Configuration:</strong><br>
                        Provider: ${settings.ai_provider}<br>
                        Model: ${settings.ai_model}<br>
                        API Key: ${settings.ai_api_key ? '‚úÖ Set (***' + settings.ai_api_key.slice(-4) + ')' : '‚ùå Not set'}<br>
                        Context Window: ${settings.ai_context_window}
                    `;
                    
                    // Pre-fill form
                    document.getElementById('aiProvider').value = settings.ai_provider;
                    document.getElementById('model').value = settings.ai_model;
                } else {
                    status.className = 'status error';
                    status.textContent = '‚ùå Failed to fetch settings';
                }
            } catch (error) {
                status.className = 'status error';
                status.textContent = '‚ùå Error: ' + error.message;
            }
        }

        async function updateSettings() {
            const status = document.getElementById('updateStatus');
            if (!authToken) {
                status.className = 'status error';
                status.textContent = '‚ùå Please login first';
                return;
            }

            const provider = document.getElementById('aiProvider').value;
            const apiKey = document.getElementById('apiKey').value;
            const model = document.getElementById('model').value;

            if (!apiKey) {
                status.className = 'status error';
                status.textContent = '‚ùå Please enter an API key';
                return;
            }

            try {
                const response = await fetch('/api/settings', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ai_provider: provider,
                        ai_api_key: apiKey,
                        ai_model: model
                    })
                });

                if (response.ok) {
                    status.className = 'status success';
                    status.textContent = '‚úÖ AI settings saved successfully!';
                } else {
                    const error = await response.json();
                    status.className = 'status error';
                    status.textContent = '‚ùå Failed to save: ' + (error.error || 'Unknown error');
                }
            } catch (error) {
                status.className = 'status error';
                status.textContent = '‚ùå Error: ' + error.message;
            }
        }

        async function testChat() {
            const status = document.getElementById('chatStatus');
            if (!authToken) {
                status.className = 'status error';
                status.textContent = '‚ùå Please login first';
                return;
            }

            const message = document.getElementById('testMessage').value;
            status.className = 'status info';
            status.textContent = '‚è≥ Creating conversation...';

            try {
                // Create conversation
                if (!conversationId) {
                    const convResponse = await fetch('/api/chat/conversations', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ title: 'Test Chat' })
                    });

                    if (!convResponse.ok) {
                        throw new Error('Failed to create conversation');
                    }

                    const convData = await convResponse.json();
                    conversationId = convData.id;
                }

                status.textContent = '‚è≥ Sending message to AI...';

                // Send message
                const msgResponse = await fetch(`/api/chat/conversations/${conversationId}/messages`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ content: message })
                });

                if (msgResponse.ok) {
                    const data = await msgResponse.json();
                    status.className = 'status success';
                    status.innerHTML = `
                        <strong>‚úÖ AI Response:</strong><br>
                        <div style="background: white; padding: 10px; margin-top: 10px; border-radius: 4px;">
                            ${data.assistant_response.replace(/\n/g, '<br>')}
                        </div>
                    `;
                } else {
                    const error = await msgResponse.json();
                    status.className = 'status error';
                    status.textContent = '‚ùå AI Error: ' + (error.error || 'Unknown error');
                }
            } catch (error) {
                status.className = 'status error';
                status.textContent = '‚ùå Error: ' + error.message;
            }
        }
    </script>
</body>
</html>
